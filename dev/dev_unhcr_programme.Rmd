---
title: "IATI Visualisation"
output: html_document
editor_options: 
  chunk_output_type: console
---



```{r developmenttest, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message=FALSE, 
  warning=FALSE,
  fig.width = 8,
  fig.asp = 0.718,
  out.width = "90%"
)
library(testthat) 
library(ggplot2)
library(dplyr)
# Load already included functions
pkgload::load_all(export_all = FALSE)
```


  
```{r function-filter_iati_data}
#' Filter IATI Data by Year and Scope
#' 
#' A helper function designed to subset IATI datasets (such as results or activities) 
#' based on a specific year (or range of years) and exactly one organizational 
#' level: Programme, Country, or Operation ID.
#'
#' @param df A data frame containing IATI data (e.g., `dataResult` or `dataActivity`).
#' @param year A numeric value or a vector of numeric values to filter the 'year' column.
#' @param programmme_lab A character string representing the programme label. 
#'        Note: This matches the triple-'m' spelling found in the underlying data structure.
#' @param ctr_name A character string representing the country name.
#' @param iati_id_ops A character string representing the IATI operation identifier.
#'
#' @importFrom dplyr filter
#' 
#' @return A filtered data frame.
#' 
#' @export
filter_iati_data <- function(df, year, programmme_lab = NULL, ctr_name = NULL, iati_id_ops = NULL) {
  # Input validation: Ensure exactly one of the specific scope filters is provided (if any)
  args_provided <- sum(!is.null(programmme_lab), !is.null(ctr_name), !is.null(iati_id_ops))
  if (args_provided > 1) {
    stop("Please pass only one of: programmme_lab, ctr_name, or iati_id_ops.")
  }
  
  # Ensure the data frame is not null
  if (is.null(df)) {
    stop("The data frame 'df' must be provided.")
  }
  
  # Apply Year filter (supporting multi-year vectors)
  df_filtered <- df |> 
    dplyr::filter(year %in% !!year)
  
  # Apply scope filters conditionally
  if (!is.null(programmme_lab)) {
    df_filtered <- df_filtered |> dplyr::filter(programmme_lab == !!programmme_lab)
  }
  if (!is.null(ctr_name)) {
    df_filtered <- df_filtered |> dplyr::filter(ctr_name == !!ctr_name)
  }
  if (!is.null(iati_id_ops)) {
    df_filtered <- df_filtered |> dplyr::filter(iati_identifier_ops == !!iati_id_ops)
  }
  
  return(df_filtered)
}
```
  
```{r example-filter_iati_data}
# Example using a mock data frame
sample_data <- data.frame(
  year = c(2023, 2024, 2024),
  programmme_lab = c("Prog A", "Prog A", "Prog B"),
  ctr_name = c("Country X", "Country X", "Country Y"),
  iati_identifier_ops = c("ID1", "ID1", "ID2"),
  value = c(10, 20, 30)
)

# Filter for a specific country and year
filtered <- filter_iati_data(sample_data, 
                             year = 2024, 
                             ctr_name = "Country X")
print(filtered)

# Filter for multiple years
multi_year <- filter_iati_data(sample_data, 
                               year = c(2023, 2024), 
                               programmme_lab = "Prog A")
print(multi_year)
```
  
```{r tests-filter_iati_data}
test_that("filter_iati_data works and handles errors", {
  # Create mock data
  test_df <- data.frame(
    year = 2024,
    programmme_lab = "Test Prog",
    ctr_name = "Test Country",
    iati_identifier_ops = "Test ID"
  )
  
  # 1. Test standard filtering
  res <- filter_iati_data(test_df, year = 2024, ctr_name = "Test Country")
  expect_equal(nrow(res), 1)
  
  # 2. Test multi-year logic
  res_multi <- filter_iati_data(test_df, year = c(2023, 2024))
  expect_equal(nrow(res_multi), 1)
  
  # 3. Test mutually exclusive arguments (should fail)
  expect_error(
    filter_iati_data(test_df, year = 2024, ctr_name = "A", programmme_lab = "B"),
    "Please pass only one of"
  )
  
  # 4. Test inheritence
  expect_true(inherits(filter_iati_data, "function")) 
})
```
  


# Using `iati::dataResult`

## show_indicators
    
 *  How much __indicators__ relate to target or baseline  - or acceptable global standard green threshold (for outcome indicators after 2022)- ?
 
```{r function-show_indicators}
#' show_indicators
#' 
#' How much indicators evolve over time against thresholds?
#' 
#' @param year A numeric value or a vector of numeric value to filter on year. Note that data pre-2022 are using a different set of indicators
#' @param programme_lab A character vector corresponding to the name of the programme.
#' @param iati_identifier_ops A character vector corresponding to the name of the operation.
#' @param ctr_name A character vector corresponding to the name of the country.
#' @param  result_type_name either  "Impact"  "Outcome" "Output" - default is  "Outcome" 
#' @param  type  either "deviation" ,  "progress"  or "gap"
#'   "deviation" showing Relative distances between target and actual - or 
#'   "progress"  showing Relative distances between baseline and actual  - or
#'   "gap" showing Relative distances between green acceptable threshold and actual. 
#'   gap analysis is only displayed for outcome indicators published after 2022
#' 
#' @import ggplot2
#' @import dplyr
#' @import scales
#' @import unhcrthemes
#' @importFrom stats reorder
#'
#' @export 
#' 
#' @return  a graph
show_indicators <- function(year, 
                        programme_lab = NULL, 
                        iati_identifier_ops = NULL, 
                        ctr_name = NULL ,
                       result_type_name = "Outcome",
                        type = "deviation") {
  
  
  # Check if only one argument is passed 
  if (!is.null(programme_lab) && !is.null(iati_identifier_ops)) {
    stop("Please pass only one of the arguments programme_lab or iati_identifier_ops.")
  } else if (!is.null(programme_lab) && !is.null(ctr_name)) {
    stop("Please pass only one of the arguments programme_lab or ctr_name.")
  } else if (!is.null(iati_identifier_ops) && !is.null(ctr_name)) {
    stop("Please pass only one of the arguments iati_identifier_ops or ctr_name.")
  }
  
  df <-  iati::dataResult |> 
         dplyr::left_join(iati::dataActivity, by= c("iati_identifier"))   
  
  if (!is.null(programme_lab)) {
    thisprogramme_lab <- programme_lab
    thisyear <-  year 
    thisresult_type_name <-  result_type_name
    df <- df |> 
      # levels(as.factor(df$result_type_name ))
      dplyr::filter( programmme_lab == thisprogramme_lab &
            year == thisyear & 
             result_type_name ==  thisresult_type_name)  |>
      dplyr::left_join(iati::mapping_result, by= c("result_title")) |> 
      dplyr::left_join( iati::mapping_indicator, by= c("result_indicator_title" = "Indicator" ) ) |> 
      dplyr::distinct()
  } else if (!is.null(iati_identifier_ops)) {
    thisiati_identifier_ops <- iati_identifier_ops
    thisyear <-  year 
    thisresult_type_name <-  result_type_name
    df <- df |> 
      dplyr::filter(iati_identifier_ops == thisiati_identifier_ops &
            year == thisyear & 
             result_type_name ==  thisresult_type_name)|>
      dplyr::left_join(iati::mapping_result, by= c("result_title")) |> 
      dplyr::left_join( iati::mapping_indicator, by= c("result_indicator_title" = "Indicator" ) ) |> 
      dplyr::distinct()
  } else if (!is.null(ctr_name)) {
    thisctr_name <- ctr_name
    thisyear <-  year 
    thisresult_type_name <-  result_type_name
    df <- df |> 
      dplyr::filter( ctr_name == thisctr_name &
            year == thisyear & 
            result_type_name ==  thisresult_type_name) |>
      dplyr::left_join(iati::mapping_result, by= c("result_title")) |> 
      dplyr::left_join( iati::mapping_indicator, by= c("result_indicator_title" = "Indicator" ) ) |> 
      dplyr::distinct()
  }
   
  ## in order to compare indicators all-together in the same country,
  # we need to normalize them
  ## one way is to compute the distance to the target...
  ## names(df)
  
  #table(df$result_indicator_ascending, useNA = "ifany")
  
  ## Calculate deviation to taget, progress from baseline and gap to threshold
  df1 <- df  |> 
    dplyr::select(result_type_name ,  result_title, 
                  indicator_measure_name, result_indicator_title,
                  
                  result_indicator_baseline_value, 
                  result_indicator_actual_value,
                  result_indicator_target_value,
                  result_indicator_actual_value_1,
                  
                  result_indicator_actual_location_ref, 
                  result_indicator_actual_dimension_1,
                 
                  result_indicator_actual_dimension_2,
                  result_indicator_actual_value_2,
                  result_indicator_ascending, 
                  sector_rbm,
                  threshold_red, threshold_orange, threshold_green)  |>
  ## set order in outcome
    dplyr::mutate( sector_rbm = factor(sector_rbm, levels = c("OA1: Access to Territory, Reg. and Documentation", 
                     "OA2: Status Determination",
                     "OA3: Protection Policy and Law", 
                     "OA4: Sexual and Gender-based Violence",
                     "OA5: Child Protection",
                     "OA6: Safety and Access to Justice", 
                     "OA7: Community Engagement and Women's Empowerment", 
                     "OA8: Well-Being and Basic Needs", 
                     "OA9: Sustainable Housing and Settlements", 
                     "OA10: Healthy Lives" ,
                     "OA11: Education",  
                     "OA12: Clean Water, Sanitation and Hygiene",
                     "OA13: Self Reliance, Economic Inclusion and Livelihoods",
                     "OA14: Voluntary Repatriation and Sustainable Reintegration",
                     "OA15: Resettlement and Complementary Pathways", 
                     "OA16: Local Integration and other Local Solutions"))) |>
    
     
      dplyr::mutate(  actual = as.numeric(result_indicator_actual_value),
                      baseline = as.numeric(result_indicator_baseline_value),
                      target = as.numeric(result_indicator_target_value), 
                      ## Reshape the indicator label... 
                      operation = as.character(glue::glue("{result_indicator_title} ({actual})") ), 
                     # operation = as.character(glue::glue("{result_indicator_title} / {result_indicator_actual_value_1}") ), 
                      # operation = as.character(glue::glue("{result_indicator_title} / {result_title} -
                      #                                        {result_indicator_actual_value_1}") ),  
                      
              ## Calculating deviation to target        
                      deviation_actual_target =  round( ( actual - target ) / 
                                                           dplyr::if_else(target == 0, 1, target) * 
                                                           dplyr::if_else(target == 0, 1, 100) ,2 ),
               
                      ## Account for indicator direction
                      deviation_actual_target = dplyr::if_else(result_indicator_ascending == 0, 
                                                         deviation_actual_target * -1, 
                                                         deviation_actual_target),   
                      
                      deviation_color = dplyr::case_when(
                        deviation_actual_target >= -1     ~ "green",
                        deviation_actual_target < -1  & deviation_actual_target >= -15    ~ "orange",
                        deviation_actual_target < -15     ~ "red",
                                                   TRUE ~ ""),
              ## Calculating progress to baseline..        
                      progress_baseline =  round( ( actual - baseline) / 
                                                           dplyr::if_else(baseline == 0, 1, baseline) * 
                                                           dplyr::if_else(baseline == 0, 1, 100)  ,2 ), 
                      ## Account for indicator direction
                      progress_baseline = dplyr::if_else(result_indicator_ascending == 0, 
                                                         progress_baseline * -1, 
                                                         progress_baseline),   
                      progress_color = dplyr::case_when(
                        progress_baseline >= -1     ~ "green",
                        progress_baseline < -1  & progress_baseline >= -15    ~ "orange",
                        progress_baseline < -15     ~ "red",
                                                   TRUE ~ ""),
              
                      gap_green =  round( (  actual - threshold_green ) / 
                                           dplyr::if_else(threshold_green == 0, 1, threshold_green) * 
                                           dplyr::if_else(threshold_green == 0, 1, 100)  ,2 ),
                      gap_green = dplyr::if_else(result_indicator_ascending == 0, 
                                                         gap_green * -1, 
                                                         gap_green), 
              
                      gap_orange =  round( ( actual - threshold_orange  ) / 
                                           dplyr::if_else(threshold_orange == 0, 1, threshold_orange) * 
                                           dplyr::if_else(threshold_orange == 0, 1, 100)  ,2 ), 
                      gap_orange = dplyr::if_else(result_indicator_ascending == 0, 
                                                         gap_orange * -1, 
                                                         gap_orange), 
                      
                      gap_red =  round( ( actual  -  threshold_red ) / 
                                           dplyr::if_else(threshold_red == 0, 1, threshold_red) * 
                                           dplyr::if_else(threshold_red == 0, 1, 100)  ,2 ),
                      gap_red = dplyr::if_else(result_indicator_ascending == 0, 
                                                         gap_red * -1, 
                                                         gap_red)
              
              )    
  
    ## ## https://www.researchgate.net/publication/334894331_Polychrome_Creating_and_Assessing_Qualitative_Palettes_with_Many_Colors
    #install.packages("Polychrome")
    ## Green-Armytage (2010) alphabet color - initially mapped - then corrected based on color mapping with SDG code
    #GreenArmytage <- Polychrome::green.armytage.colors(16)
    palette_outcome <- c("OA1: Access to Territory, Reg. and Documentation" ="#F0A3FF", 
                         "OA2: Status Determination" = "#C20088",
                         "OA3: Protection Policy and Law" = "#993F00", 
                         "OA4: Sexual and Gender-based Violence" = "#FF3A21", #  "#4C005C",
                         "OA5: Child Protection" =  "#FFCC99",
                         "OA6: Safety and Access to Justice" = "#00689D", # "#003380", 
                         "OA7: Community Engagement and Women's Empowerment"= "#94FFB5", 
                         "OA8: Well-Being and Basic Needs" =   "#e5243b",  # "#005C31", 
                         "OA9: Sustainable Housing and Settlements" = "#FD9D24", #  "#8F7C00", 
                         "OA10: Healthy Lives" = "#4C9F38", #  "#FFA8BB", 
                         "OA11: Education"= "#C5192D", # "#808080",  
                         "OA12: Clean Water, Sanitation and Hygiene"= "#26BDE2", # "#0075DC",
                         "OA13: Self Reliance, Economic Inclusion and Livelihoods" =  "#A21942", #  "#19A405",
                         "OA14: Voluntary Repatriation and Sustainable Reintegration"= "#9DCC00",
                         "OA15: Resettlement and Complementary Pathways" = "#191919", 
                         "OA16: Local Integration and other Local Solutions" =  "#2BCE48")
  
  ### Type of chart to build...
  if(type == "deviation") {
    
      df1 <- df1 |> 
          ## Filter out - when no data...
          dplyr::filter (! (is.na(actual)))  |> 
          dplyr::filter (! (is.na(target)))  |> 
          dplyr::filter (! (is.nan(deviation_actual_target))) |>
          #dplyr::arrange(desc(actual))
          dplyr::group_by( result_indicator_title) |>  #, result_indicator_actual_value_1, sector_rbm
          dplyr::arrange(desc( actual), .by_group=TRUE )  |> 
          dplyr::ungroup(result_indicator_title) #, result_indicator_actual_value_1, sector_rbm
     
          ## case there's no data at all
          if( nrow(df1) == 0) {
                info <-  paste0("No deviation - actual to target - \n comparative analysis \n  could be produced for \n",
                                result_type_name, " indicator values \n in ", 
                              programme_lab, ctr_name,iati_identifier_ops, " for year: ", year)
                p <- ggplot2::ggplot() +  
                     ggplot2::annotate("text",  x = 1, y = 1, size = 12,
                                          label = info ) +  
                     ggplot2::theme_void()
          
           } else if(nrow(df1)> 0) {
              ## and now the plot
              p <- ggplot2::ggplot(  data = df1) +
                   ggplot2::coord_flip()  
              
              ## if outcome let's use the color palette - if not use traffic light...
              if (thisresult_type_name == "Outcome") {
                p <- p + 
                  ggplot2::geom_col(   
                    ggplot2::aes(x = stats::reorder(operation, - deviation_actual_target),
                                 y = deviation_actual_target,
                                 fill = sector_rbm ),
                              width = 0.7,
                              color = NA ) + 
                    ggplot2::scale_fill_manual(values = palette_outcome,
                      drop = TRUE,
                      limits = force,
                      na.value = "grey50")  
                
              } else {
                p <- p + 
                    ggplot2::geom_col(   
                      ggplot2::aes(x = stats::reorder(operation, - deviation_actual_target),
                                   y = deviation_actual_target,
                                   fill = deviation_color ),
                                width = 0.7,
                                color = NA )  +
                    ggplot2::scale_fill_manual(values = c( "red" = "#D3212C",   
                                                  "orange" = "#FF980E",
                                                  "green" = "#069C56"))  
              }
              
            p <- p + 
                ## facet the chart by population group... 
                ggplot2::facet_wrap( ggplot2::vars(result_indicator_actual_value_1), 
                         labeller = ggplot2::labeller(result_indicator_actual_value_1 = ggplot2::label_wrap_gen(20))) +
                ggplot2::geom_text( 
                  ggplot2::aes(x = stats::reorder(operation, - deviation_actual_target), 
                               y = deviation_actual_target,
                               label = paste(round(deviation_actual_target, 1), " %") ),
                           #hjust = 1.5, 
                           size = 2.5,
                           color = "black")  +
                # scale_y_continuous( label = scales::label_percent(accuracy = 0,
                #                                    suffix = "%") ) +
                ggplot2::scale_y_continuous( label =  scales::label_number(accuracy = 1, 
                                                                  scale_cut = scales::cut_short_scale(),
                                                                  suffix = "%") )+
                ggplot2::scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 120)) +
                unhcrthemes::theme_unhcr(font_size = 18, 
                                         axis_text_size = 9,
                                         grid = "X", 
                                         axis = "y") +
                ggplot2::theme(  #axis.text.y = ggtext::element_markdown(),
                        legend.position = "none")+
                ggplot2::labs( x = "", y = "" ,
                      title = stringr::str_wrap( 
                        paste0("Deviation Review | ",  result_type_name, " Indicators in  ", 
                              programme_lab, ctr_name,iati_identifier_ops, " as of " , thisyear ) ,
                        100),
                      subtitle = stringr::str_wrap( paste0( 
                        "Between reported \"Actual\" value and programmatic \"Target\" (in %, colors represents outcomes)" ) ,
                        110),
                      caption = stringr::str_wrap( 
                        "Source: Data published by UNHCR as part of the International Aid Transparency Initiative (IATI)" ,
                      110) )  
           }
    } else if( type == "progress")  {
      
      df1 <- df1 |> 
        ## Filter out - when no data...
        dplyr::filter (! (is.na(actual)))  |> 
        dplyr::filter (! (is.na(baseline)))  |> 
        dplyr::filter (! (is.nan(progress_baseline))) |>
        #dplyr::arrange(desc(actual))
        dplyr::group_by( result_indicator_title) |>
        dplyr::arrange(desc( actual), .by_group=TRUE )  |> 
        dplyr::ungroup(result_indicator_title)
 
        ## case there's no data at all
        if( nrow(df1) == 0) {
              info <- paste0("No progress - actual to baseline - \n comparative analysis \n  could be produced for \n",
                                  result_type_name, " indicator values \n in ", 
                                programme_lab, ctr_name,iati_identifier_ops, " for year: ", year)
              p <- ggplot2::ggplot() +  
                   ggplot2::annotate("text",  x = 1, y = 1, size = 12,
                                        label = info ) +  
                   ggplot2::theme_void()
        
         } else if(nrow(df1)> 0) {
            ## and now the plot
            p <-  ggplot2::ggplot(  data = df1) +
              ggplot2::coord_flip() 
            
           if (thisresult_type_name == "Outcome") {
                p <- p + 
                  ggplot2::geom_col(   
                    ggplot2::aes(x = stats::reorder(operation, - deviation_actual_target),
                                 y = deviation_actual_target,
                                 fill = sector_rbm ),
                              width = 0.7,
                              color = NA ) + 
                    ggplot2::scale_fill_manual(values = palette_outcome,
                      drop = TRUE,
                      limits = force,
                      na.value = "grey50")  
                
              } else {
             p <-   p  + 
              ggplot2::geom_col(   
                ggplot2::aes(x = stats::reorder(operation, - progress_baseline),
                             y = progress_baseline,
                             fill = deviation_color ),
                          width = 0.7,
                          color = NA ) +
              ggplot2::scale_fill_manual(values = c( "red" = "#D3212C",   
                                            "orange" = "#FF980E",
                                            "green" = "#069C56")) }
            p <- p + 
              ## facet the chart by population group... 
              ggplot2::facet_wrap( ggplot2::vars(result_indicator_actual_value_1), 
                         labeller = ggplot2::labeller(result_indicator_actual_value_1 = ggplot2::label_wrap_gen(20))) +
              ggplot2::geom_text( 
                  ggplot2::aes(x = stats::reorder(operation, - progress_baseline), 
                             y = progress_baseline,
                             label = paste(round(progress_baseline, 1), " %") ),
                         #hjust = 1.5, 
                         size = 2.5,
                         color = "black")  +
              # scale_y_continuous( label = scales::label_percent(accuracy = 0,
              #                                    suffix = "%") ) +
              ggplot2::scale_y_continuous( label =  scales::label_number(accuracy = 1, 
                                                                scale_cut = scales::cut_short_scale(),
                                                                suffix = "%") )+
              ggplot2::scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 120)) +
              unhcrthemes::theme_unhcr(font_size = 18, 
                                       axis_text_size = 9,
                                       grid = "X", 
                                       axis = "y") +
              ggplot2::theme(  #axis.text.y = ggtext::element_markdown(),
                      legend.position = "none")+
              ggplot2::labs( x = "", y = "" ,
                    title = stringr::str_wrap( 
                      paste0("Progress Comparison | ", result_type_name, " Indicators in  ", 
                              programme_lab, ctr_name,iati_identifier_ops, " as of " , thisyear) ,
                      100),
                    subtitle = stringr::str_wrap( paste0( 
                      "Progress comparison between \"Actual\" reported value and their \"baseline\" (in %)" ) ,
                      110),
                    caption = stringr::str_wrap(
                      "Source: Data published by UNHCR as part of the International Aid Transparency Initiative (IATI)" ,
                    110) )  
         }
      
      
    } else if( type == "gap")  {
      
      df1 <- df1 |> 
        ## Filter out - when no data...
        dplyr::filter (! (is.na(actual)))  |> 
        dplyr::filter (! (is.na(gap_green)))  |> 
        dplyr::filter (! (is.nan(gap_green))) |>
        #dplyr::arrange(desc(actual))
        dplyr::group_by( result_indicator_title) |>
        dplyr::arrange(desc( actual), .by_group=TRUE )  |> 
        dplyr::ungroup(result_indicator_title)
 
        ## case there's no data at all
        if( nrow(df1) == 0) {
              info <- paste0("No gap - actual to green acceptable threshold - \n comparative analysis \n  could be produced for \n",
                                  result_type_name, " indicator values \n in ", 
                                programme_lab, ctr_name,iati_identifier_ops, "\n  for year: ", paste(year, collapse = ', '))
              p <- ggplot2::ggplot() +  
                   ggplot2::annotate("text",  x = 1, y = 1, size = 12,
                                        label = info ) +  
                   ggplot2::theme_void()
        
         } else if(nrow(df1)> 0) {
            ## and now the plot
            p <-  ggplot2::ggplot(  data = df1) +
              ggplot2::coord_flip()   + 
              ggplot2::geom_col(   
                    ggplot2::aes(x = stats::reorder(operation, - gap_green),
                                 y = gap_green,
                                 fill = sector_rbm ),
                              width = 0.7,
                              color = NA ) + 
              ggplot2::scale_fill_manual(values = palette_outcome,
                      drop = TRUE,
                      limits = force,
                      na.value = "grey50")    + 
              ## facet the chart by population group... 
              ggplot2::facet_wrap( ggplot2::vars(result_indicator_actual_value_1), 
                         labeller = ggplot2::labeller(result_indicator_actual_value_1 = ggplot2::label_wrap_gen(20))) +
              ggplot2::geom_text( 
                ggplot2::aes(x = stats::reorder(operation, - gap_green), 
                             y = gap_green,
                             label = paste(round(gap_green, 1), " %") ),
                         #hjust = 1.5, 
                         size = 2.5,
                         color = "black")  +
              # scale_y_continuous( label = scales::label_percent(accuracy = 0,
              #                                    suffix = "%") ) +
              ggplot2::scale_y_continuous( label =  scales::label_number(accuracy = 1, 
                                                                scale_cut = scales::cut_short_scale(),
                                                                suffix = "%") )+
              ggplot2::scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 120)) +
              unhcrthemes::theme_unhcr(font_size = 18, 
                                       axis_text_size = 9,
                                       grid = "X", 
                                       axis = "y") +
              ggplot2::theme(  #axis.text.y = ggtext::element_markdown(),
                      legend.position = "none")+
              ggplot2::labs( x = "", y = "" ,
                    title = stringr::str_wrap( 
                      paste0("Gap Analysis | ", result_type_name, " Indicators in  ", 
                              programme_lab, ctr_name,iati_identifier_ops, " as of " , thisyear) ,
                      100),
                    subtitle = stringr::str_wrap( paste0( 
                      "Between \"Actual\" reported value and  \"Acceptable\" global standard for \"green\"  threshold  (in %)" ) ,
                      110),
                    caption = stringr::str_wrap(
                      "Source: Data published by UNHCR as part of the International Aid Transparency Initiative (IATI)" ,
                    110) )  
            }
              
         }
      
  return(p)
    
}
```
  
```{r example-show_indicators, message=FALSE, warning=FALSE, fig.retina = 2, fig.width = 8,  fig.align = "center",  out.width = "90%"}
show_indicators(year = 2025,  
             ctr_name = "Brazil",
             result_type_name = "Outcome",
             type = "deviation"
             )
show_indicators(year = 2025,  
             ctr_name = "Brazil",
             result_type_name = "Outcome",
             type = "progress"
             )
show_indicators(year = 2025,  
             ctr_name = "Brazil",
             result_type_name = "Outcome",
             type = "gap"
             )
show_indicators(year = 2025,  
             ctr_name = "Brazil",
             result_type_name = "Impact",
             type = "deviation"
             )
show_indicators(year = 2025,  
             ctr_name = "Brazil",
             result_type_name = "Impact",
             type = "progress"
             )
show_indicators(year = 2019,  
             ctr_name = "Brazil",
             result_type_name = "Output",
             type = "deviation"
             )
show_indicators(year = 2019,  
             ctr_name = "Brazil",
              result_type_name = "Output",
             type = "progress"
             )
```
  
```{r tests-show_indicators}
test_that("show_indicators works", {
  expect_true(inherits(show_indicators, "function")) 
})
```

## show_indicators_time
     
 
```{r function-show_indicators_time}
#' show_indicators_time
#' 
#' How much indicators evolve over time?
#' 
#' @param year A numeric value or a vector of numeric value to filter on year. Note that data pre-2022 are using a different set of indicators
#' @param ctr_name A character vector corresponding to the name of the country.
#' @param programme_lab A character vector corresponding to the name of the programme.
#' @param iati_identifier_ops A character vector corresponding to the name of the operation.
#' @param  result_type_name either  "Impact"  "Outcome" "Output" - default is  "Outcome" 
#' @param  type  "deviation" showing difference between target and actual - or 
#'               "progress"  showing difference between baseline and actual 
#' 
#' @import ggplot2
#' @import dplyr
#' @import scales
#' @import unhcrthemes
#' @import stats
#' @importFrom stats reorder
#'
#' @export 
#' 
#' @return  a graph
show_indicators_time <- function(year, 
                        programme_lab = NULL, 
                        iati_identifier_ops = NULL, 
                        ctr_name = NULL ,
                       result_type_name = "Outcome",
                        type = "deviation") {
  
  
  # Check if only one argument is passed 
  if (!is.null(programme_lab) && !is.null(iati_identifier_ops)) {
    stop("Please pass only one of the arguments programme_lab or iati_identifier_ops.")
  } else if (!is.null(programme_lab) && !is.null(ctr_name)) {
    stop("Please pass only one of the arguments programme_lab or ctr_name.")
  } else if (!is.null(iati_identifier_ops) && !is.null(ctr_name)) {
    stop("Please pass only one of the arguments iati_identifier_ops or ctr_name.")
  }
  
  df <-  iati::dataResult |> 
         dplyr::left_join(iati::dataActivity, by= c("iati_identifier"))   
  
  if (!is.null(programme_lab)) {
    thisprogramme_lab <- programme_lab
    thisyear <-  year 
    thisresult_type_name <-  result_type_name
    df <- df |> 
      # levels(as.factor(df$result_type_name ))
      dplyr::filter( programmme_lab == thisprogramme_lab &
            year %in% thisyear & 
             result_type_name ==  thisresult_type_name)  |>
      dplyr::left_join(iati::mapping_result, by= c("result_title")) |> 
      dplyr::left_join( iati::mapping_indicator, by= c("result_indicator_title" = "Indicator" ) ) |> 
      dplyr::distinct()
    
  } else if (!is.null(iati_identifier_ops)) {
    thisiati_identifier_ops <- iati_identifier_ops
    thisyear <-  year 
    thisresult_type_name <-  result_type_name
    df <- df |> 
      dplyr::filter(iati_identifier_ops == thisiati_identifier_ops &
            year %in% thisyear & 
             result_type_name ==  thisresult_type_name)  |>
      dplyr::left_join(iati::mapping_result, by= c("result_title")) |> 
      dplyr::left_join( iati::mapping_indicator, by= c("result_indicator_title" = "Indicator" ) ) |> 
      dplyr::distinct()
    
  } else if (!is.null(ctr_name)) {
    thisctr_name <- ctr_name
    thisyear <-  year 
    thisresult_type_name <-  result_type_name
    df <- df |> 
      dplyr::filter( ctr_name == thisctr_name &
            year %in% thisyear & 
            result_type_name ==  thisresult_type_name)  |>
      dplyr::left_join(iati::mapping_result, by= c("result_title")) |> 
      dplyr::left_join( iati::mapping_indicator, by= c("result_indicator_title" = "Indicator" ) ) |> 
      dplyr::distinct()
  }
   
  ## in order to compare indictors alltogether in the same country, we need to normalise them
  ## one way is to compute the distance to the target...
  ## names(df)
  
  #table(df$result_indicator_ascending, useNA = "ifany")
  df1 <- df  |> 
    dplyr::select(result_type_name ,  result_title, sector_rbm,
                  indicator_measure_name, result_indicator_title,
                  year,
                  
                  result_indicator_baseline_value, 
                  result_indicator_actual_value,
                  result_indicator_target_value,
                  result_indicator_actual_value_1,
                  
                  result_indicator_actual_location_ref, 
                  result_indicator_actual_dimension_1,
                 
                  result_indicator_actual_dimension_2,
                  result_indicator_actual_value_2,
                  result_indicator_ascending,  
                  sector_rbm,
                  threshold_red, threshold_orange, threshold_green)  |>
    
  ## set order in outcome
    dplyr::mutate( sector_rbm = factor(sector_rbm, levels = c("OA1: Access to Territory, Reg. and Documentation", 
                     "OA2: Status Determination",
                     "OA3: Protection Policy and Law", 
                     "OA4: Sexual and Gender-based Violence",
                     "OA5: Child Protection",
                     "OA6: Safety and Access to Justice", 
                     "OA7: Community Engagement and Women's Empowerment", 
                     "OA8: Well-Being and Basic Needs", 
                     "OA9: Sustainable Housing and Settlements", 
                     "OA10: Healthy Lives" ,
                     "OA11: Education",  
                     "OA12: Clean Water, Sanitation and Hygiene",
                     "OA13: Self Reliance, Economic Inclusion and Livelihoods",
                     "OA14: Voluntary Repatriation and Sustainable Reintegration",
                     "OA15: Resettlement and Complementary Pathways", 
                     "OA16: Local Integration and other Local Solutions"))) |>
  
     ## Quick fix in case ascending is not documented...
     dplyr::mutate(  result_indicator_ascending = dplyr::if_else( is.na(result_indicator_ascending), 
                                               
                                               "1", 
                                               result_indicator_ascending))   |>    
     
      dplyr::mutate(  actual = as.numeric(result_indicator_actual_value),
                      baseline = as.numeric(result_indicator_baseline_value),
                      target = as.numeric(result_indicator_target_value), 
                      ## Reshape the indicator label... 
                      operation = as.character(glue::glue("{result_indicator_title}"  ) ), 
                      #operation = as.character(glue::glue("{result_indicator_title} / {result_indicator_actual_value_1}") ), 
                      # operation = as.character(glue::glue("{result_indicator_title} / {result_title} -
                      #                                        {result_indicator_actual_value_1}") ),  
                      
                      
              ## Calculating deviation to target        
                      deviation_actual_target =  round( ( actual - target ) / 
                                                           dplyr::if_else(target == 0, 1, target) * 
                                                           dplyr::if_else(target == 0, 1, 100) ,2 ),
               
                      ## Account for indicator direction
                      deviation_actual_target = dplyr::if_else(result_indicator_ascending == 0, 
                                                         deviation_actual_target * -1, 
                                                         deviation_actual_target),   
                      
                      deviation_color = dplyr::case_when(
                        deviation_actual_target >= -1     ~ "green",
                        deviation_actual_target < -1  & deviation_actual_target >= -15    ~ "orange",
                        deviation_actual_target < -15     ~ "red",  
                                                   TRUE ~ ""),
              ## Calculating progress to baseline..        
                      progress_baseline =  round( ( actual - baseline) / 
                                                           dplyr::if_else(baseline == 0, 1, baseline) * 
                                                           dplyr::if_else(baseline == 0, 1, 100)  ,2 ), 
                      ## Account for indicator direction
                      progress_baseline = dplyr::if_else(result_indicator_ascending == 0, 
                                                         progress_baseline * -1, 
                                                         progress_baseline),   
                      progress_color = dplyr::case_when(
                        progress_baseline >= -1     ~ "green",
                        progress_baseline < -1  & progress_baseline >= -15    ~ "orange",
                        progress_baseline < -15     ~ "red",  
                                                   TRUE ~ ""),
              
                      gap_green =  round( (  actual - threshold_green ) / 
                                           dplyr::if_else(threshold_green == 0, 1, threshold_green) * 
                                           dplyr::if_else(threshold_green == 0, 1, 100)  ,2 ),
                      gap_green = dplyr::if_else(result_indicator_ascending == 0, 
                                                         gap_green * -1, 
                                                         gap_green), 
              
                      gap_orange =  round( ( actual - threshold_orange  ) / 
                                           dplyr::if_else(threshold_orange == 0, 1, threshold_orange) * 
                                           dplyr::if_else(threshold_orange == 0, 1, 100)  ,2 ), 
                      gap_orange = dplyr::if_else(result_indicator_ascending == 0, 
                                                         gap_orange * -1, 
                                                         gap_orange), 
                      
                      gap_red =  round( ( actual  -  threshold_red ) / 
                                           dplyr::if_else(threshold_red == 0, 1, threshold_red) * 
                                           dplyr::if_else(threshold_red == 0, 1, 100)  ,2 ),
                      gap_red = dplyr::if_else(result_indicator_ascending == 0, 
                                                         gap_red * -1, 
                                                         gap_red)
              
              )    
  
  
      ## ## https://www.researchgate.net/publication/334894331_Polychrome_Creating_and_Assessing_Qualitative_Palettes_with_Many_Colors
      #install.packages("Polychrome")
      ## Green-Armytage (2010) alphabet color - initially mapped - then corrected based on color mapping with SDG code
      #GreenArmytage <- Polychrome::green.armytage.colors(16)
      palette_outcome <- c("OA1: Access to Territory, Reg. and Documentation" ="#F0A3FF", 
                           "OA2: Status Determination" = "#C20088",
                           "OA3: Protection Policy and Law" = "#993F00", 
                           "OA4: Sexual and Gender-based Violence" = "#FF3A21", #  "#4C005C",
                           "OA5: Child Protection" =  "#FFCC99",
                           "OA6: Safety and Access to Justice" = "#00689D", # "#003380", 
                           "OA7: Community Engagement and Women's Empowerment"= "#94FFB5", 
                           "OA8: Well-Being and Basic Needs" =   "#e5243b",  # "#005C31", 
                           "OA9: Sustainable Housing and Settlements" = "#FD9D24", #  "#8F7C00", 
                           "OA10: Healthy Lives" = "#4C9F38", #  "#FFA8BB", 
                           "OA11: Education"= "#C5192D", # "#808080",  
                           "OA12: Clean Water, Sanitation and Hygiene"= "#26BDE2", # "#0075DC",
                           "OA13: Self Reliance, Economic Inclusion and Livelihoods" =  "#A21942", #  "#19A405",
                           "OA14: Voluntary Repatriation and Sustainable Reintegration"= "#9DCC00",
                           "OA15: Resettlement and Complementary Pathways" = "#191919", 
                           "OA16: Local Integration and other Local Solutions" =  "#2BCE48")
  
  
  ### Type of chart to build...
  if(type == "deviation") {
    
      df2 <- df1 |> 
          ## Filter out - when no data...
          dplyr::filter (! (is.na(actual)))  |> 
          dplyr::filter (! (is.na(target)))  |> 
          dplyr::filter (! (is.nan(deviation_actual_target))) |>
          #dplyr::arrange(desc(actual))
          dplyr::group_by( result_indicator_title) |>
          dplyr::arrange(desc( actual), .by_group=TRUE )  |> 
          dplyr::ungroup(result_indicator_title)
     
          ## case there's no data at all
          if( nrow(df2) == 0) {
                info <-  paste0("No deviation - actual to target - \n comparative analysis \n  could be produced for \n",
                                result_type_name, " indicator values \n in ", 
                              programme_lab, ctr_name,iati_identifier_ops, " for year: ", year)
                p <- ggplot2::ggplot() +  
                     ggplot2::annotate("text",  x = 1, y = 1, size = 12,
                                          label = info ) +  
                     ggplot2::theme_void()
          
           } else if(nrow(df2)> 0) {
              ## and now the plot
              p <-  ggplot2::ggplot( df2, 
                    ggplot2::aes(x = year,
                          y = deviation_actual_target,
                          #shape = indicator_measure_name,
                         color = sector_rbm)) + 
                    ggplot2::geom_jitter(position= ggplot2::position_jitter(0.2),
                                   shape = 17,
                                   size = 3) +
                    ggplot2::stat_summary(fun.data= ggplot2::mean_sdl, #mult=1, 
                               geom="pointrange", color="grey", size = .2)   + 
                    ggplot2::geom_hline(yintercept= 0, color="red") +
                    # ggplot2::scale_color_viridis_d(option = "inferno", na.value = "grey50") + 
                   # ggplot2::scale_colour_brewer(palette = "Paired") + 
                    ggplot2::scale_color_manual(values = palette_outcome,
                      drop = TRUE,
                      limits = force,
                      na.value = "grey50")  +
                   ## facet the chart by population group... 
                   ggplot2::facet_wrap( ggplot2::vars(result_indicator_actual_value_1), 
                         labeller = ggplot2::labeller(result_indicator_actual_value_1 = ggplot2::label_wrap_gen(20))) +
                   ggplot2::scale_y_continuous( label =  scales::label_number(accuracy = 1, 
                                                                         scale_cut = scales::cut_short_scale(),
                                                                         suffix = "%") ) +
                    ggplot2::scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 120)) +
                    unhcrthemes::theme_unhcr(font_size = 20, 
                                       axis_text_size = 9,
                                       grid = "Y", 
                                       axis = "y",
                                       strip_text_size = ggplot2::rel(0.5),
                                       strip_text_face = "italic") +
                    ggplot2::theme( legend.direction = "vertical",
                                legend.box = "horizontal",
                                legend.position = "right") +
                    ggplot2::labs( x = "", y = "" ,
                             title = stringr::str_wrap( 
                               paste0( "Deviation Review | ", result_type_name, " Indicators   ", 
                                       programme_lab, ctr_name,iati_identifier_ops ) ,
                               100), 
                             subtitle = stringr::str_wrap( paste0( 
                                     "Relative distances between reported \"Actual\" value and programmatic \"Target\" (in %)" ) ,
                                  110),
                             caption = stringr::str_wrap( 
                               "Source: Data published by UNHCR as part of the International Aid Transparency Initiative (IATI)" ,
                               110) )  
           }
    } else if( type == "progress")  {
      
      df2 <- df1 |> 
        ## Filter out - when no data...
        dplyr::filter (! (is.na(actual)))  |> 
        dplyr::filter (! (is.na(baseline)))  |> 
        dplyr::filter (! (is.nan(progress_baseline))) |>
        
        ## Remove extreme outliers that are likely data entry issue....
        dplyr::filter(!(abs(progress_baseline - stats::median(progress_baseline)) > 3 * stats::sd(progress_baseline))) |>
        
        #dplyr::arrange(desc(actual))
        dplyr::group_by( result_indicator_title) |>
        dplyr::arrange(desc( actual), .by_group=TRUE )  |> 
        dplyr::ungroup(result_indicator_title)
 
        ## case there's no data at all
        if( nrow(df2) == 0) {
              info <- paste0("No progress - actual to baseline - \n comparative analysis \n  could be produced for \n",
                                  result_type_name, " indicator values \n in ", 
                                programme_lab, ctr_name,iati_identifier_ops, " for year: ", year)
              p <- ggplot2::ggplot() +  
                   ggplot2::annotate("text",  x = 1, y = 1, size = 12,
                                        label = info ) +  
                   ggplot2::theme_void()
        
         } else if(nrow(df2)> 0) {
            ## and now the plot
            p <- ggplot2::ggplot( df2, 
                 ggplot2::aes(x = year,
                          y = progress_baseline,
                         #shape = indicator_measure_name,
                         color = sector_rbm)) + 
                 ggplot2::geom_jitter(position= ggplot2::position_jitter(0.2),
                             shape = 17,
                             size = 3) +
                 ggplot2::stat_summary(fun.data= ggplot2::mean_sdl, #mult=1, 
                         geom="pointrange", color="grey", size = .2)   + 
                 ggplot2::geom_hline(yintercept= 0, color="red") +
                 # ggplot2::scale_color_viridis_d(option = "inferno", na.value = "grey50") + 
                 # ggplot2::scale_colour_brewer(palette = "Paired") +
                 ggplot2::scale_color_manual(values = palette_outcome,
                      drop = TRUE,
                      limits = force,
                      na.value = "grey50")  +
                ## facet the chart by population group... 
                ggplot2::facet_wrap( ggplot2::vars(result_indicator_actual_value_1), 
                         labeller = ggplot2::labeller(result_indicator_actual_value_1 = ggplot2::label_wrap_gen(20))) +
                 ggplot2::scale_y_continuous( label =  scales::label_number(accuracy = 1, 
                                                                           scale_cut = scales::cut_short_scale(),
                                                                           suffix = "%") )+
                 ggplot2::scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 120)) +
                    unhcrthemes::theme_unhcr(font_size = 20, 
                                       axis_text_size = 9,
                                       grid = "Y", 
                                       axis = "y",
                                       strip_text_size = ggplot2::rel(0.5),
                                       strip_text_face = "italic") +
                  ggplot2::theme( legend.direction = "vertical",
                                  legend.box = "horizontal",
                                  legend.position = "right")+
                
                ggplot2::labs( x = "", y = "" ,
                               title = stringr::str_wrap( 
                                 paste0( "Progress Comparison | ", result_type_name, " Indicators   ", 
                                         programme_lab, ctr_name,iati_identifier_ops ) ,
                                 100),
                        subtitle = stringr::str_wrap( paste0( 
                              "Relative distances between \"Actual\" reported value and their \"baseline\" (in %)" ) ,
                                 110),
                               caption = stringr::str_wrap( 
                                 "Source: Data published by UNHCR as part of the International Aid Transparency Initiative (IATI)" ,
                                 110) )  
             }
    } else if( type == "gap")  {
      
       df2 <- df1 |> 
        ## Filter out - when no data...
        dplyr::filter (! (is.na(actual)))  |> 
        dplyr::filter (! (is.na(gap_green)))  |> 
        dplyr::filter (! (is.nan(gap_green))) |>
        #dplyr::arrange(desc(actual))
        dplyr::group_by( result_indicator_title) |>
        dplyr::arrange(desc( actual), .by_group=TRUE )  |> 
        dplyr::ungroup(result_indicator_title)
 
        ## case there's no data at all
        if( nrow(df2) == 0) {
              info <- paste0("No gap analysis - actual to green threshold - \n comparative analysis \n  could be produced for \n",
                                  result_type_name, " indicator values \n in ", 
                                programme_lab, ctr_name,iati_identifier_ops, " for year: ", year)
              p <- ggplot2::ggplot() +  
                   ggplot2::annotate("text",  x = 1, y = 1, size = 12,
                                        label = info ) +  
                   ggplot2::theme_void()
        
         } else if(nrow(df2)> 0) {
            ## and now the plot
            p <-  ggplot2::ggplot( df2, 
                  ggplot2::aes(x = year,
                          y = gap_green,
                          #shape = indicator_measure_name,
                          color = sector_rbm)) + 
                 ggplot2::geom_jitter(position= ggplot2::position_jitter(0.2),
                                     shape = 17,
                                     size = 3) +
                 ggplot2::stat_summary(fun.data= ggplot2::mean_sdl, #mult=1, 
                                 geom="pointrange", color="grey", size = .3)   + 
                 ggplot2::geom_hline(yintercept= 0, color="red") +
                  # ggplot2::scale_color_viridis_d(option = "inferno", na.value = "grey50") + 
                  # ggplot2::scale_colour_brewer(palette = "Paired") +
                 ggplot2::scale_color_manual(values = palette_outcome,
                      drop = TRUE,
                      limits = force,
                      na.value = "grey50")  +
                ## facet the chart by population group... 
                ggplot2::facet_wrap( ggplot2::vars(result_indicator_actual_value_1), 
                         labeller = ggplot2::labeller(result_indicator_actual_value_1 = ggplot2::label_wrap_gen(20))) +
                 ggplot2::scale_y_continuous( label =  scales::label_number(accuracy = 1, 
                                                                           scale_cut = scales::cut_short_scale(),
                                                                           suffix = "%") )+
                 ggplot2::scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 120)) +
                    unhcrthemes::theme_unhcr(font_size = 20, 
                                       axis_text_size = 9,
                                       grid = "Y", 
                                       axis = "y",
                                       strip_text_size = ggplot2::rel(0.5),
                                       strip_text_face = "italic") +
                 ggplot2::theme( legend.direction = "vertical",
                                  legend.box = "horizontal",
                                  legend.position = "right")+
                 ggplot2::labs( x = "", y = "" ,
                               title = stringr::str_wrap( 
                                 paste0( "Gap Analysis | ", result_type_name, " Indicators   ", 
                                         programme_lab, ctr_name,iati_identifier_ops ) ,
                                 100),
                               subtitle = stringr::str_wrap( paste0( 
                               "Relative distances between \"Actual\" reported value and  \"Acceptable\" global standard for \"green\"  threshold  (in %)" ) ,
                                 110),
                               caption = stringr::str_wrap( 
                                 "Source: Data published by UNHCR as part of the International Aid Transparency Initiative (IATI)" ,
                                 110) )  
             }
  }
  
  
  return(p)
    
}
```
  
```{r example-show_indicators_time, message=FALSE, warning=FALSE, fig.retina = 2, fig.width = 8,  fig.align = "center",  out.width = "90%"}
show_indicators_time(year = 2025,  
             ctr_name = "Brazil",
              result_type_name = "Outcome",
             type = "deviation"
             )
show_indicators_time(year =  2025, 
             ctr_name = "Brazil",
              result_type_name = "Outcome",
             type = "progress"
             )
show_indicators_time(year =  2025, 
             ctr_name = "Brazil",
              result_type_name = "Outcome",
             type = "gap"
             )
show_indicators_time(year =  2025, 
             ctr_name = "Brazil",
              result_type_name = "Impact",
             type = "deviation"
             )
show_indicators_time(year =  2025, 
             ctr_name = "Brazil",
              result_type_name = "Impact",
             type = "progress"
             )
show_indicators_time(year =  2025,  
             ctr_name = "Brazil",
              result_type_name = "Output",
             type = "deviation"
             )
show_indicators_time(year =  2025, 
             ctr_name = "Brazil",
              result_type_name = "Output",
             type = "progress"
             )
```
  
```{r tests-show_indicators_time}
test_that("show_indicators_time works", {
  expect_true(inherits(show_indicators_time, "function")) 
})
```
  

# Using `iati::dataSector`

## show_sectors

 *  What are the __most funded sectors__ per country (Expenditure evolution per impact /outcome area)?  
    
```{r function-show_sectors}
#' show_sectors
#'  
#' @description  What are the most funded sectors per country (Expenditure evolution per impact /outcome area)?  
#' 
#' @param year A numeric value or a list of value.
#' @param programme_lab A character vector corresponding to the name of the programme.
#' @param iati_identifier_ops A character vector corresponding to the name of the operation.
#' @param ctr_name A character vector corresponding to the name of the country.
#' @param sector_vocabulary_name sector_vocabulary
#' 
#' @import ggplot2
#' @import dplyr
#' @import scales
#' @import unhcrthemes
#' @importFrom stats reorder
#'
#' @export 
#' @return  a graph
show_sectors <- function(year, 
                         programme_lab = NULL, 
                         iati_identifier_ops = NULL, 
                         ctr_name = NULL,
                         sector_vocabulary_name = "Reporting Organisation 2"){
  # Check if only one argument is passed 
  if (!is.null(programme_lab) && !is.null(iati_identifier_ops)) {
    stop("Please pass only one of the arguments programme_lab or iati_identifier_ops.")
  } else if (!is.null(programme_lab) && !is.null(ctr_name)) {
    stop("Please pass only one of the arguments programme_lab or ctr_name.")
  } else if (!is.null(iati_identifier_ops) && !is.null(ctr_name)) {
    stop("Please pass only one of the arguments iati_identifier_ops or ctr_name.")
  }
  
  # Join dataActivity and dataSector on iati_identifier 
  df <- iati::dataSector |>
    dplyr::left_join(iati::dataActivity,  by = c("iati_identifier"))
  #df0 <-df
  
  if (!is.null(programme_lab)) {
    thisprogramme_lab <- programme_lab
    thisyear <- year
    thissector_vocabulary <- sector_vocabulary
    df <- df |> 
      dplyr::mutate(year = factor(year)) |>
      dplyr::filter(programmme_lab == thiprogramme_lab &
            year %in% thisyear & 
            sector_vocabulary_name ==  thissector_vocabulary_name)
  } else if (!is.null(iati_identifier_ops)) {
    thisiati_identifier_ops <- iati_identifier_ops
    thisyear <- year
    thissector_vocabulary_name <- sector_vocabulary_name
    df <- df |> 
      dplyr::mutate(year = factor(year)) |>
      dplyr::filter(iati_identifier_ops == thisiati_identifier_ops &
            year %in%  thisyear & 
            sector_vocabulary_name ==  thissector_vocabulary_name)
  } else if (!is.null(ctr_name)) {
    thisctr_name <- ctr_name
    thisyear <- year  
    thissector_vocabulary_name <- sector_vocabulary_name
    df <- df |> 
      dplyr::mutate(year = factor(year)) |>
      dplyr::filter(ctr_name == thisctr_name &
            year %in% thisyear & 
            sector_vocabulary_name ==  thissector_vocabulary_name)
  }
  
  if( nrow(df) == 0) {
      info <-  paste0("No resource allocation data available for \n",  
                              programme_lab, ctr_name,iati_identifier_ops, 
                      "\n for vocabulary: ", sector_vocabulary_name)
    p <- ggplot2::ggplot() +  
         ggplot2::annotate("text",  x = 1, y = 1, size = 4,
                            label = info ) +  
        ggplot2::theme_void()
    
  } else {
  
  df <- df |> 
    dplyr::group_by(sector_desc, year) |> 
    dplyr::summarise(sector_pct = mean( as.numeric(sector_pct)) ) |> 
   # dplyr::summarise(sector_pct = sum(sector_pct, na.rm = TRUE)/sum(df$sector_pct, na.rm = TRUE)*100) |> 
  #  top_n(5, wt = sector_pct) |> 
    dplyr::mutate(sector_desc = as.factor(sector_desc))
  

  p <-  ggplot2::ggplot(data = df, 
                        ggplot2::aes(x = stats::reorder(sector_desc, sector_pct),
                                 y = sector_pct
                                 )) +
   # unhcrthemes::theme_unhcr(grid = TRUE, axis = "Y", axis_title = "Sector Percentage") +
    unhcrthemes::theme_unhcr(grid = "X", axis = "y", axis_title = "X", font_size = 18) +
    
    ggplot2::geom_bar(stat = "identity", fill = "#0072BC") +
    ggplot2::coord_flip()+
    ggplot2::facet_wrap( ggplot2::vars(year)) +
    ggplot2::scale_fill_viridis_d(option = "inferno", na.value = "grey50") +
    ggplot2::scale_y_continuous(expand = ggplot2::expansion(mult = c(0, .1)), labels = scales::label_number(scale_cut = scales::cut_short_scale())) +
    ggplot2::labs(title = "Resource Allocation per Sectors (%)", 
        subtitle = paste0("Recorded in ", programme_lab, ctr_name,iati_identifier_ops,
                          " based on vocabulary: ", sector_vocabulary_name),          
         x = "Sectors", y = "% of Total Funding", 
         caption = "Source: Data published by UNHCR as part of the International Aid Transparency Initiative (IATI)") 

    
  }
    
 
  return(p)
}
```
  
```{r example-show_sectors, message=FALSE, warning=FALSE, fig.retina = 2, fig.width = 8, fig.asp = 0.618, fig.align = "center",  out.width = "90%"}
# knitr::kable( iati::dataSector |> 
#                 dplyr::select( sector_vocabulary_name, sector_vocabulary_description) |>
#                 dplyr::distinct() |>
#                 dplyr::filter(!(is.na(sector_vocabulary_name))))
show_sectors(
  year =  c(2022, 2023, 2024, 2025), 
  ctr_name = "Brazil",
  sector_vocabulary_name = "Reporting Organisation")

show_sectors(
  year = 2025, 
  ctr_name = "Brazil",
  sector_vocabulary_name = "Reporting Organisation 2")
show_sectors(
  year = c(2022, 2023, 2024, 2025),  
  ctr_name = "Brazil",
  sector_vocabulary_name = "Reporting Organisation 2")
show_sectors(
  year = c(2022, 2023, 2024, 2025), 
  ctr_name = "Brazil",
  sector_vocabulary_name = "Humanitarian Global Clusters (Inter-Agency Standing Committee)")
show_sectors(
  year = c( 2022, 2023, 2024, 2025), 
  ctr_name = "Brazil",
  sector_vocabulary_name = "OECD DAC CRS Purpose Codes (5 digit)")
```
  
```{r tests-show_sectors}
test_that("show_sectors works", {
  expect_true(inherits(show_sectors, "function")) 
})
```

## show_goal_sdg
    
```{r function-show_goal_sdg}
#' show_goal_sdg
#' 
#' @description Show resource allocation in line with SDG goal
#' @param year A numeric value or a list of value.
#' @param programme_lab A character vector corresponding to the name of the programme.
#' @param iati_identifier_ops A character vector corresponding to the name of the operation.
#' @param ctr_name A character vector corresponding to the name of the country. 
#' 
#' @import ggplot2
#' @import dplyr
#' @import scales
#' @import unhcrthemes
#' @importFrom stats reorder
#'
#' @export 
#' @return  a graph
show_goal_sdg <- function(year, 
                         programme_lab = NULL, 
                         iati_identifier_ops = NULL, 
                         ctr_name = NULL ){
  # Check if only one argument is passed 
  if (!is.null(programme_lab) && !is.null(iati_identifier_ops)) {
    stop("Please pass only one of the arguments programme_lab or iati_identifier_ops.")
  } else if (!is.null(programme_lab) && !is.null(ctr_name)) {
    stop("Please pass only one of the arguments programme_lab or ctr_name.")
  } else if (!is.null(iati_identifier_ops) && !is.null(ctr_name)) {
    stop("Please pass only one of the arguments iati_identifier_ops or ctr_name.")
  }
  
  # Join dataActivity and dataSector on iati_identifier 
  df <- iati::dataSector |>
    dplyr::left_join(iati::dataActivity,  by = c("iati_identifier")) |>
    dplyr::mutate(year = factor(year))
  
  if (!is.null(programme_lab)) {
    thisprogramme_lab <- programme_lab
    thisyear <- year 
    df <- df |> 
      dplyr::mutate(year = factor(year)) |>
      dplyr::filter(programmme_lab == thiprogramme_lab &
            year %in% thisyear & 
            sector_vocabulary_name ==  "Reporting Organisation 2") |>
      dplyr::left_join(iati::mapping_sector, by= c("sector_desc")) |>
      dplyr::left_join(iati::mapping_sdg, by= c("sector_rbm" = "area")) 
      
  } else if (!is.null(iati_identifier_ops)) {
    thisiati_identifier_ops <- iati_identifier_ops
    thisyear <- year 
    df <- df |> 
      dplyr::mutate(year = factor(year)) |>
      dplyr::filter(iati_identifier_ops == thisiati_identifier_ops &
            year %in%  thisyear & 
            sector_vocabulary_name ==  "Reporting Organisation 2") |>
      dplyr::left_join(iati::mapping_sector, by= c("sector_desc"))|>
      dplyr::left_join(iati::mapping_sdg, by= c("sector_rbm" = "area")) 
  } else if (!is.null(ctr_name)) {
    thisctr_name <- ctr_name
    thisyear <- year 
    df <- df |> 
      dplyr::mutate(year = factor(year)) |>
      dplyr::filter(ctr_name == thisctr_name &
            year %in% thisyear & 
            sector_vocabulary_name == "Reporting Organisation 2") |>
      dplyr::left_join(iati::mapping_sector, by= c("sector_desc"))|>
      dplyr::left_join(iati::mapping_sdg, by= c("sector_rbm" = "area")) 
  }
  
    if( nrow(df) == 0) {
      info <-  paste0("No resource allocation data available for \n",  
                              programme_lab, ctr_name,iati_identifier_ops, 
                      "\n for SDG vocabulary")
      p <- ggplot2::ggplot() +  
           ggplot2::annotate("text",  x = 1, y = 1, size = 4,
                              label = info ) +  
          ggplot2::theme_void()
    
      } else {
  
        df <- df |> 
          dplyr::group_by(sector_desc, sector_rbm,sdg, year) |> 
          dplyr::summarise(sector_pct = mean( as.numeric(sector_pct)) ) |> 
          dplyr::group_by( sdg, year) |> 
          dplyr::summarise(sector_pct = sum(sector_pct, rm.na = TRUE))  |> 
         # dplyr::summarise(sector_pct = sum(sector_pct, na.rm = TRUE)/sum(df$sector_pct, na.rm = TRUE)*100) |> 
        #  top_n(5, wt = sector_pct) |> 
          dplyr::mutate(sdg = as.factor(sdg))
      
      
       ## Now joining budget & Expenditure to make the chart more informative...
       df_bud <-  iati::dataTransaction |> 
             dplyr::left_join(iati::dataActivity, by= c("iati_identifier"))   |>
             dplyr::mutate(year = factor(year))
  
       if (!is.null(programme_lab)) {
         thisprogramme_lab <- programme_lab
         thisyear <-  year
         df_bud <- df_bud |>
           # levels(as.factor(df$programmme_lab))
           dplyr::filter(
             programmme_lab == thisprogramme_lab &
               year  %in% thisyear &
               transaction_type_name ==  "Expenditure"
           )
       } else if (!is.null(iati_identifier_ops)) {
         thisiati_identifier_ops <- iati_identifier_ops
         thisyear <-  year
         df_bud <- df_bud |>
           dplyr::filter(
             iati_identifier_ops == thisiati_identifier_ops &
               year  %in% thisyear &
               transaction_type_name ==  "Expenditure"
           )
       } else if (!is.null(ctr_name)) {
         thisctr_name <- ctr_name
         thisyear <-  year
         df_bud <- df_bud |>
           dplyr::filter(ctr_name == thisctr_name &
                           year    %in% thisyear &
                           transaction_type_name ==  "Expenditure")
       }
  
   df_bud2 <-  df_bud  |> 
        dplyr::group_by(iati_identifier, year) |>
        dplyr::summarise(transaction_value_USD= sum(transaction_value, na.rm = TRUE)) |>
        dplyr::left_join(iati::dataBudget |> 
                          dplyr::mutate(budget_value= as.numeric(budget_value)) |>
                          dplyr::group_by(iati_identifier) |>
                          dplyr::summarise(budget_value= sum(budget_value, na.rm = TRUE))  
                            , by= c("iati_identifier"))  |>
     dplyr::select(iati_identifier, year,budget_value,   transaction_value_USD ) |>
     dplyr::mutate( year2 = glue::glue('{year}   Bud:{scales::label_number(accuracy = .2, scale_cut = scales::cut_short_scale())(budget_value)}$  Exp:{scales::label_number(accuracy = .2, scale_cut = scales::cut_short_scale())(transaction_value_USD)}$  '))
   
   df <- df |>
         dplyr::left_join(df_bud2, by = c("year"))
   
   ### https://www.un.org/sustainabledevelopment/wp-content/uploads/2019/01/SDG_Guidelines_AUG_2019_Final.pdf
   palette_sdg <- c("1. No Poverty" ="#e5243b", 
   "3. Good Health and well-being" ="#4C9F38", 
   "4. Quality Education" ="#C5192D", 
   "5. Gender Equality" ="#FF3A21", 
   "6. Clean Water and Sanitation" ="#26BDE2", 
   "8. Decent work and economic growth" ="#A21942", 
   "10. Reduced inequalities" ="#DD1367", 
   "11. Sustainable cities and communities" ="#FD9D24", 
   "16. Peace, justice and strong institutions" ="#00689D", 
   "17. Partnerships for the goals" ="#19486A",
   "not_sdg" = "#D3D3D3")
  

  p <-  ggplot2::ggplot(data = df, 
                        ggplot2::aes(x = stats::reorder(sdg, sector_pct),
                                 y = sector_pct,
                                 fill = sdg )) +
   # unhcrthemes::theme_unhcr(grid = TRUE, axis = "Y", axis_title = "Sector Percentage") +
    unhcrthemes::theme_unhcr(grid = "X", axis = "y", 
                             axis_title = "X",
                             legend = FALSE,
                             font_size = 18) +
    
    ggplot2::geom_bar(stat = "identity") +  # , fill = "#0072BC"
    ggplot2::coord_flip()+
    ggplot2::facet_wrap( ggplot2::vars(year2), 
                         labeller = ggplot2::labeller(year2 = ggplot2::label_wrap_gen(5))) +
   # ggplot2::scale_fill_viridis_d(option = "inferno", na.value = "grey50") +
        ggplot2::scale_fill_manual(values = palette_sdg,
                      drop = TRUE,
                      limits = force,
                      na.value = "grey50") +
    ggplot2::scale_y_continuous(expand = ggplot2::expansion(mult = c(0, .1)),
                                labels = scales::label_number(scale_cut = scales::cut_short_scale())) +
    
    ggplot2::labs(title = "Resource Allocation per SDG (%)", 
        subtitle = paste0("Recorded in ", programme_lab, ctr_name,iati_identifier_ops,
                          "  "),          
         x = "Sectors", y = "% of Total Funding", 
         caption = "Source: Data published by UNHCR as part of the International Aid Transparency Initiative (IATI). UNHCR budget is needs-based. It represents the total amount of money that would be required were UNHCR to meet all of the needs that it is seeking to address.") 
  }
  return(p)
}
```
  
```{r example-show_goal_sdg, message=FALSE, warning=FALSE, fig.retina = 2, fig.width = 8,  fig.align = "center",  out.width = "90%"}
show_goal_sdg(year =  c(2022, 2023, 2024, 2025), 
             ctr_name = "Brazil")
```
  
```{r tests-show_goal_sdg}
test_that("show_goal_sdg works", {
  expect_true(inherits(show_goal_sdg, "function")) 
})
```
  

## show_outcome_rbm
    
```{r function-show_outcome_rbm}
#' show_outcome_rbm
#' 
#' @description  What are the most funded sectors per country based on new RBM framework.
#'   The activities that UNHCR plans and undertakes around the world are described
#'    under 16 "Outcome Areas".   
#' 
#' @param year A numeric value or a list of value.
#' @param programme_lab A character vector corresponding to the name of the programme.
#' @param iati_identifier_ops A character vector corresponding to the name of the operation.
#' @param ctr_name A character vector corresponding to the name of the country. 
#' 
#' @import ggplot2
#' @import dplyr
#' @import scales
#' @import unhcrthemes
#' @importFrom stats reorder
#'
#' @export 
#' @return  a graph
show_outcome_rbm <- function(year, 
                         programme_lab = NULL, 
                         iati_identifier_ops = NULL, 
                         ctr_name = NULL ){
  # Check if only one argument is passed 
  if (!is.null(programme_lab) && !is.null(iati_identifier_ops)) {
    stop("Please pass only one of the arguments programme_lab or iati_identifier_ops.")
  } else if (!is.null(programme_lab) && !is.null(ctr_name)) {
    stop("Please pass only one of the arguments programme_lab or ctr_name.")
  } else if (!is.null(iati_identifier_ops) && !is.null(ctr_name)) {
    stop("Please pass only one of the arguments iati_identifier_ops or ctr_name.")
  }
  
  # Join dataActivity and dataSector on iati_identifier 
  df <- iati::dataSector |>
    dplyr::left_join(iati::dataActivity,  by = c("iati_identifier")) |>
    dplyr::mutate(year = factor(year))
  
  if (!is.null(programme_lab)) {
    thisprogramme_lab <- programme_lab
    thisyear <- year 
    df <- df |> 
      dplyr::mutate(year = factor(year)) |>
      dplyr::filter(programmme_lab == thiprogramme_lab &
            year %in% thisyear & 
            sector_vocabulary_name ==  "Reporting Organisation 2") |>
      dplyr::left_join(iati::mapping_sector, by= c("sector_desc"))
  } else if (!is.null(iati_identifier_ops)) {
    thisiati_identifier_ops <- iati_identifier_ops
    thisyear <- year 
    df <- df |> 
      dplyr::mutate(year = factor(year)) |>
      dplyr::filter(iati_identifier_ops == thisiati_identifier_ops &
            year %in%  thisyear & 
            sector_vocabulary_name ==  "Reporting Organisation 2") |>
      dplyr::left_join(iati::mapping_sector, by= c("sector_desc"))
  } else if (!is.null(ctr_name)) {
    thisctr_name <- ctr_name
    thisyear <- year 
    df <- df |> 
      dplyr::mutate(year = factor(year)) |>
      dplyr::filter(ctr_name == thisctr_name &
            year %in% thisyear & 
            sector_vocabulary_name == "Reporting Organisation 2") |>
      dplyr::left_join(iati::mapping_sector, by= c("sector_desc"))
  }
  
    if( nrow(df) == 0) {
      info <-  paste0("No resource allocation data available for \n",  
                              programme_lab, ctr_name,iati_identifier_ops, 
                      "\n by Outcome")
    p <- ggplot2::ggplot() +  
         ggplot2::annotate("text",  x = 1, y = 1, size = 4,
                            label = info ) +  
        ggplot2::theme_void()
    
  } else {
  
  df <- df |> 
    dplyr::group_by(sector_desc, sector_rbm, year) |> 
    dplyr::summarise(sector_pct = mean( as.numeric(sector_pct)) ) |> 
    dplyr::group_by( sector_rbm, year) |> 
    dplyr::summarise(sector_pct = sum(sector_pct, rm.na = TRUE))  |> 
   # dplyr::summarise(sector_pct = sum(sector_pct, na.rm = TRUE)/sum(df$sector_pct, na.rm = TRUE)*100) |> 
  #  top_n(5, wt = sector_pct) |> 
    dplyr::mutate(sector_rbm = as.factor(sector_rbm))
  
  
  ## Now joining budget & Expenditure to make the chart more informative...
   df_bud <-  iati::dataTransaction |> 
         dplyr::left_join(iati::dataActivity, by= c("iati_identifier"))  |>
         dplyr::mutate(year = factor(year))
  
  if (!is.null(programme_lab)) {
    thisprogramme_lab <- programme_lab
    thisyear <-  year 
   df_bud <- df_bud |> 
      # levels(as.factor(df$programmme_lab))
      dplyr::filter( programmme_lab == thisprogramme_lab &
            year  %in% thisyear & 
             transaction_type_name ==  "Expenditure")
  } else if (!is.null(iati_identifier_ops)) {
    thisiati_identifier_ops <- iati_identifier_ops
    thisyear <-  year 
   df_bud <- df_bud |> 
      dplyr::filter(iati_identifier_ops == thisiati_identifier_ops &
            year  %in% thisyear & 
             transaction_type_name ==  "Expenditure")
  } else if (!is.null(ctr_name)) {
    thisctr_name <- ctr_name
    thisyear <-  year 
    df_bud <- df_bud |> 
      dplyr::filter( ctr_name == thisctr_name &
            year    %in% thisyear & 
             transaction_type_name ==  "Expenditure")
  }
  
   df_bud2 <-  df_bud  |> 
        dplyr::group_by(iati_identifier, year) |>
        dplyr::summarise(transaction_value_USD = sum(transaction_value, na.rm = TRUE)) |>
        dplyr::left_join(iati::dataBudget |> 
                          dplyr::mutate(budget_value= as.numeric(budget_value)) |>
                          dplyr::group_by(iati_identifier) |>
                          dplyr::summarise(budget_value= sum(budget_value, na.rm = TRUE))  
                            , by= c("iati_identifier"))  |>
     dplyr::select(iati_identifier, year,budget_value,   transaction_value_USD ) |>
     dplyr::mutate( year2 = glue::glue('{year}  Bud:{scales::label_number(accuracy = .2, scale_cut = scales::cut_short_scale())(budget_value)}$  Exp:{scales::label_number(accuracy = .2, scale_cut = scales::cut_short_scale())(transaction_value_USD)}$  '))
   
   df <- df |>
         dplyr::left_join(df_bud2, by = c("year"))
   
  
## ## https://www.researchgate.net/publication/334894331_Polychrome_Creating_and_Assessing_Qualitative_Palettes_with_Many_Colors
#install.packages("Polychrome")
## Green-Armytage (2010) alphabet color - initially mapped - then corrected based on color mapping with SDG code
#GreenArmytage <- Polychrome::green.armytage.colors(16)
palette_outcome <- c("OA1: Access to Territory, Reg. and Documentation" ="#F0A3FF", 
                     "OA2: Status Determination" = "#C20088",
                     "OA3: Protection Policy and Law" = "#993F00", 
                     "OA4: Sexual and Gender-based Violence" = "#FF3A21", #  "#4C005C",
                     "OA5: Child Protection" =  "#FFCC99",
                     "OA6: Safety and Access to Justice" = "#00689D", # "#003380", 
                     "OA7: Community Engagement and Women's Empowerment"= "#94FFB5", 
                     "OA8: Well-Being and Basic Needs" =   "#e5243b",  # "#005C31", 
                     "OA9: Sustainable Housing and Settlements" = "#FD9D24", #  , 
                     "OA10: Healthy Lives" = "#4C9F38",  
                     "OA11: Education"= "#C5192D", #  ,  
                     "OA12: Clean Water, Sanitation and Hygiene"= "#26BDE2", # "#0075DC",
                     "OA13: Self Reliance, Economic Inclusion and Livelihoods" =  "#A21942", #  "#19A405",
                     "OA14: Voluntary Repatriation and Sustainable Reintegration"= "#9DCC00",
                     "OA15: Resettlement and Complementary Pathways" = "#191919", 
                     "OA16: Local Integration and other Local Solutions" =  "#2BCE48",
                     ## the enabling areas...
                     "EA17: Systems and Processes" ="#8F7C00",
                     "EA18: Operational Support and Supply Chain" = "#808080", 
                     "EA19: People and Culture" = "#FFA8BB",
                     "EA20: External Engagement and Resource Mobilization"= "#003380" )
   
   
   
  p <-  ggplot2::ggplot(data = df, 
                        ggplot2::aes(x = stats::reorder(sector_rbm, sector_pct),
                                 y = sector_pct,
                                 fill = sector_rbm,
                                 )) +
    
    ggplot2::geom_bar(stat = "identity") + # , fill = "#0072BC"
    ggplot2::coord_flip()+
    ggplot2::facet_wrap( ggplot2::vars(year2), 
                         labeller = ggplot2::labeller(year2 = ggplot2::label_wrap_gen(8))) +
    ggplot2::scale_fill_manual(values = palette_outcome,
                      drop = TRUE,
                      limits = force,
                      na.value = "grey50") +
    ggplot2::scale_y_continuous(expand = ggplot2::expansion(mult = c(0, .1)),
                                labels = scales::label_number(scale_cut = scales::cut_short_scale())) +
   # unhcrthemes::theme_unhcr(grid = TRUE, axis = "Y", axis_title = "Sector Percentage") +
    unhcrthemes::theme_unhcr(grid = "X", axis = "y", 
                             axis_title = "X",
                              legend = FALSE,
                             font_size = 18) +
    ggplot2::labs(title = "Resource Allocation per Outcome (%)", 
        subtitle = paste0("Recorded in ", programme_lab, ctr_name,iati_identifier_ops,
                          " based on UNHCR Results Framework "),          
         x = "Sectors", y = "% of Total Funding", 
         caption = "Source: Data published by UNHCR as part of the International Aid Transparency Initiative (IATI). UNHCR budget is needs-based. It represents the total amount of money that would be required were UNHCR to meet all of the needs that it is seeking to address.") 
  }
  
  return(p)
}
```
  
```{r example-show_outcome_rbm, message=FALSE, warning=FALSE, fig.retina = 2, fig.width = 8,  fig.align = "center",  out.width = "90%"}
show_outcome_rbm( year =  c(2022, 2023, 2024, 2025), 
             ctr_name = "Brazil")
```
  
```{r tests-show_outcome_rbm}
test_that("show_outcome_rbm works", {
  expect_true(inherits(show_outcome_rbm, "function")) 
})
```
     
## show_outcome_result
    
```{r function-show_outcome_result}
#' show_outcome_result
#' 
#' @param year A numeric value or a vector of numeric value to filter on year.
#' @param programme_lab A character vector corresponding to the name of the programme.
#' @param iati_identifier_ops A character vector corresponding to the name of the operation.
#' @param ctr_name A character vector corresponding to the name of the country.
#' @param outcome Strategic Outcome label (e.g., "OA1: ...")#' @param  outcome any of:
#'   "OA1: Access to Territory, Reg. and Documentation", 
#'   "OA2: Status Determination",
#'   "OA3: Protection Policy and Law", 
#'   "OA4: Sexual and Gender-based Violence",
#'   "OA5: Child Protection",
#'   "OA6: Safety and Access to Justice", 
#'   "OA7: Community Engagement and Women's Empowerment", 
#'   "OA8: Well-Being and Basic Needs", 
#'   "OA9: Sustainable Housing and Settlements", 
#'   "OA10: Healthy Lives" ,
#'   "OA11: Education",  
#'   "OA12: Clean Water, Sanitation and Hygiene",
#'   "OA13: Self Reliance, Economic Inclusion and Livelihoods",
#'   "OA14: Voluntary Repatriation and Sustainable Reintegration",
#'   "OA15: Resettlement and Complementary Pathways", 
#'   "OA16: Local Integration and other Local Solutions"
#' 
#' @import ggplot2
#' @import dplyr
#' @import scales
#' @import unhcrthemes
#' @import cowplot
#' @import grid
#' @import purrr
#' @importFrom stats reorder#'
#' @import glue 
#' @import stringr
#' @export 
#' @return A patchwork grid of visualizations
show_outcome_result <- function(year, 
                                 programme_lab = NULL, 
                                 iati_identifier_ops = NULL, 
                                 ctr_name = NULL,
                                 outcome) {
  
  # --- 1. Validation ---
  # Ensure exactly one filter argument is provided
  filter_args <- list(programme_lab = programme_lab, 
                      iati_identifier_ops = iati_identifier_ops, 
                      ctr_name = ctr_name)
  provided <- names(filter_args)[!sapply(filter_args, is.null)]
  
  if (length(provided) > 1) {
    stop(paste("Please pass only one of:", paste(names(filter_args), collapse = ", ")))
  }
  
  # --- 2. Helper Functions ---
  
  # Calculate relative distance (%) accounting for indicator direction
  calc_rel_dist <- function(val, base, direction) {
    # denominator is 1 if base is 0 to avoid Inf, otherwise base
    denom <- dplyr::if_else(base == 0, 1, abs(base))
    res <- round(((val - base) / denom) * 100, 2)
    # If ascending is 0 (decreasing is good), flip the sign
    dplyr::if_else(direction == "0", res * -1, res)
  }
  
  # Generate a placeholder plot when data is missing
  empty_plot <- function(msg) {
    ggplot2::ggplot() + 
      ggplot2::annotate("text", x = 1, y = 1, label = stringr::str_wrap(msg, 30)) + 
      ggplot2::theme_void()
  }

  # --- 3. Data Preparation ---
  
  # Determine which column to filter by
  filter_col <- if (!is.null(programme_lab)) "programmme_lab" else if (!is.null(iati_identifier_ops)) "iati_identifier_ops" else "ctr_name"
  filter_val <- filter_args[[provided]]
  
  # Initial Join and Filter
  df_base <- iati::dataResult |>
    dplyr::left_join(iati::dataActivity, by = "iati_identifier") |>
    dplyr::filter(!!rlang::sym(filter_col) == filter_val,
                  year %in% !!year,
                  result_type_name == "Outcome") |>
    dplyr::left_join(iati::mapping_result, by = "result_title") |>
    dplyr::filter(sector_rbm == outcome) |>
    dplyr::left_join(iati::mapping_indicator, by = c("result_indicator_title" = "Indicator")) |>
    dplyr::distinct() |>
    # Clean and Normalize data
    dplyr::mutate(
      year = factor(year),
      actual = as.numeric(result_indicator_actual_value),
      baseline = as.numeric(result_indicator_baseline_value),
      target = as.numeric(result_indicator_target_value),
      direction = dplyr::if_else(is.na(result_indicator_ascending), "1", as.character(result_indicator_ascending)),
      # Calculations
      deviation_actual_target = calc_rel_dist(actual, target, direction),
      progress_baseline = calc_rel_dist(actual, baseline, direction),
      gap_green = calc_rel_dist(actual, threshold_green, direction)
    )

  if (nrow(df_base) == 0) return(empty_plot("No data found for selection"))

  # --- 4. Styling & Palettes ---
  
  palette_outcome <- c(
    "OA1: Access to Territory, Reg. and Documentation" = "#F0A3FF", "OA2: Status Determination" = "#C20088",
    "OA3: Protection Policy and Law" = "#993F00", "OA4: Sexual and Gender-based Violence" = "#FF3A21",
    "OA5: Child Protection" = "#FFCC99", "OA6: Safety and Access to Justice" = "#00689D",
    "OA7: Community Engagement and Women's Empowerment" = "#94FFB5", "OA8: Well-Being and Basic Needs" = "#e5243b",
    "OA9: Sustainable Housing and Settlements" = "#FD9D24", "OA10: Healthy Lives" = "#4C9F38",
    "OA11: Education" = "#C5192D", "OA12: Clean Water, Sanitation and Hygiene" = "#26BDE2",
    "OA13: Self Reliance, Economic Inclusion and Livelihoods" = "#A21942", "OA14: Voluntary Repatriation and Sustainable Reintegration" = "#9DCC00",
    "OA15: Resettlement and Complementary Pathways" = "#191919", "OA16: Local Integration and other Local Solutions" = "#2BCE48"
  )

  # Shapes for indicators
  unique_indicators <- unique(df_base$result_indicator_title)
  shape_indicator <- setNames(seq_along(unique_indicators) - 1, unique_indicators)

  # --- 5. Result Plotting Function ---
  
  create_result_plot <- function(data, y_var, subtitle, caption) {
    plot_data <- data |> dplyr::filter(!is.na(actual), !is.na(!!rlang::sym(y_var)), !is.nan(!!rlang::sym(y_var)))
    
    if(nrow(plot_data) == 0) return(empty_plot(paste("No data for", subtitle)))
    
    ggplot2::ggplot(plot_data, ggplot2::aes(x = year, y = !!rlang::sym(y_var), 
                                            shape = result_indicator_title, color = sector_rbm)) +
      ggplot2::geom_jitter(position = ggplot2::position_jitter(0.2), size = 3) +
      ggplot2::geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
      ggplot2::scale_shape_manual(values = shape_indicator) +
      ggplot2::scale_color_manual(values = palette_outcome) +
      ggplot2::scale_y_continuous(labels = scales::label_number(suffix = "%")) +
      unhcrthemes::theme_unhcr(font_size = 13, grid = "Y", axis = "y") +
      ggplot2::guides(shape = "none", color = "none") +
      ggplot2::labs(subtitle = stringr::str_wrap(subtitle, 50), caption = stringr::str_wrap(caption, 60), x = "", y = "")
  }

  # Generate individual plots
  pdeviation <- create_result_plot(df_base, "deviation_actual_target", "Indicators Deviation Review", "Distance between Actual and Target")
  pprogress  <- create_result_plot(df_base, "progress_baseline", "Indicators Progress Comparison", "Distance between Actual and Baseline")
  pgap       <- create_result_plot(df_base, "gap_green", "Indicators Gap Analysis", "Distance between Actual and Green Threshold")

  # --- 6. Legend Extraction ---
  
  indiclegendp <- ggplot2::ggplot(df_base, ggplot2::aes(x = year, y = deviation_actual_target, shape = result_indicator_title)) +
    ggplot2::geom_point() +
    ggplot2::scale_shape_manual(values = shape_indicator, labels = \(x) stringr::str_wrap(x, 40), name = "Indicators") +
    unhcrthemes::theme_unhcr() +
    ggplot2::theme(legend.position = "left")
  
  indiclegend <- cowplot::ggdraw(grid::grobTree(cowplot::get_legend(indiclegendp)))

  # --- 7. Resource Allocation ---
  
  # Budget/Expenditure Data
  df_bud <- iati::dataTransaction |>
    dplyr::left_join(iati::dataActivity, by = "iati_identifier") |>
    dplyr::filter(!!rlang::sym(filter_col) == filter_val, year %in% !!year, transaction_type_name == "Expenditure") |>
    dplyr::group_by(year) |>
    dplyr::summarise(transaction_value = sum(transaction_value, na.rm = TRUE)) |>
    dplyr::mutate(year = factor(year))

  # Sector Percentage Data
  df_res <- iati::dataSector |>
    dplyr::left_join(iati::dataActivity, by = "iati_identifier") |>
    dplyr::filter(!!rlang::sym(filter_col) == filter_val, year %in% !!year, sector_vocabulary_name == "Reporting Organisation 2") |>
    dplyr::left_join(iati::mapping_sector, by = "sector_desc") |>
    dplyr::group_by(sector_rbm, year) |>
    dplyr::summarise(sector_pct = sum(as.numeric(sector_pct), na.rm = TRUE), .groups = "drop") |>
    dplyr::filter(sector_rbm == outcome) |>
    dplyr::mutate(year = factor(year)) |>
    dplyr::left_join(df_bud, by = "year")

  if (nrow(df_res) == 0) {
    presource <- empty_plot("No resource data")
  } else {
    df_res <- df_res |>
      dplyr::mutate(
        val_sub = (transaction_value * sector_pct / 100),
        val_lab = scales::label_number(accuracy = .1, scale_cut = scales::cut_short_scale())(val_sub),
        label = glue::glue("({val_lab}$)")
      )

    presource <- ggplot2::ggplot(df_res, ggplot2::aes(x = year, y = sector_pct, fill = sector_rbm)) +
      ggplot2::geom_col() +
      ggplot2::geom_text(ggplot2::aes(label = label), vjust = -0.5, size = 3.5) +
      ggplot2::scale_fill_manual(values = palette_outcome) +
      unhcrthemes::theme_unhcr(grid = "Y", axis = "y", legend = FALSE) +
      ggplot2::labs(subtitle = "Resource Allocation (% and Value)", x = "", y = "%")
  }

  # --- 8. Final Assembly ---
  
  design <- "AAAALL\nBBCCDD"
  
  p <- patchwork::wrap_plots(
    A = presource, B = pprogress, C = pdeviation, D = pgap, L = indiclegend, 
    design = design
  ) + 
  patchwork::plot_annotation(
    title = glue::glue("Resource & Results for {outcome} in {filter_val}"),
    caption = 'Source: UNHCR IATI Data'
  )
  
  return(p)
}
```
  
```{r example-show_outcome_result, message=FALSE, warning=FALSE, fig.retina = 2, fig.width = 9, fig.asp = 0.618, fig.align = "center",  out.width = "90%"}
show_outcome_result(year =  c(2022, 2023, 2024, 2025), 
             ctr_name = "Brazil",
             outcome = "OA2: Status Determination")
show_outcome_result(year =  c(2022, 2023, 2024, 2025), 
             ctr_name = "Brazil",
             outcome = "OA9: Sustainable Housing and Settlements")
show_outcome_result(year =  c(2022, 2023, 2024, 2025), 
             ctr_name = "Brazil",
             outcome = "OA8: Well-Being and Basic Needs")
show_outcome_result(year =  c(2022, 2023, 2024, 2025), 
             ctr_name = "Brazil",
             outcome = "OA4: Sexual and Gender-based Violence")
```
  
```{r tests-show_outcome_result}
test_that("show_outcome_result works", {
  expect_true(inherits(show_outcome_result, "function")) 
})
```
   
## compare_resource_result
    
```{r function-compare_resource_result}
#' compare_resource_result
#' 
#' @param year A numeric value or a vector of numeric value to filter on year. 
#'             Note that data pre-2022 are using a different set of indicators
#' @param ctr_name A character vector corresponding to the name of the country.
#' @param indicator one specific indicators - label
#' 
#' @param show_baseline TRUE / FALSE boolean to indicate whether to filter and 
#'                      display records that have a baseline value. 
#'                      This will likely impact the number of clean records 
#'                      that can be plotted...
#' @param show_target TRUE / FALSE boolean to indicate whether to filter and
#'                     display records that have a target value
#'                      This will likely impact the number of clean records 
#'                      that can be plotted...
#'                      
#' @param pop_type default is null - but can be used to filter on population type:
#'     "Refugees and Asylum-seekers","IDPs" ,"Stateless Persons" 
#'     "Others of Concern" ,"Returnees"   , "Host Community"             
#' @param  outcome any of:
#'   "OA1: Access to Territory, Reg. and Documentation", 
#'   "OA2: Status Determination",
#'   "OA3: Protection Policy and Law", 
#'   "OA4: Sexual and Gender-based Violence",
#'   "OA5: Child Protection",
#'   "OA6: Safety and Access to Justice", 
#'   "OA7: Community Engagement and Women's Empowerment", 
#'   "OA8: Well-Being and Basic Needs", 
#'   "OA9: Sustainable Housing and Settlements", 
#'   "OA10: Healthy Lives" ,
#'   "OA11: Education",  
#'   "OA12: Clean Water, Sanitation and Hygiene",
#'   "OA13: Self Reliance, Economic Inclusion and Livelihoods",
#'   "OA14: Voluntary Repatriation and Sustainable Reintegration",
#'   "OA15: Resettlement and Complementary Pathways", 
#'   "OA16: Local Integration and other Local Solutions"

#' 
#' @import ggplot2
#' @import dplyr
#' @import scales
#' @import unhcrthemes
#' @import patchwork
#' @import cowplot
#' @import grid
#' @import purrr
#' @importFrom stats reorder
#'
#' @export 
#' 
#' @return  a graph
compare_resource_result <- function(year = 2025, 
                                    ctr_name = NULL,
                                    pop_type = NULL,
                                    show_baseline = FALSE,
                                    show_target = FALSE,
                                    indicator,
                                    outcome) {
  
   
  df <-  iati::dataResult |> 
         dplyr::mutate(year = factor(year))|> 
        dplyr::left_join(iati::dataActivity, by= c("iati_identifier"))   
  
  thisyear <-  year  
  thisoutcome <-  outcome
  thisindicator <-  indicator
  df <- df |> 
   # levels(as.factor(df$result_type_name ))
      dplyr::filter(   year %in% thisyear )  |>
      dplyr::left_join(iati::mapping_result, by= c("result_title")) |> 
   #  dplyr::filter( sector_rbm == thisoutcome) |>
      dplyr::left_join( iati::mapping_indicator, by= c("result_indicator_title" = "Indicator" ) ) |> 
      dplyr::filter(result_indicator_title %in% thisindicator) |>
      dplyr::distinct()
    
  
  ## in order to compare indicators all together in the same country, 
  ## we need to normalize them
  ## one way is to compute the distance to the target...
  ## names(df)
  
  #table(df$result_indicator_ascending, useNA = "ifany")
  df1 <- df  |> 
    dplyr::select(unhcr_region, iso3c, ctr_name,
                  result_type_name ,  result_title, sector_rbm,
                  indicator_measure_name, result_indicator_title,
                  year,
                  result_indicator_baseline_value, 
                  result_indicator_actual_value,
                  result_indicator_target_value,
                  result_indicator_actual_value_1,
                  result_indicator_actual_location_ref, 
                  result_indicator_actual_dimension_1,
                  result_indicator_actual_dimension_2,
                  result_indicator_actual_value_2,
                  result_indicator_ascending,  
                  sector_rbm,
                  threshold_red, threshold_orange, threshold_green) |>
    ## Quick fix in case ascending is not documented...
    dplyr::mutate(  result_indicator_ascending = dplyr::if_else( is.na(result_indicator_ascending), 
                                                                 "1", 
                                                                 result_indicator_ascending))   |>    
    
    dplyr::mutate(  actual = as.numeric(result_indicator_actual_value),
                    baseline = as.numeric(result_indicator_baseline_value),
                    target = as.numeric(result_indicator_target_value), 
                    ## Reshape the indicator label... 
                    operation = as.character(glue::glue("{result_indicator_title} / {result_indicator_actual_value_1}") ), 
                    # operation = as.character(glue::glue("{result_indicator_title} / {result_title} -
                    #                                        {result_indicator_actual_value_1}") ),  
                    
                    
                    ## Calculating deviation to target        
                    deviation_actual_target =  round( ( actual - target ) / 
                                                        dplyr::if_else(target == 0, 1, target) * 
                                                        dplyr::if_else(target == 0, 1, 100) ,2 ),
                    
                    ## Account for indicator direction
                    deviation_actual_target = dplyr::if_else(result_indicator_ascending == 0, 
                                                             deviation_actual_target * -1, 
                                                             deviation_actual_target),   
                    
                    deviation_color = dplyr::case_when(
                      deviation_actual_target >= -1     ~ "green",
                      deviation_actual_target < -1  & deviation_actual_target >= -15    ~ "orange",
                      deviation_actual_target < -15     ~ "red",  
                      TRUE ~ ""),
                    ## Calculating progress to baseline..        
                    progress_baseline =  round( ( actual - baseline) / 
                                                  dplyr::if_else(baseline == 0, 1, baseline) * 
                                                  dplyr::if_else(baseline == 0, 1, 100)  ,2 ), 
                    ## Account for indicator direction
                    progress_baseline = dplyr::if_else(result_indicator_ascending == 0, 
                                                       progress_baseline * -1, 
                                                       progress_baseline),   
                    progress_color = dplyr::case_when(
                      progress_baseline >= -1     ~ "green",
                      progress_baseline < -1  & progress_baseline >= -15    ~ "orange",
                      progress_baseline < -15     ~ "red",  
                      TRUE ~ ""),
                    
                    gap_green =  round( (  actual - threshold_green ) / 
                                          dplyr::if_else(threshold_green == 0, 1, threshold_green) * 
                                          dplyr::if_else(threshold_green == 0, 1, 100)  ,2 ),
                    gap_green = dplyr::if_else(result_indicator_ascending == 0, 
                                               gap_green * -1, 
                                               gap_green), 
                    
                    gap_orange =  round( ( actual - threshold_orange  ) / 
                                           dplyr::if_else(threshold_orange == 0, 1, threshold_orange) * 
                                           dplyr::if_else(threshold_orange == 0, 1, 100)  ,2 ), 
                    gap_orange = dplyr::if_else(result_indicator_ascending == 0, 
                                                gap_orange * -1, 
                                                gap_orange), 
                    
                    gap_red =  round( ( actual  -  threshold_red ) / 
                                        dplyr::if_else(threshold_red == 0, 1, threshold_red) * 
                                        dplyr::if_else(threshold_red == 0, 1, 100)  ,2 ),
                    gap_red = dplyr::if_else(result_indicator_ascending == 0, 
                                             gap_red * -1, 
                                             gap_red)
                    
    )    
  
 
  ## and now the  ressource allocation  #####
  dfRes <- iati::dataSector |>
    dplyr::left_join(iati::dataActivity,  by = c("iati_identifier")) |> 
      dplyr::mutate(year = factor(year)) |>
      dplyr::filter(year %in% thisyear & 
                      sector_vocabulary_name ==  "Reporting Organisation 2") |>
    dplyr::left_join(iati::mapping_sector, by= c("sector_desc")) |> 
    dplyr::select(ctr_name, sector_code, sector_desc, sector_rbm, year, sector_pct   ) |>
    dplyr::group_by( ctr_name, sector_desc, sector_rbm, year) |> 
    dplyr::summarise(sector_pct = mean( as.numeric(sector_pct)) ) |> 
    dplyr::group_by( ctr_name, sector_rbm, year) |> 
    dplyr::summarise(sector_pct = sum(sector_pct, rm.na = TRUE))  |> 
    # dplyr::summarise(sector_pct = sum(sector_pct, na.rm = TRUE)/sum(df$sector_pct, na.rm = TRUE)*100) |> 
    #  top_n(5, wt = sector_pct) |> 
    dplyr::mutate(sector_rbm = as.factor(sector_rbm)) |>
    dplyr::filter( sector_rbm == thisoutcome)
  
  
  ## Results vs Resource  #####
  dfall1 <- df1 |> 
    ## Filter out - when no data...
    dplyr::filter (! (is.na(actual)))  |>  
    dplyr::left_join(dfRes, by = c("ctr_name")) 
  
  ## Filters....
  if (! (is.null(pop_type)) ){
    dfall1 <-   dfall1 |>
    dplyr::filter (result_indicator_actual_value_1 %in% c(pop_type)) } 

  if(   show_baseline == TRUE){
    dfall1 <-   dfall1 |>
    dplyr::filter (! (is.na(baseline))) }
    
  if( show_target  == TRUE){
    dfall1 <-   dfall1 |>
    dplyr::filter (! (is.na(target))) }

   ## Treat case when no corresponding resource allocation
   dfall <-   dfall1 |>
              dplyr::filter (! (is.na(sector_pct)))  

  
  ## case there's no data at all
  if( nrow(dfall) == 0) {
    info <-  paste0("No  \n comparative analysis \n  could be produced for \n",
                    outcome, "\n  & indicator \n in ", 
                    indicator, "   " )
    p <- ggplot2::ggplot() +  
      ggplot2::annotate("text",  x = 1, y = 1, size = 4,
                        label = info ) +  
      ggplot2::theme_void()
    
  } else if(nrow(dfall)> 0) {
    
    
    ## Background with color band for beter interpreation in line with standards! 
    maxgreen <- max(dfall$threshold_green)
    maxorange <- max(dfall$threshold_orange)
    maxred <- max(dfall$threshold_red)
    palette_level <- c( "crtical"= "#D3212C",
                        "notcool"="#FF980E",
                        "Acceptable"= "#069C56")
    if( unique(dfall$result_indicator_ascending) == "0") {
      threshold = data.frame( 
        indlevel = c("crtical","notcool", "Acceptable"), 
        xmin = c(0, 0, 0 ), 
       # xmax = c(100, 100, 100 ), 
       # xmin = c(min(dfall$sector_pct), min(dfall$sector_pct), min(dfall$sector_pct) ), 
        xmax = c(max(dfall$sector_pct)+5, max(dfall$sector_pct)+5, max(dfall$sector_pct)+5 ), 
        ymin = c( 0,  maxgreen , maxorange ), # 
        ymax = c( maxgreen ,  maxorange, maxred )  #   
      ) 
      
    }  else if ( unique(dfall$result_indicator_ascending) == "1") { 
      threshold = data.frame( 
        indlevel = c("crtical","notcool", "Acceptable"), 
        xmin = c(0, 0, 0 ), 
       # xmin = c(min(dfall$sector_pct), min(dfall$sector_pct), min(dfall$sector_pct) ), 
        xmax = c(max(dfall$sector_pct)+5, max(dfall$sector_pct)+5, max(dfall$sector_pct)+5 ), 
        ymin = c( 0,  maxred, maxorange ),   
        ymax = c( maxred,  maxorange, maxgreen )  
      )
    }
    
    ## now do some check in case, we need to focus on a specific country
    if (is.null(ctr_name) ){
      # https://dataviz.unhcr.org/assets/download/UNHCR_Data_Visualization_Guidelines.pdf
    palette_unhcr_region <-   c( "Asia and the Pacific"= "#00B398",
                                 "East and Horn of Africa"   = "#0072BC",
                                 "Europe"="#E1CC0D",
                                 "Middle East and North Africa"="#EF4A60",
                                 "Southern Africa"  = "#589BE5" ,
                                 "The Americas" = "#18375F",    
                                 "West and Central Africa"="#8EBEFF" )
      
    interpretation <- "Indicator Value Interpretation: circle=Actual Reported Value, color=Standard Acceptability Threshold"
    
    ## and now the plot without country focus 
    p  <-  ggplot2::ggplot( dfall, ggplot2::aes( x = sector_pct))  +
       ggplot2::geom_rect( data=  threshold, 
                        ggplot2::aes(xmin = xmin, xmax = xmax, 
                                       ymin = ymin, ymax = ymax, 
                                       fill = indlevel), 
                          inherit.aes = FALSE,
                          alpha = 0.4)  +
       ggplot2::guides(fill = "none") +
       ggplot2::scale_fill_manual(values = palette_level,
                                 drop = TRUE,
                                 limits = force,
                                 na.value = "grey50") +
       ggplot2::facet_wrap( ggplot2::vars(result_indicator_actual_value_1), 
             labeller = ggplot2::labeller(result_indicator_actual_value_1 = ggplot2::label_wrap_gen(20)))  
     # ggplot2::geom_smooth(ggplot2::aes(y = actual), method = "loess", span = 0.05, alpha =0.25) +
      #ggplot2::geom_smooth(method="auto", se=TRUE, fullrange=FALSE, level=0.95) +
    
    if( show_target  == TRUE & show_baseline == TRUE){
      p <- p +
       ggplot2::geom_segment(ggplot2::aes(x = sector_pct, 
                                         y = baseline, 
                                         xend = sector_pct, 
                                         yend = target), 
                            color = "black") 
       interpretation <- "Indicator Value Interpretation: circle=Actual Reported Value, square=baseline, triangle=Target, color=Standard Acceptability Threshold"
      }
    
      if(   show_baseline == TRUE){
        p <- p +
          ggplot2::geom_point( ggplot2::aes(y = baseline), size = 1.5, shape = 22, fill = "black")
         interpretation <- "Indicator Value Interpretation: circle=Actual Reported Value, square=baseline,  color=Standard Acceptability Threshold"
          }
    if( show_target  == TRUE){
      p <- p +
        ggplot2::geom_point( ggplot2::aes(y = target), size = 1.5 , shape = 24, fill = "black")
       interpretation <- "Indicator Value Interpretation: circle=Actual Reported Value,triangle=Target, color=Standard Acceptability Threshold"}
    
    
    
    p <- p +   
      ggplot2::geom_point( ggplot2::aes(y = actual ), 
                         size = 3.5, shape =  21, fill = "blue", alpha =0.7) + 
     # ggplot2::geom_point( ggplot2::aes(y = actual, color = unhcr_region), 
     #                      size = 3.5, shape =  21,  alpha =0.5) + 
      ggrepel::geom_label_repel(ggplot2::aes(y = actual,
                                            label = iso3c,
                                             color = unhcr_region),
                                            size = 3  ) +
      ggplot2::scale_color_manual(values = palette_unhcr_region,
                                 drop = TRUE,
                                 limits = force,
                                 na.value = "grey50") +
      ggplot2::guides(color = "none", fill = "none")  + 
      ggplot2::scale_x_continuous( label =  scales::label_number(accuracy = 1, 
                                      scale_cut = scales::cut_short_scale()) ) +
      ggplot2::scale_y_continuous( label =  scales::label_number(accuracy = 1, 
                                      scale_cut = scales::cut_short_scale())) +
      unhcrthemes::theme_unhcr(font_size = 14, 
                               axis_text_size = 9,
                               grid = "XY", 
                               axis = "y", legend = TRUE) +
      ggplot2::theme( legend.direction = "horizontal",
                      legend.box = "horizontal",
                      legend.position = "bottom") +
      ## Add  correlation 
      # ggplot2::annotate("text", 
      #                   x = max(dfall$sector_pct), 
      #                   y = max(dfall$actual), 
      #                   label = paste("Correlation [-1, 1] = ",
      #                                 round(cor(dfall$sector_pct, dfall$actual, method = "pearson"),2)), 
      #                   color = "gray95", 
      #                   hjust = 0, 
      #                   vjust = 1) +
      ggplot2::labs( y = "Indicator Value ",
                     x = "% of resource allocation (expenditure) spent on this outcome" ,
                     title = paste0("Results by Indicator vs Resources by Outcome |", year) ,
                     subtitle = stringr::str_wrap( 
                       paste0(  "\n Indicators: ", indicator,
                                " -/- Outcome: ", outcome,
                                " ---> Correlation [-1, 1] = ",
                                      round(cor(dfall$sector_pct, dfall$actual, method = "pearson"),2)
                                ) ,
                       100) ,
                     caption = stringr::str_wrap( paste0(
                       "Source: Data published by UNHCR as part of the International Aid Transparency Initiative (IATI))" ,
                       ". ---> ", 
                       interpretation),
                       110) )
    } else {
      ## Treat the case where we would light to highlight a specific country...
     if( ctr_name %in% dfall$ctr_name) {
  
      ## keep on the same group
      thisctr_name <- ctr_name
      thisgroup <- dfall |>
                 dplyr::filter( ctr_name == thisctr_name) |>
                 dplyr::pull(result_indicator_actual_value_1 )
      dfall2 <- dfall |>
                dplyr::filter( result_indicator_actual_value_1 %in% thisgroup  ) 
        
    
      p  <-  ggplot2::ggplot( dfall2, ggplot2::aes( x = sector_pct))  +
        ggplot2::geom_rect( data=  threshold, 
                            ggplot2::aes(xmin = xmin, xmax = xmax, 
                                         ymin = ymin, ymax = ymax, 
                                         fill = indlevel), 
                            inherit.aes = FALSE,
                            alpha = 0.4)  +
        ggplot2::guides(fill = "none") +
        ggplot2::scale_fill_manual(values = palette_level,
                                   drop = TRUE,
                                   limits = force,
                                   na.value = "grey50") +
        ggplot2::facet_wrap( ggplot2::vars(result_indicator_actual_value_1), 
                             labeller = ggplot2::labeller(result_indicator_actual_value_1 = ggplot2::label_wrap_gen(20))) +
        ggplot2::geom_segment(ggplot2::aes(x = sector_pct, 
                                           y = baseline, 
                                           xend = sector_pct, 
                                           yend = target), 
                              color = "black") +
        # ggplot2::geom_smooth(ggplot2::aes(y = actual), method = "loess", span = 0.05, alpha =0.25) +
        #ggplot2::geom_smooth(method="auto", se=TRUE, fullrange=FALSE, level=0.95) +
        ggplot2::geom_point( ggplot2::aes(y = baseline), size = 1.5, shape = 22, fill = "black") +
        ggplot2::geom_point( ggplot2::aes(y = actual), 
                             size = 3.5, shape =  21, fill = "blue", alpha =0.5) +
        ggplot2::geom_point( ggplot2::aes(y = target), size = 1.5 , shape = 24, fill = "black") +
        ggrepel::geom_label_repel( data = dfall2 |>
                                   dplyr::filter( !(ctr_name == thisctr_name)),
                                   ggplot2::aes(y = actual,
                                               label = iso3c),
                                  size = 2  ) +
        ggrepel::geom_label_repel(data = dfall2 |>
                                    dplyr::filter( ctr_name == thisctr_name),
                                  ggplot2::aes(y = actual,
                                               label = thisctr_name),
                                  fill = "yellow",
                                  size = 4  ) +
        ggplot2::guides(color = "none")  + 
        ggplot2::scale_x_continuous( label =  scales::label_number(accuracy = 1, 
                                                                   scale_cut = scales::cut_short_scale(),
                                                                   suffix = "%") ) +
        ggplot2::scale_y_continuous( label =  scales::label_number(accuracy = 1, 
                                                                   scale_cut = scales::cut_short_scale())) +
        unhcrthemes::theme_unhcr(font_size = 14, 
                                 axis_text_size = 9,
                                 grid = "XY", 
                                 axis = "y", legend = TRUE) +
        ggplot2::theme( legend.direction = "horizontal",
                        legend.box = "horizontal",
                        legend.position = "bottom") +
        ggplot2::labs( y = "Value: square=baseline, circle=Actual, triangle=Target, color=Standard Acceptability Threshold ",
                       x = "% of resource allocation (expenditure) spent on this outcome" ,
                       title = paste0("Results by Indicator vs Resources by Outcome |", year) ,
                       subtitle = stringr::str_wrap( 
                         paste0(  "\n Indicators: ", indicator,
                                  "-/- Outcome: ", outcome ) ,
                         100) ,
                       caption = stringr::str_wrap(
                         "Source: Data published by UNHCR as part of the International Aid Transparency Initiative (IATI))" ,
                         110) )  
      
      
    } else {
      
      info <- paste0("Missing value for either Actual, Baseline or target \n",
                     "\n  for indicator: \n  ", 
                     indicator, 
                     "\n in  \n ", 
                       ctr_name,  "  " )
      p  <- ggplot2::ggplot() +  
        ggplot2::annotate("text",  x = 1, y = 1, size = 4,
                          label = info ) +  
        ggplot2::theme_void()
      
    }
      
    }
    
    
  } 
    
    
  return(p)
} 
```
  
```{r example-compare_resource_result, message=FALSE, warning=FALSE, fig.retina = 2, fig.width = 12, fig.asp = 0.618, fig.align = "center",  out.width = "90%"}
# # See a list of indicators per area of work
# list_indic <- iati::mapping_indicator |> 
#                  janitor::clean_names() |>
#                  dplyr::filter( results_level =="Outcome") |>
#                  dplyr::left_join(iati::mapping_result |> 
#                                     dplyr::select(sector_rbm, area_id) |>
#                                     dplyr::distinct(), by = c("area_id")) |>
#                  dplyr::select(area_id, sector_rbm, indicator)
# #knitr::kable(list_indic)  
# 
# compare_resource_result(year =   2024, 
#                         show_baseline = TRUE,
#                         show_target = TRUE,
#       indicator = "13.2. Proportion of PoC who self-report positive changes in their income compared to previous year.",
#       outcome = "OA8: Well-Being and Basic Needs")
# 
# compare_resource_result(year =   2024, 
#        ctr_name = "Costa Rica",
#        indicator = "13.2. Proportion of PoC who self-report positive changes in their income compared to previous year.",
#        outcome = "OA8: Well-Being and Basic Needs")
# 
# 
# compare_resource_result(year =   2024, 
#        pop_type = "Refugees and Asylum-seekers",
#        indicator = "13.2. Proportion of PoC who self-report positive changes in their income compared to previous year.",
#        outcome = "OA8: Well-Being and Basic Needs")
```
  
```{r tests-compare_resource_result}
test_that("compare_resource_result works", {
  expect_true(inherits(compare_resource_result, "function")) 
})
```
  

# Using `iati::dataBudget`

## show_expenditure

 *  How much __expenditures compare to the initial budget__ (potentially weighted by # )?   
    
```{r function-show_expenditure}
#' show_expenditure
#' 
#' How much expenditures compare to the initial budget (potentially weighted by #)?   
#' 
#' @param year A numeric value or a vector of numeric value to filter on year. Note that data pre-2022 are using a different set of indicators
#' @param programme_lab A character vector corresponding to the name of the programme.
#' @param iati_identifier_ops A character vector corresponding to the name of the operation.
#' @param ctr_name A character vector corresponding to the name of the country.
#' @param weight_by list of population group to weight the budget - "all" or any of
#'                   "refugees", "asylum_seekers",
#'                    "returned_refugees" "idps",
#'                    "returned_idps", "stateless", 
#'                    "ooc", "oip"  
#'                   default is null.
#' 
#' @import ggplot2
#' @import dplyr
#' @import tidyselect
#' @import scales
#' @import unhcrthemes
#' @import refugees
#'
#' @export 
#' @return  a graph
show_expenditure <- function(year, 
                        programme_lab = NULL, 
                        iati_identifier_ops = NULL, 
                        ctr_name = NULL ,
                        weight_by = NULL) {
  
  
  # Check if only one argument is passed 
  if (!is.null(programme_lab) && !is.null(iati_identifier_ops)) {
    stop("Please pass only one of the arguments programme_lab or iati_identifier_ops.")
  } else if (!is.null(programme_lab) && !is.null(ctr_name)) {
    stop("Please pass only one of the arguments programme_lab or ctr_name.")
  } else if (!is.null(iati_identifier_ops) && !is.null(ctr_name)) {
    stop("Please pass only one of the arguments iati_identifier_ops or ctr_name.")
  }
  
  df0 <-  iati::dataTransaction |> 
         dplyr::left_join(iati::dataActivity, by= c("iati_identifier"))  
  
  dfB <- iati::dataBudget |> 
         dplyr::left_join(iati::dataActivity, by= c("iati_identifier")) |>
         dplyr::rename("year_iati" = "year")|>
         dplyr::mutate(year = lubridate::year(lubridate::as_date(budget_period_start)))
  
  if (!is.null(programme_lab)) {
    thisprogramme_lab <- programme_lab
    thisyear <-  year 
    df <- df0 |>  
      dplyr::filter( programmme_lab == thisprogramme_lab &
            year %in% thisyear & 
             transaction_type_name ==  "Expenditure")|> 
        dplyr::group_by(iati_identifier, year) |>
        dplyr::summarise(expenditure= sum(transaction_value, na.rm = TRUE))
    df1 <- df0 |>  
      dplyr::filter( programmme_lab == thisprogramme_lab &
            year %in% thisyear & 
             transaction_type_name ==  "Incoming Commitment")|> 
        dplyr::group_by(iati_identifier, year ) |>
        dplyr::summarise(commitment = sum(transaction_value_USD, na.rm = TRUE))
   dfB <- dfB |> 
      dplyr::filter( programmme_lab == thisprogramme_lab &
            year %in% thisyear  ) |> 
                          dplyr::mutate(budget_value= as.numeric(budget_value)) |>
                          dplyr::group_by(iati_identifier) |>
                          dplyr::summarise(budget_value= sum(budget_value, na.rm = TRUE))
  } else if (!is.null(iati_identifier_ops)) {
    thisiati_identifier_ops <- iati_identifier_ops
    thisyear <-  year 
    df <- df0 |> 
      dplyr::filter(iati_identifier_ops == thisiati_identifier_ops &
            year %in% thisyear & 
             transaction_type_name ==  "Expenditure")|> 
        dplyr::group_by(iati_identifier, year) |>
        dplyr::summarise(expenditure= sum(transaction_value, na.rm = TRUE))
    df1 <- df0 |> 
      dplyr::filter(iati_identifier_ops == thisiati_identifier_ops &
            year %in% thisyear & 
             transaction_type_name ==  "Incoming Commitment")|> 
        dplyr::group_by(iati_identifier, year ) |>
        dplyr::summarise(commitment = sum(transaction_value_USD, na.rm = TRUE))
   dfB <- dfB |> 
      dplyr::filter( iati_identifier_ops == thisiati_identifier_ops  &
            year %in% thisyear  ) |> 
                          dplyr::mutate(budget_value= as.numeric(budget_value)) |>
                          dplyr::group_by(iati_identifier) |>
                          dplyr::summarise(budget_value= sum(budget_value, na.rm = TRUE))
  } else if (!is.null(ctr_name)) {
    thisctr_name <- ctr_name
    thisyear <-  year 
    df <- df0 |> 
      dplyr::filter( ctr_name == thisctr_name &
            year %in% thisyear & 
             transaction_type_name ==  "Expenditure")|> 
        dplyr::select(iati_identifier, year, transaction_value, transaction_value_USD) |>
        dplyr::group_by(iati_identifier, year) |>
        dplyr::summarise(expenditure= sum(transaction_value , na.rm = TRUE))
    df1 <- df0 |> 
      dplyr::filter( ctr_name == thisctr_name &
            year %in% thisyear & 
             transaction_type_name ==  "Incoming Commitment") |> 
        dplyr::group_by(iati_identifier, year) |>
        dplyr::summarise(commitment = sum(transaction_value_USD, na.rm = TRUE))
   dfB <- dfB |> 
      dplyr::filter( ctr_name == thisctr_name &
            year %in% thisyear  ) |> 
                          dplyr::mutate(budget_value= as.numeric(budget_value)) |>
                          dplyr::group_by(iati_identifier) |>
                          dplyr::summarise(budget_value= sum(budget_value, na.rm = TRUE))
  }
    
  
   df2 <-  df1   |>  
        dplyr::left_join(df |> dplyr::select(- year), by = c("iati_identifier")) |>
        dplyr::left_join( dfB , by= c("iati_identifier"))  |>
        dplyr::select(iati_identifier, year,  budget_value,   expenditure, commitment ) 
   
    # Error catching -- Check if we weight
    #weight_by <-  c("refugees", "oip") 
    #weight_by <-  c("refugees", "oidp")
   
    if (  !is.null(weight_by) &&  !all(weight_by %in% c("all",
                                                        "refugees", "asylum_seekers",
                                                   "returned_refugees", "idps",
                                                   "returned_idps", "stateless", 
                                                   "ooc", "oip"  ))  ) {
     stop("weight_by is used but the population filter is not correctly set up...\n
          it should be among: all or a combination of  refugees, asylum_seekers, 
          returned_refugees, idps,
          returned_idps, stateless,  ooc, oip")
    } 
   
   ## if "all"  
   if (  !is.null(weight_by) &&  "all" %in% weight_by ) { 
     weight_by <- c("refugees", "asylum_seekers",
                    "returned_refugees", "idps",
                    "returned_idps", "stateless", 
                    "ooc", "oip"  )} else {  weight_by <- weight_by }
                                                        
   ## Calculate weight
   if (!is.null(weight_by) && !is.null(ctr_name) ) {
     ctrstat <- refugees::population |>
            dplyr::filter( year>= thisyear & 
                             coa_name == thisctr_name) |>
            dplyr::group_by(year, coa_name) |>
            dplyr::summarise(refugees = sum(refugees, na.rm = TRUE),
                             asylum_seekers = sum(asylum_seekers, na.rm = TRUE),
                              returned_refugees = sum(returned_refugees, na.rm = TRUE),
                              idps = sum(idps, na.rm = TRUE),
                              returned_idps = sum(returned_idps , na.rm = TRUE),
                              stateless = sum(stateless, na.rm = TRUE),
                              ooc = sum( ooc, na.rm = TRUE),
                              oip = sum(oip, na.rm = TRUE)) |>
            dplyr::select(year, coa_name, all_of(weight_by) ) |>
            dplyr::mutate(year = as.factor(year) ) |>
            dplyr::mutate( weight = rowSums(
                                   dplyr::across(tidyselect::where(is.numeric))))
     
     ## Refresh the value of weight_by
     
      df2 <-  df2 |>
        dplyr::left_join(ctrstat |> 
                         dplyr::select(year, weight)   , by = c("year")) |>
        dplyr::mutate(budget_value = round(budget_value / weight,1),   
                      expenditure = round(expenditure  / weight,1),   
                      commitment = round(commitment  / weight,1))
     
    } 
   
 subtitt <- if( is.null(weight_by)) {
   paste0("In ", programme_lab, ctr_name,iati_identifier_ops, "  ")
   } else {
   paste0("Weighted by total number of individual ", 
          paste(weight_by, collapse = ', '),
          " in ", 
          programme_lab, ctr_name,iati_identifier_ops, " ")
     }
 
 
 p <- df2 |> 
  #  dplyr::filter(expenditure_USD  <= 1000000 & expenditure_USD  > 1000) |> 
  ggplot2::ggplot(ggplot2::aes(x =  year, group = 1)) +
  ggplot2::geom_line(ggplot2::aes(y = budget_value,
                         color = "Budget"), linewidth = 1.5) +
  ggplot2::geom_line(ggplot2::aes(y =  commitment, 
                         color = "Commitment"), linewidth = 1.5) +
  ggplot2::geom_line(ggplot2::aes(y =  expenditure, 
                         color = "Expenditure"), linewidth = 1.5) +
  ggplot2::scale_color_manual(name = " ", 
                               values = c("Expenditure" = "#F592A0", 
                                          "Commitment" = "#4B4320",
                                          "Budget" = "#00568D")) +
  ggplot2::scale_y_continuous(
   # expand = ggplot2::expansion(mult = c(0, .1)),
    labels = scales::label_number(scale_cut = scales::cut_short_scale())  ) +
#  scale_x_continuous(labels = scales::label_number(scale_cut = cut_short_scale())) +
 # ggplot2::facet_wrap(~ trans_year) +
  unhcrthemes::theme_unhcr(grid = "Y", axis = "X", 
                           axis_title = "X", font_size = 18,
                           legend = FALSE) +
  ggplot2::labs(
    title = paste0("<span style='color:\"#00568D\"'>Budget</span>  vs <span style='color:\"#F592A0\"'>Expenditure</span> & <span style='color:\"#4B4320\"'>Incoming Commitment</span>  (in USD)"),
     subtitle = subtitt,
    x = "",
    y = "",
    caption = "Source: Data published by UNHCR as part of the International Aid Transparency Initiative (IATI). UNHCR budget is needs-based. It represents the total amount of money that would be required were UNHCR to meet all of the needs that it is seeking to address." ) 
 
  return(p)
}
```
  
```{r example-show_expenditure, message=FALSE, warning=FALSE, fig.retina = 2, fig.width = 8, fig.asp = 0.618, fig.align = "center",  out.width = "90%"}
show_expenditure(year = c(2022, 2023, 2024, 2025), 
             ctr_name = "Brazil")

show_expenditure(year = c(2022, 2023, 2024, 2025), 
             ctr_name = "Brazil",
             weight_by = c("refugees", "oip"))


show_expenditure(year = c(2022, 2023, 2024, 2025),
             ctr_name = "Argentina",
             weight_by =  "all" )

```
  
```{r tests-show_expenditure}
test_that("show_expenditure works", {
  expect_true(inherits(show_expenditure, "function")) 
})
```


## show_budget_gap
    
```{r function-show_budget_gap}
#' show_budget_gap
#' 
#' UNHCR budgets are needs-based: it represents the total amount
#' of money that would be required were UNHCR to meet all of the needs that it is seeking to address.
#' 
#' @param year A numeric value or a vector of numeric value to filter on year. Note that data pre-2022 are using a different set of indicators
#' @param programme_lab A character vector corresponding to the name of the programme.
#' @param iati_identifier_ops A character vector corresponding to the name of the operation.
#' @param ctr_name A character vector corresponding to the name of the country.
#' @param weight_by list of population group to weight the budget - 
#'                   "refugees", "asylum_seekers",
#'                    "returned_refugees" "idps",
#'                    "returned_idps", "stateless", 
#'                    "ooc", "oip"  
#'                   default is null.
#' 
#' @import ggplot2
#' @import dplyr
#' @import tidyselect
#' @import scales
#' @import unhcrthemes 
#'
#' @export 
#' @return  a graph
show_budget_gap <- function(year, 
                        programme_lab = NULL, 
                        iati_identifier_ops = NULL, 
                        ctr_name = NULL ,
                        weight_by = NULL ) {
  
  
  # Check if only one argument is passed 
  if (!is.null(programme_lab) && !is.null(iati_identifier_ops)) {
    stop("Please pass only one of the arguments programme_lab or iati_identifier_ops.")
  } else if (!is.null(programme_lab) && !is.null(ctr_name)) {
    stop("Please pass only one of the arguments programme_lab or ctr_name.")
  } else if (!is.null(iati_identifier_ops) && !is.null(ctr_name)) {
    stop("Please pass only one of the arguments iati_identifier_ops or ctr_name.")
  }
  
  df <-  iati::dataTransaction |> 
         dplyr::mutate(year = factor(year))|> 
         dplyr::left_join(iati::dataActivity, by= c("iati_identifier"))  
  
  if (!is.null(programme_lab)) {
    thisprogramme_lab <- programme_lab
    thisyear <-  year 
    df <- df |> 
      # levels(as.factor(df$programmme_lab))
      dplyr::filter( programmme_lab == thisprogramme_lab &
            year %in% thisyear & 
             transaction_type_name ==  "Expenditure")
  } else if (!is.null(iati_identifier_ops)) {
    thisiati_identifier_ops <- iati_identifier_ops
    thisyear <-  year 
    df <- df |> 
      dplyr::filter(iati_identifier_ops == thisiati_identifier_ops &
            year %in% thisyear & 
             transaction_type_name ==  "Expenditure")
  } else if (!is.null(ctr_name)) {
    thisctr_name <- ctr_name
    thisyear <-  year 
    df <- df |> 
      dplyr::filter( ctr_name == thisctr_name &
            year %in% thisyear & 
             transaction_type_name ==  "Expenditure")
  }
  
   df2 <-  df  |> 
        dplyr::group_by(iati_identifier, year) |>
        dplyr::summarise(transaction_value_USD= sum(transaction_value, na.rm = TRUE)) |>
        dplyr::left_join(iati::dataBudget |> 
                          dplyr::mutate(budget_value= as.numeric(budget_value)) |>
                          dplyr::group_by(iati_identifier) |>
                          dplyr::summarise(budget_value= sum(budget_value, na.rm = TRUE))  
                            , by= c("iati_identifier"))  |>
     dplyr::select(iati_identifier, year,budget_value,   transaction_value_USD )  |>
     dplyr::mutate(budget_gap = (budget_value - transaction_value_USD) / budget_value *100) 
   
 
   
    if (  !is.null(weight_by) &&  !all(weight_by %in% c("all",  "refugees", "asylum_seekers",
                                                   "returned_refugees", "idps",
                                                   "returned_idps", "stateless", 
                                                   "ooc", "oip"  ))  ) {
     stop("weight_by is used but the population filter is not correctly set up...\n
          it should be among: refugees, asylum_seekers, returned_refugees, idps,
          returned_idps, stateless,  ooc, oip")
    } 
    ## if "all"  
   if (  !is.null(weight_by) && "all" %in% weight_by) { 
     weight_by <- c("refugees", "asylum_seekers",
                    "returned_refugees", "idps",
                    "returned_idps", "stateless", 
                    "ooc", "oip"  )} else {  weight_by <- weight_by }
   
   ## Calculate weight
   if (!is.null(weight_by) && !is.null(ctr_name) ) {
     ctrstat <- refugees::population |>
            dplyr::filter( year>= thisyear & 
                             coa_name == thisctr_name) |>
            dplyr::group_by(year, coa_name) |>
            dplyr::summarise(refugees = sum(refugees, na.rm = TRUE),
                             asylum_seekers = sum(asylum_seekers, na.rm = TRUE),
                              returned_refugees = sum(returned_refugees, na.rm = TRUE),
                              idps = sum(idps, na.rm = TRUE),
                              returned_idps = sum(returned_idps , na.rm = TRUE),
                              stateless = sum(stateless, na.rm = TRUE),
                              ooc = sum( ooc, na.rm = TRUE),
                              oip = sum(oip, na.rm = TRUE)) |>
            dplyr::select(year, coa_name, all_of(weight_by) ) |>
            dplyr::mutate(year = as.factor(year) ) |>
            dplyr::mutate( weight = rowSums(
                                   dplyr::across(tidyselect::where(is.numeric))))
     
      df2 <-  df2 |>
        dplyr::left_join(ctrstat |> 
                         dplyr::select(year, weight)   , by = c("year")) |>
        dplyr::mutate(budget_value = round(budget_value / weight,1),   
                      transaction_value_USD = round(transaction_value_USD  / weight,1))
      df2 <-  df2 |>
       dplyr::mutate(budget_gap2 = (budget_value - transaction_value_USD) / budget_value *100) 
     
    } 
   
 subtitt <- if( is.null(weight_by)) {
   paste0("In ", programme_lab, ctr_name,iati_identifier_ops, "")
   } else {
   paste0("Weighted by total number of individual ", 
          paste(weight_by, collapse = ', '),
          " in ", 
          programme_lab, ctr_name,iati_identifier_ops, "")
     }
 
 p <- df2 |> 
#  dplyr::filter(transaction_value_USD   <= 1000000 & transaction_value_USD  > 1000) |> 
  ggplot2::ggplot(ggplot2::aes(x =  year, group = 1)) +
  ggplot2::geom_line(ggplot2::aes(y = budget_gap,
                         color = "Budget"),
                     linewidth = 1.5,
                     color = "#F592A0") +  
  ggplot2::scale_y_continuous(  limits=c(0,100)) +
  # ggplot2::scale_y_continuous(
  #   #expand = ggplot2::expansion(mult = c(0, .1)),
  #   labels = scales::label_number(scale_cut = scales::cut_short_scale())  ) +
#  scale_x_continuous(labels = scales::label_number(scale_cut = cut_short_scale())) +
 # ggplot2::facet_wrap(~ trans_year) +
  unhcrthemes::theme_unhcr(grid = "Y", axis = "X", 
                           axis_title = "X", font_size = 18,
                           legend = FALSE)+
  ggplot2::labs(
    title = paste0( "Budget Gap  (in %)"),
    subtitle =   subtitt ,
    x = "",
    y = "",
    caption = "Source: Data published by UNHCR as part of the International Aid Transparency Initiative (IATI). UNHCR budget is needs-based. It represents the total amount of money that would be required were UNHCR to meet all of the needs that it is seeking to address." ) 
 
  return(p)
    
}
```
  
```{r example-show_budget_gap, message=FALSE, warning=FALSE, fig.retina = 2, fig.width = 8, fig.asp = 0.618, fig.align = "center",  out.width = "90%"}
show_budget_gap(year = c(2022, 2023, 2024, 2025), 
             ctr_name = "Brazil")
show_budget_gap(year = c(2022, 2023, 2024, 2025), 
             ctr_name = "Brazil",
             weight_by = c("refugees", "oip"))
```
  
```{r tests-show_budget_gap}
test_that("show_budget_gap works", {
  expect_true(inherits(show_budget_gap, "function")) 
})
```
  

# Using  `iati::dataTransaction`

## Show donors 
 
 *  Who are the __main donors by country__ in terms of transaction?   

```{r function-show_donors, echo=FALSE, message=FALSE, warning=FALSE}
#' show_donors
#'
#' @description Who are the main donors by country in terms of transaction? 
#' 
#' @param year year to select starting from 2016 - could be one year or a list
#' @param programme_lab A character vector corresponding to the name of the programme.
#' @param iati_identifier_ops A character vector corresponding to the name of the operation.
#' @param ctr_name A character vector corresponding to the name of the country.
#' @param transaction_type_name Transaction type - default is "Incoming Commitment" ,
#'   can also be   "Disbursement", or "Expenditure"  
#' 
#' @import ggplot2
#' @import dplyr
#' @import scales
#' @import unhcrthemes
#'
#' @export 
#'
#' @return  a graph
show_donors <- function(year, 
                        programme_lab = NULL, 
                        iati_identifier_ops = NULL, 
                        ctr_name = NULL,
                        transaction_type_name = "Incoming Commitment"  ) {
  
  ## Check year is after or equal 2016
  
  
  # Check if only one argument is passed 
  if (!is.null(programme_lab) && !is.null(iati_identifier_ops)) {
    stop("Please pass only one of the arguments programme_lab or iati_identifier_ops.")
  } else if (!is.null(programme_lab) && !is.null(ctr_name)) {
    stop("Please pass only one of the arguments programme_lab or ctr_name.")
  } else if (!is.null(iati_identifier_ops) && !is.null(ctr_name)) {
    stop("Please pass only one of the arguments iati_identifier_ops or ctr_name.")
  }
  
  df <-  iati::dataTransaction |> 
         dplyr::left_join(iati::dataActivity, by= c("iati_identifier"))  
  
  ## Filtering
  if (!is.null(programme_lab)) {
    thisprogramme_lab <- programme_lab
    thisyear <-  year
    thistransaction_type_name <-  transaction_type_name
    df <- df |> 
      # levels(as.factor(df$programmme_lab))
      dplyr::filter( programmme_lab == thisprogramme_lab &
            year %in% thisyear & 
             transaction_type_name ==  thistransaction_type_name)
  } else if (!is.null(iati_identifier_ops)) {
    thisiati_identifier_ops <- iati_identifier_ops
    thisyear <-  year
    thistransaction_type_name <-  transaction_type_name
    df <- df |> 
      dplyr::filter(iati_identifier_ops == thisiati_identifier_ops &
            year %in% thisyear & 
             transaction_type_name ==  thistransaction_type_name)
  } else if (!is.null(ctr_name)) {
    thisctr_name <- ctr_name
    thisyear <-  year
    thistransaction_type_name <-  transaction_type_name
    df <- df |> 
      dplyr::filter( ctr_name == thisctr_name &
            year %in% thisyear & 
             transaction_type_name ==  thistransaction_type_name)
  }
   
 
  
  df1 <- df |> 
    dplyr::group_by(year, provider_org_type_name) |>
    dplyr::summarise( transaction_value_USD = sum(transaction_value_USD , na.rm = TRUE)) |>
    dplyr::mutate(provider_org_type_name = as.character(provider_org_type_name) )  |>
    dplyr::mutate(provider_org_type_name = as.factor(provider_org_type_name) ) 
  
  
    ## case there's no data at all
    if( nrow(df1) == 0) {
      info <-  paste0("No ", transaction_type_name, "\n  recorded   in ", 
                              programme_lab, ctr_name,iati_identifier_ops, "")
      p <- ggplot2::ggplot() +  
                     ggplot2::annotate("text",  x = 1, y = 1, size = 12,
                                          label = info ) +  
                     ggplot2::theme_void()
          
    } else if(nrow(df1)> 0) {
      
      
     p <- df1 |> 
    #  dplyr::filter(transaction_value_USD  <= 1000000 & transaction_value_USD  > 1000) |> 
      ggplot2::ggplot(ggplot2::aes(y = transaction_value_USD ,
                 x =  year,
                 fill = provider_org_type_name)) +
      ggplot2::geom_bar(alpha = 0.9, stat = "identity") +
      ggplot2::scale_fill_viridis_d(option = "inferno", na.value = "grey50") +
      ggplot2::scale_y_continuous(
        expand = ggplot2::expansion(mult = c(0, .1)),
        labels = scales::label_number(scale_cut = scales::cut_short_scale())  ) +
    #  scale_x_continuous(labels = scales::label_number(scale_cut = cut_short_scale())) +
     # ggplot2::facet_wrap(~ trans_year) +
      unhcrthemes::theme_unhcr(grid = "Y", axis = "X", axis_title = "X", font_size = 18)+
      ggplot2::labs(
        title = paste0(transaction_type_name," (in USD)"),
        subtitle = paste0("Recorded in ", programme_lab, ctr_name,iati_identifier_ops, " "),
        x = "",
        y = "",
        caption = "Source: Data published by UNHCR as part of the International Aid Transparency Initiative (IATI)" ) 
           }
 
  return(p)
}
```

```{r examples-show_donors, message=FALSE, warning=FALSE, fig.retina = 2, fig.width = 8, fig.asp = 0.618, fig.align = "center",  out.width = "90%"}
# knitr::kable(iati::dataTransaction |>
#                 dplyr::select( transaction_type_name, transaction_type_description) |>
#                 dplyr::distinct() )
show_donors(year = 2025,
           programme_lab = "The Americas",
           transaction_type_name = "Incoming Commitment" )
show_donors(year = c(2022, 2023, 2024, 2025),
           ctr_name = "Brazil",
           transaction_type_name = "Incoming Commitment" )
show_donors(year = c(2022, 2023, 2024, 2025),
           programme_lab = "Brazil",
           transaction_type_name = "Disbursement" )
show_donors(year = c(2022, 2023, 2024, 2025),
           programme_lab = "Brazil",
           transaction_type_name = "Expenditure" )
```

```{r tests-show_donors}
test_that("show_donors works", {
  expect_true(inherits(show_donors, "function")) 
})
```

## show_top_donors
    
```{r function-show_top_donors}
#' show_top_donors
#'
#' @description Who are the main donors by country in terms of transaction? 
#' 
#' @param year year to select starting from 2016 - could be one year or a list
#' @param programme_lab A character vector corresponding to the name of the programme.
#' @param iati_identifier_ops A character vector corresponding to the name of the operation.
#' @param ctr_name A character vector corresponding to the name of the country. 
#' @param top_n top n donors to show - the rest being lumped together
#' 
#' @import ggplot2
#' @import dplyr
#' @import scales
#' @import unhcrthemes
#'
#' @export 
#'
#' @return  a graph
show_top_donors <- function(year, 
                        programme_lab = NULL, 
                        iati_identifier_ops = NULL, 
                        ctr_name = NULL, 
                        top_n = 5) {
  
  ## Check year is after or equal 2016
  
  
  # Check if only one argument is passed 
  if (!is.null(programme_lab) && !is.null(iati_identifier_ops)) {
    stop("Please pass only one of the arguments programme_lab or iati_identifier_ops.")
  } else if (!is.null(programme_lab) && !is.null(ctr_name)) {
    stop("Please pass only one of the arguments programme_lab or ctr_name.")
  } else if (!is.null(iati_identifier_ops) && !is.null(ctr_name)) {
    stop("Please pass only one of the arguments iati_identifier_ops or ctr_name.")
  }
  
  df <-  iati::dataTransaction |> 
         dplyr::left_join(iati::dataActivity, by= c("iati_identifier"))  
  
  ## Filtering
  if (!is.null(programme_lab)) {
    thisprogramme_lab <- programme_lab
    thisyear <-  year 
    df <- df |> 
      # levels(as.factor(df$programmme_lab))
      dplyr::filter( programmme_lab == thisprogramme_lab &
            year == thisyear & 
             transaction_type_name ==  "Incoming Commitment")
  } else if (!is.null(iati_identifier_ops)) {
    thisiati_identifier_ops <- iati_identifier_ops
    thisyear <-  year 
    df <- df |> 
      dplyr::filter(iati_identifier_ops == thisiati_identifier_ops &
            year == thisyear & 
             transaction_type_name ==  "Incoming Commitment")
  } else if (!is.null(ctr_name)) {
    thisctr_name <- ctr_name
    thisyear <-  year 
    df <- df |> 
      dplyr::filter( ctr_name == thisctr_name &
            year == thisyear & 
             transaction_type_name == "Incoming Commitment")
  }
   
   
  df2 <- df |>
    dplyr::group_by(year, transaction_provider_org) |>
    dplyr::summarise( transaction_value_USD = sum(transaction_value_USD , na.rm = TRUE)) |>
    dplyr::mutate( transaction_provider_org = as.character(transaction_provider_org) )  |>
    dplyr::mutate( transaction_provider_org = as.factor(transaction_provider_org) )  |>
    dplyr::mutate( transaction_provider_org = forcats::fct_lump_n(
        f = transaction_provider_org,
        n = top_n,  #### Parameter
        w = transaction_value_USD,
        other_level = 'Other Partners',
        ties.method = "last")    ) |>
    dplyr::group_by(year, transaction_provider_org) |>
    dplyr::summarise( transaction_value_USD = sum(transaction_value_USD , na.rm = TRUE)) |>
    dplyr::mutate(transaction_provider_org = as.character(transaction_provider_org) )  |>
    dplyr::mutate(transaction_provider_org = as.factor(transaction_provider_org) )
  
  #levels(as.factor(df2$transaction_provider_org))

  
 p <- df2 |> 
#  dplyr::filter(transaction_value_USD  <= 1000000 & transaction_value_USD  > 1000) |> 
  ggplot2::ggplot(ggplot2::aes(y = transaction_value_USD ,
             x = stats::reorder( transaction_provider_org, transaction_value_USD) )) +
  ggplot2::geom_bar(alpha = 0.9, stat = "identity", fill = "#0072BC") +
  ggplot2::coord_flip() +
  ggplot2::scale_y_continuous(
    expand = ggplot2::expansion(mult = c(0, .1)),
    labels = scales::label_number(scale_cut = scales::cut_short_scale())  ) +
#  scale_x_continuous(labels = scales::label_number(scale_cut = cut_short_scale())) +
 # ggplot2::facet_wrap(~ trans_year) +
  unhcrthemes::theme_unhcr(grid = "X", axis = "X", axis_title = "X", font_size = 18)+
  ggplot2::labs(
    title = paste0("Top ",top_n ," donors (in USD)"),
    subtitle = paste0("Incoming Commitment Recorded in ", programme_lab, ctr_name,iati_identifier_ops, " | ", year,""),
    x = "",
    y = "",
    caption = "Source: Data published by UNHCR as part of the International Aid Transparency Initiative (IATI)" ) 
 
  return(p)
}
```
  
```{r example-show_top_donors, message=FALSE, warning=FALSE, fig.retina = 2, fig.width = 8, fig.asp = 0.618, fig.align = "center",  out.width = "90%"}
show_top_donors(year = 2025,
           ctr_name = "Brazil", 
           top_n = 5)

```
  
```{r tests-show_donor_funding_over_times}
test_that("show_donor_funding_over_time works", {
  expect_true(inherits(show_donor_funding_over_time, "function")) 
})
```

## show_earmarking

 *  Whats the breakdown of __Earmarking Type__ (Un-earmarked, Tightly earmarked, etc.) from Donor Funds by Year?  
 
    
```{r function-show_earmarking}
#' Title
#' 
#' @description Whats the breakdown of Earmarking Type (Un-earmarked, Tightly earmarked, etc.) \
#'  from Donor Funds by Year?  
#'  Where possible, UNHCR prefers to receive unearmarked funds, as this allows the agency 
#'  greater flexibility in allocating its resources as new needs emerge during the course of the year. 
#'  Should that not be possible, funds can also be softly earmarked. This could mean funds that 
#'  can be spent anywhere within a region or for a particular situation (for example, funds that have 
#'  to be spent to assist refugees from Syria, but which can be spent in any country hosting such 
#'  refugees). Earmarked funds would be a contribution that corresponds to a specific country but 
#'  can be spent on anything within that operations programme. Finally, tightly earmarked funds 
#'  are those that specify an activity or a population within a countrys programme.
#'  
#'  UNHCR charges an ISC -  Indirect Support Costs - rate of 6.5% on all of its earmarked contributions.
#'   This covers management and administration  costs at HQ and programme support costs 
#'   incurred at HQ and Regional Bureaux. 
#' 
#' @param year A numeric value or a vector of numeric value to filter on year. Note that data pre-2022 are using a different set of indicators
#' @param programme_lab A character vector corresponding to the name of the programme.
#' @param iati_identifier_ops A character vector corresponding to the name of the operation.
#' @param ctr_name A character vector corresponding to the name of the country.
#' 
#' @import ggplot2
#' @import dplyr
#' @import scales
#' @import unhcrthemes
#'
#' @export 
#' @return  a graph
show_earmarking <- function(year, 
                        programme_lab = NULL, 
                        iati_identifier_ops = NULL, 
                        ctr_name = NULL  ) {
  
  
  # Check if only one argument is passed 
  if (!is.null(programme_lab) && !is.null(iati_identifier_ops)) {
    stop("Please pass only one of the arguments programme_lab or iati_identifier_ops.")
  } else if (!is.null(programme_lab) && !is.null(ctr_name)) {
    stop("Please pass only one of the arguments programme_lab or ctr_name.")
  } else if (!is.null(iati_identifier_ops) && !is.null(ctr_name)) {
    stop("Please pass only one of the arguments iati_identifier_ops or ctr_name.")
  }
  
  df <-  iati::dataTransaction |> 
         dplyr::left_join(iati::dataActivity, by= c("iati_identifier"))  
  
  if (!is.null(programme_lab)) {
    thisprogramme_lab <- programme_lab
    thisyear <-  year 
    df <- df |> 
      # levels(as.factor(df$programmme_lab))
      dplyr::filter( programmme_lab == thisprogramme_lab &
            year %in% thisyear & 
             transaction_type_name ==  "Incoming Commitment")
  } else if (!is.null(iati_identifier_ops)) {
    thisiati_identifier_ops <- iati_identifier_ops
    thisyear <-  year 
    df <- df |> 
      dplyr::filter(iati_identifier_ops == thisiati_identifier_ops &
            year %in% thisyear & 
             transaction_type_name ==  "Incoming Commitment")
  } else if (!is.null(ctr_name)) {
    thisctr_name <- ctr_name
    thisyear <-  year 
    df <- df |> 
      dplyr::filter( ctr_name == thisctr_name &
            year %in% thisyear & 
             transaction_type_name ==  "Incoming Commitment")
  }
  # levels(as.factor(df$earmarking_name)) 
  
  df2 <- df |> 
    dplyr::group_by(year, earmarking_name) |>
    dplyr::summarise( transaction_value_USD = sum(transaction_value_USD , na.rm = TRUE)) |>
    dplyr::mutate(earmarking_name = as.character(earmarking_name) )  |>
    dplyr::mutate(earmarking_name = as.factor(earmarking_name) ) 
  
 
  palette_earmarking <- c("Earmarked" = "#e1cc0d",
                    "Softly Earmarked" = "#0072bc", 
                    "Tightly Earmarked" = "#ef4a60", 
                    "Unearmarked" = "#00b398" )
  
 p <- df2 |> 
#  dplyr::filter(transaction_value_USD  <= 1000000 & transaction_value_USD  > 1000) |> 
  ggplot2::ggplot(ggplot2::aes(y = transaction_value_USD ,
             x =  year,
             fill = earmarking_name)) +
  ggplot2::geom_bar(alpha = 0.9, stat = "identity") +
  #ggplot2::scale_fill_viridis_d(option = "inferno", na.value = "grey50") +
  ggplot2::scale_fill_manual(values = palette_earmarking,
                      drop = TRUE,
                      limits = force,
                      na.value = "grey50") +
  ggplot2::scale_y_continuous(
    expand = ggplot2::expansion(mult = c(0, .1)),
    labels = scales::label_number(scale_cut = scales::cut_short_scale())  ) +
#  scale_x_continuous(labels = scales::label_number(scale_cut = cut_short_scale())) +
 # ggplot2::facet_wrap(~ trans_year) +
  unhcrthemes::theme_unhcr(grid = "Y", axis = "X", axis_title = "X", font_size = 18)+
  ggplot2::labs(
    title = paste0("Earmarking in Commitment (in USD)"),
    subtitle = paste0("Recorded in ", programme_lab, ctr_name,iati_identifier_ops, ""),
    x = "",
    y = "",
    caption = "Source: Data published by UNHCR as part of the International Aid Transparency Initiative (IATI)" ) 
 
  return(p) 
}
```
  
```{r example-show_earmarking, message=FALSE, warning=FALSE, fig.retina = 2, fig.width = 8, fig.asp = 0.618, fig.align = "center",  out.width = "90%"}
# knitr::kable(iati::dataTransaction |>
#                 dplyr::select(earmarking_name, earmarking_description)  |>
#                 dplyr::distinct() |>
#                 dplyr::filter(!(is.na(earmarking_name))))
show_earmarking(year = c(2022, 2023, 2024, 2025),  
             ctr_name = "Brazil")
```
  
```{r tests-show_earmarking}
test_that("show_earmarking works", {
  expect_true(inherits(show_earmarking, "function")) 
})
```
  

## show_contributions
    
```{r function-show_contributions}
#' Title
#' 
#' @description Whats the breakdown by contribution Type (Un-earmarked, Tightly earmarked, etc.) from Donor Funds by Year?  
#' 
#' @param year A numeric value or a vector of numeric value to filter on year. Note that data pre-2022 are using a different set of indicators
#' @param programme_lab A character vector corresponding to the name of the programme.
#' @param iati_identifier_ops A character vector corresponding to the name of the operation.
#' @param ctr_name A character vector corresponding to the name of the country.
#' 
#' @import ggplot2
#' @import dplyr
#' @import scales
#' @import unhcrthemes
#'
#' @export 
#' @return  a graph
show_contributions <- function(year, 
                        programme_lab = NULL, 
                        iati_identifier_ops = NULL, 
                        ctr_name = NULL  ) {
  
  
  # Check if only one argument is passed 
  if (!is.null(programme_lab) && !is.null(iati_identifier_ops)) {
    stop("Please pass only one of the arguments programme_lab or iati_identifier_ops.")
  } else if (!is.null(programme_lab) && !is.null(ctr_name)) {
    stop("Please pass only one of the arguments programme_lab or ctr_name.")
  } else if (!is.null(iati_identifier_ops) && !is.null(ctr_name)) {
    stop("Please pass only one of the arguments iati_identifier_ops or ctr_name.")
  }
  
  df <-  iati::dataTransaction |> 
         dplyr::left_join(iati::dataActivity, by= c("iati_identifier"))  
  
  if (!is.null(programme_lab)) {
    thisprogramme_lab <- programme_lab
    thisyear <-  year 
    df <- df |> 
      # levels(as.factor(df$programmme_lab))
      dplyr::filter( programmme_lab == thisprogramme_lab &
            year %in% thisyear & 
             transaction_type_name ==  "Incoming Commitment")
  } else if (!is.null(iati_identifier_ops)) {
    thisiati_identifier_ops <- iati_identifier_ops
    thisyear <-  year 
    df <- df |> 
      dplyr::filter(iati_identifier_ops == thisiati_identifier_ops &
            year %in% thisyear & 
             transaction_type_name ==  "Incoming Commitment")
  } else if (!is.null(ctr_name)) {
    thisctr_name <- ctr_name
    thisyear <-  year 
    df <- df |> 
      dplyr::filter( ctr_name == thisctr_name &
            year %in% thisyear & 
             transaction_type_name ==  "Incoming Commitment")
  }
   
  df2 <- df |> 
    dplyr::group_by(year, aid_type1_name) |>
    dplyr::summarise( transaction_value_USD = sum(transaction_value_USD , na.rm = TRUE)) |>
    dplyr::mutate(aid_type1_name = as.character(aid_type1_name) )  |>
    dplyr::mutate(aid_type1_name = as.factor(aid_type1_name) ) 
  
 p <- df2 |> 
#  dplyr::filter(transaction_value_USD  <= 1000000 & transaction_value_USD  > 1000) |> 
  ggplot2::ggplot(ggplot2::aes(y = transaction_value_USD ,
             x =  year,
             fill = aid_type1_name)) +
  ggplot2::geom_bar(alpha = 0.9, stat = "identity") +
  ggplot2::scale_fill_viridis_d(option = "inferno", na.value = "grey50") +
  ggplot2::scale_y_continuous(
    expand = ggplot2::expansion(mult = c(0, .1)),
    labels = scales::label_number(scale_cut = scales::cut_short_scale())  ) +
#  scale_x_continuous(labels = scales::label_number(scale_cut = cut_short_scale())) +
 # ggplot2::facet_wrap(~ trans_year) +
  unhcrthemes::theme_unhcr(grid = "Y", axis = "X", axis_title = "X", font_size = 18)+
  ggplot2::labs(
    title = paste0("Commitment vs Contribution type (in USD)"),
    subtitle = paste0("Recorded in ", programme_lab, ctr_name,iati_identifier_ops, ""),
    x = "",
    y = "",
    caption = "Source: Data published by UNHCR as part of the International Aid Transparency Initiative (IATI)" ) 
 
  return(p) 
}
```
  
```{r example-show_contributions, message=FALSE, warning=FALSE, fig.retina = 2, fig.width = 8, fig.asp = 0.618, fig.align = "center",  out.width = "90%"}
# knitr::kable(iati::dataTransaction |>
#                 dplyr::select(aid_type1_name, aid_type1_description)  |>
#                 dplyr::distinct() |>
#                 dplyr::filter(!(is.na(aid_type1_name))))
show_contributions(year = c(2022, 2023, 2024, 2025), 
                   ctr_name = "Brazil") 
show_contributions(year = c(2022, 2023, 2024, 2025), 
                   programme_lab = "The Americas") 
```
  
```{r tests-show_contributions}
test_that("show_contributions works", {
  expect_true(inherits(show_contributions, "function")) 
})
```


## show_transaction_flow
    
```{r function-show_transaction_flow}
#' show_transaction_flow
#' 
#' Flow diagramme of transations
#' 
#' 
#' @param year A numeric value or a vector of numeric value to filter on year. Note that data pre-2022 are using a different set of indicators
#' @param programme_lab A character vector corresponding to the name of the programme.
#' @param iati_identifier_ops A character vector corresponding to the name of the operation.
#' @param ctr_name A character vector corresponding to the name of the country.
#' @param top_n top n donors to show - the rest being lumped together default is 10
#' 
#' @import ggplot2
#' @import dplyr
#' @import scales
#' @import unhcrthemes
#' @import ggsankey
#'
#' @export 
#' @return  a graph
show_transaction_flow <- function(year, 
                        programme_lab = NULL, 
                        iati_identifier_ops = NULL, 
                        ctr_name = NULL,
                        top_n = 10) {
  
  
  # Check if only one argument is passed 
  if (!is.null(programme_lab) && !is.null(iati_identifier_ops)) {
    stop("Please pass only one of the arguments programme_lab or iati_identifier_ops.")
  } else if (!is.null(programme_lab) && !is.null(ctr_name)) {
    stop("Please pass only one of the arguments programme_lab or ctr_name.")
  } else if (!is.null(iati_identifier_ops) && !is.null(ctr_name)) {
    stop("Please pass only one of the arguments iati_identifier_ops or ctr_name.")
  }
  
  df <-  iati::dataTransaction |> 
         dplyr::left_join(iati::dataActivity, by= c("iati_identifier"))  
  
  if (!is.null(programme_lab)) {
    thisprogramme_lab <- programme_lab
    thisyear <-  year 
    df <- df |> 
      # levels(as.factor(df$programmme_lab))
      dplyr::filter( programmme_lab == thisprogramme_lab &
            year %in% thisyear & 
             transaction_type_name ==  "Incoming Commitment")
  } else if (!is.null(iati_identifier_ops)) {
    thisiati_identifier_ops <- iati_identifier_ops
    thisyear <-  year 
    df <- df |> 
      dplyr::filter(iati_identifier_ops == thisiati_identifier_ops &
            year %in% thisyear & 
             transaction_type_name ==  "Incoming Commitment")
  } else if (!is.null(ctr_name)) {
    thisctr_name <- ctr_name
    thisyear <-  year 
    df <- df |> 
      dplyr::filter( ctr_name == thisctr_name &
            year %in% thisyear & 
             transaction_type_name ==  "Incoming Commitment")
  }
 
  df11 <- df |>
        dplyr::mutate( transaction_provider_org = as.character(transaction_provider_org) )  |>
        dplyr::mutate( transaction_provider_org = as.factor(transaction_provider_org) )  |>
        dplyr::mutate( transaction_provider_org = forcats::fct_lump_n(
            f = transaction_provider_org,
            n = top_n,  #### Parameter
            w = transaction_value_USD,
            other_level = 'Other Partners',
            ties.method = "last")    ) |>
        dplyr::group_by(year, transaction_provider_org, earmarking_name,provider_org_type_name ) |>
        dplyr::summarise( transaction_value_USD = sum(transaction_value_USD , na.rm = TRUE)) |>
        dplyr::mutate(transaction_provider_org = as.character(transaction_provider_org) )  |>
        dplyr::mutate(transaction_provider_org = as.factor(transaction_provider_org) ) |>
        dplyr::ungroup() 
  
  ## Add summary total for each node to make the diagram

   
   
  year <-  df11 |>
     dplyr::group_by(year) |>
     dplyr::summarise( transaction_value_USD = sum(transaction_value_USD , na.rm = TRUE)) |>
     dplyr::mutate(Year = glue::glue('{year}: {scales::label_number(accuracy = .2, scale_cut = scales::cut_short_scale())(transaction_value_USD)}$') ) |>
    dplyr::select( - transaction_value_USD )
    
  
  
   transaction_provider_org <-  df11 |>
     dplyr::group_by( transaction_provider_org) |>
     dplyr::summarise( transaction_value_USD = sum(transaction_value_USD , na.rm = TRUE)) |>
     dplyr::mutate( Provider = glue::glue('{transaction_provider_org}: {scales::label_number(accuracy = .2, scale_cut = scales::cut_short_scale())(transaction_value_USD)}$') )|>
    dplyr::select( - transaction_value_USD )
  
  
  earmarking_name <-  df11 |>
     dplyr::group_by(earmarking_name) |>
     dplyr::summarise( transaction_value_USD = sum(transaction_value_USD , na.rm = TRUE)) |>
     dplyr::mutate(Earmarking = glue::glue('{earmarking_name}: {scales::label_number(accuracy = .2, scale_cut = scales::cut_short_scale())(transaction_value_USD)}$') )|>
    dplyr::select( - transaction_value_USD )
  
  
  provider_org_type_name <-  df11 |>
     dplyr::group_by(provider_org_type_name) |>
     dplyr::summarise( transaction_value_USD = sum(transaction_value_USD , na.rm = TRUE)) |>
     dplyr::mutate(Type = glue::glue('{provider_org_type_name}: {scales::label_number(accuracy = .2, scale_cut = scales::cut_short_scale())(transaction_value_USD)}$') )|>
    dplyr::select( - transaction_value_USD )
     
    df12 <- df11 |>
          dplyr::left_join( year, by = c("year") ) |> 
          dplyr::left_join(  transaction_provider_org, by = c("transaction_provider_org") ) |> 
          dplyr::left_join( earmarking_name, by = c("earmarking_name") ) |> 
          dplyr::left_join( provider_org_type_name, by = c("provider_org_type_name") ) 
               
  
   df1 <- df12 |>
         ggsankey::make_long(Earmarking, 
                      Year, 
                      Provider, 
                      Type,
                      value = transaction_value_USD)
  
  

  p <- ggplot2::ggplot(df1, 
              ggplot2::aes(x = x,
                 next_x = next_x,
                 node = node,
                 next_node = next_node,
                 fill = factor(node),
                 value = value,
                 label = node)) +
        ggsankey::geom_sankey(flow.alpha = 0.5, node.color = 1) +
        ggsankey::geom_sankey_label(size = 3.5, color = 1, fill = "white") +
        ggplot2::scale_fill_viridis_d() +
        ggsankey::theme_sankey(base_size = 12) +
        unhcrthemes::theme_unhcr(font_size = 18, grid = FALSE, axis = FALSE,  legend = FALSE)   +
        ggplot2::theme(axis.text.y = ggplot2::element_blank()) + 
        ggplot2::labs(
              x = "",
              y = "",
              title = stringr::str_wrap(paste0("Commitment | ", programme_lab, ctr_name,iati_identifier_ops, "" ), 60),
              subtitle = stringr::str_wrap(paste0(" "), 80),
              caption = "Source: Data published by UNHCR as part of the International Aid Transparency Initiative (IATI)" )  
  
  return(p)
    
}
```
  
```{r example-show_transaction_flow}
show_transaction_flow(year = c(2022, 2023, 2024, 2025), 
                   ctr_name = "Brazil")

show_transaction_flow(year = 2023, 
                   ctr_name = "Brazil")
```
  
```{r tests-show_transaction_flow}
test_that("show_transaction_flow works", {
  expect_true(inherits(show_transaction_flow, "function")) 
})
```
  

  
# Using `iati::dataParticipating_org`

## show_partnership
 
 *  How __organisations partner together__?   
 

```{r function-show_partnership, echo=FALSE, message=FALSE, warning=FALSE}
#' show_partnership
#' 
#' @description How organisations partner together? 
#'
#' @param year A numeric value corresponding to the year to be displayed
#' @param programme_lab A character vector corresponding to the name of the programme.
#' @param iati_identifier_ops A character vector corresponding to the name of the operation.
#' @param ctr_name A character vector corresponding to the name of the country.
#' 
#' @import ggplot2
#' @import dplyr
#' @import scales
#' @import unhcrthemes
#'
#' @export 
#' @return  a graph
show_partnership <- function( year, 
                        programme_lab = NULL, 
                        iati_identifier_ops = NULL, 
                        ctr_name = NULL  ) {
  
  
  # Check if only one argument is passed 
  if (!is.null(programme_lab) && !is.null(iati_identifier_ops)) {
    stop("Please pass only one of the arguments programme_lab or iati_identifier_ops.")
  } else if (!is.null(programme_lab) && !is.null(ctr_name)) {
    stop("Please pass only one of the arguments programme_lab or ctr_name.")
  } else if (!is.null(iati_identifier_ops) && !is.null(ctr_name)) {
    stop("Please pass only one of the arguments iati_identifier_ops or ctr_name.")
  }
  
  df <-  iati::dataParticipating_org |> 
         dplyr::left_join(iati::dataActivity, by= c("iati_identifier"))  
  
  if (!is.null(programme_lab)) {
    thisprogramme_lab <- programme_lab
    thisyear <-  year
    df <- df |> 
      # levels(as.factor(df$programmme_lab))
      dplyr::filter( programmme_lab == thisprogramme_lab &
            year == thisyear )
  } else if (!is.null(iati_identifier_ops)) {
    thisiati_identifier_ops <- iati_identifier_ops
    thisyear <-  year
    df <- df |> 
      dplyr::filter(iati_identifier_ops == thisiati_identifier_ops &
            year == thisyear )
  } else if (!is.null(ctr_name)) {
    thisctr_name <- ctr_name
    thisyear <-  year
    df0 <- df |> 
      dplyr::filter( ctr_name == thisctr_name &
            year == thisyear )
  }
  
  df2 <- df    |>
    dplyr::select(participating_org_eng, 
                  participating_org_type_name, 
                  participating_org_role_name) |>
     tidyr::pivot_wider(names_from = participating_org_role_name, 
              values_from = participating_org_eng ,
              values_fn = list) |>
    dplyr::select( - Accountable)  |>
    dplyr::rename(Organisation =participating_org_type_name) 
  ## replace null values...
  df2[df2 == 'NULL'] <- as.list(" ")
  
  
  df3 <- df    |>
    dplyr::select(participating_org_eng, 
                  participating_org_type_name, 
                  participating_org_role_name) |>
    #  count(across(everything())) |>
     tidyr::pivot_wider(names_from = participating_org_role_name, 
               values_from = participating_org_eng,
                values_fn = function(x) length(!is.na(x)),
                values_fill = 0)
  
  ##df |> dplyr::select(participating_org_type, participating_org_role ) |> dplyr::distinct()
   
  ## Let's build a table with a participating type as row - role as column -
  # and in the cell the numeber and list of corresponding org.. participating_org_eng
  ## Facet this by year... 
  
  # Dummy data
    # participating_org_type_name <- LETTERS[1:8]
    # participating_org_type_role <- paste0("var", seq(1,4))
    # df <- expand.grid(participating_org_type_name = participating_org_type_name,
    #                   participating_org_type_role = participating_org_type_role)
    # df$count <- runif(32, 0, 5)
  
  
#  p <- df3 |> 
# #  dplyr::filter(transaction_value_USD  <= 1000000 & transaction_value_USD  > 1000) |> 
#   ggplot2::ggplot(ggplot2::aes(x =  participating_org_type_name, 
#                                y = participating_org_type_role , 
#                                fill = count,
#                                label = count)) +
#     
#   ggplot2::geom_tile(alpha = 0.9) +  
#   ggplot2::geom_text( size=2.5)  + 
#   #ggplot2::scale_fill_viridis_c(option = "inferno", na.value = "grey50" ) +
#   ggplot2::scale_fill_gradient2(low = "white" ,
#                        mid = "#FFFFCC",
#                        high = "#075AFF") 
#   unhcrthemes::theme_unhcr(grid =  FALSE, axis = FALSE, axis_title =  TRUE, legend = FALSE)+
#   ggplot2::labs(
#     title = paste0(" Partners"),
#     subtitle = paste0("In ", programme_lab, " recorded since ", year,""),
#     x = "Organisation Type",
#     y = "Organisation Role",
#     caption = "Source: Data published by UNHCR as part of the International Aid Transparency Initiative (IATI)" ) 
 
  p <- knitr::kable( df2  )
  
  return(p)
}
```
 
```{r examples-show_partnership, message=FALSE, warning=FALSE, fig.retina = 2, fig.width = 8, fig.asp = 0.618, fig.align = "center",  out.width = "90%"}
show_partnership(year = 2025,
           ctr_name = "Brazil" ) 
```

```{r tests-show_partnership}
test_that("show_partnership works", {
  expect_true(inherits(show_partnership, "function")) 
})
```

## show_funding_partners_treemap

*   **Research Question:** Who are the top funding partners for a specific country/programme, and how much did they contribute over time?

A treemap is used to visualize the composition of the funding, showing the proportional contribution of each donor.

```{r function-show_funding_partners_treemap}
#' Show a treemap of top funding partners
#'
#' @description This function creates a treemap to visualize the top N funding partners
#' based on their total incoming commitments for a given year and location.
#'
#' @param year A numeric value for the year.
#' @param ctr_name A character vector for the country name.
#' @param programme_lab A character vector for the programme name.
#' @param iati_identifier_ops A character vector for the operation ID.
#' @param top_n The number of top donors to display. Others will be aggregated into an "Other" category.
#'
#' @import ggplot2
#' @import dplyr
#' @import scales
#' @import unhcrthemes
#'
#' @export
show_funding_partners_treemap <- function(year,
                                          ctr_name = NULL,
                                          programme_lab = NULL,
                                          iati_identifier_ops = NULL,
                                          top_n = 10) {

  if (!requireNamespace("treemapify", quietly = TRUE)) {
    message("Package `treemapify` is not installed. Please run `install.packages('treemapify')` to use this function.")
    return(invisible(NULL))
  }

  df <- iati::dataTransaction |>
    dplyr::left_join(iati::dataActivity, by = "iati_identifier")|> 
    dplyr::mutate(year = as.numeric(year))

  # Filtering
  if (!is.null(programme_lab)) {
    df <- df |> dplyr::filter(programmme_lab == {{programme_lab}} & year == {{year}} & transaction_type_name == "Incoming Commitment")
  } else if (!is.null(iati_identifier_ops)) {
    df <- df |> dplyr::filter(iati_identifier_ops == {{iati_identifier_ops}} & year == {{year}} & transaction_type_name == "Incoming Commitment")
  } else if (!is.null(ctr_name)) {
    df <- df  |>
      dplyr::filter(ctr_name == {{ctr_name}} & 
                              year == {{year}} & 
                              transaction_type_name == "Incoming Commitment")
  }

  df_summary <- df |>
    dplyr::group_by(provider_org_type_name, transaction_provider_org) |>
    dplyr::summarise(total_commitment = sum(transaction_value_USD, na.rm = TRUE)) |>
    dplyr::ungroup() |>
    dplyr::mutate(transaction_provider_org = forcats::fct_lump_n(
      transaction_provider_org,
      n = top_n,
      w = total_commitment,
      other_level = "Other Donors"
    )) |>
    dplyr::group_by(provider_org_type_name, transaction_provider_org) |>
    dplyr::summarise(total_commitment = sum(total_commitment, na.rm = TRUE)) |>
    dplyr::filter(total_commitment > 0)


  p <- ggplot2::ggplot(df_summary, ggplot2::aes(area = total_commitment, fill = provider_org_type_name,
                                     label = paste(transaction_provider_org,
                                                   scales::label_number(scale_cut = scales::cut_short_scale())(total_commitment),
                                                   sep = "\n"))) +
    treemapify::geom_treemap() +
    treemapify::geom_treemap_text(fontface = "italic", colour = "white", place = "centre",
                      grow = TRUE) +
    ggplot2::labs(
      title = "Top Funding Partners by Commitment",
      subtitle = paste0("For ", ctr_name %||% programme_lab %||% iati_identifier_ops, " in ", year),
      caption = "Source: Data published by UNHCR as part of the International Aid Transparency Initiative (IATI)"
    ) +
    unhcrthemes::theme_unhcr(grid = FALSE, axis = FALSE, axis_text = FALSE) +
    ggplot2::scale_fill_viridis_d(option = "magma", name = "Donor Type")

  return(p)
}

`%||%` <- function(a, b) {
  if (!is.null(a)) a else b
}
```

```{r example-show_funding_partners_treemap, fig.width = 10, fig.height = 7}
show_funding_partners_treemap(year = 2025, ctr_name = "Brazil", top_n = 10)
```

```{r tests-show_funding_partners_treemap}
test_that("show_funding_partners_treemap works", {
  expect_true(inherits(show_funding_partners_treemap, "function")) 
})
```


## show_donor_earmarking_profile

*   **Research Question:** What is the earmarking profile of top donors?

A stacked bar chart is used to show the breakdown of contributions by earmarking type for the top donors.

```{r function-show_donor_earmarking_profile}
#' Show donor earmarking profiles
#'
#' @description This function creates a stacked bar chart to show the earmarking
#' profile of the top N donors.
#'
#' @param year A numeric value for the year.
#' @param ctr_name A character vector for the country name.
#' @param programme_lab A character vector for the programme name.
#' @param iati_identifier_ops A character vector for the operation ID.
#' @param top_n The number of top donors to display.
#'
#' @import ggplot2
#' @import dplyr
#' @import scales
#' @import unhcrthemes
#' @import forcats
#'
#' @export
show_donor_earmarking_profile <- function(year,
                                          ctr_name = NULL,
                                          programme_lab = NULL,
                                          iati_identifier_ops = NULL,
                                          top_n = 10) {

  df <- iati::dataTransaction |>
    dplyr::left_join(iati::dataActivity, by = "iati_identifier")

  # Filtering
  if (!is.null(programme_lab)) {
    df <- df |> dplyr::filter(programmme_lab == {{programme_lab}} & year == {{year}} & transaction_type_name == "Incoming Commitment")
  } else if (!is.null(iati_identifier_ops)) {
    df <- df |> dplyr::filter(iati_identifier_ops == {{iati_identifier_ops}} & year == {{year}} & transaction_type_name == "Incoming Commitment")
  } else if (!is.null(ctr_name)) {
    df <- df |> dplyr::filter(ctr_name == {{ctr_name}} & year == {{year}} & transaction_type_name == "Incoming Commitment")
  }

  # Summarize total contributions per donor
  donor_totals <- df |>
    dplyr::group_by(transaction_provider_org) |>
    dplyr::summarise(total = sum(transaction_value_USD, na.rm = TRUE)) |>
    dplyr::slice_max(order_by = total, n = top_n)

  df_summary <- df |>
    dplyr::filter(transaction_provider_org %in% donor_totals$transaction_provider_org) |>
    dplyr::group_by(transaction_provider_org, earmarking_name) |>
    dplyr::summarise(total_commitment = sum(transaction_value_USD, na.rm = TRUE)) |>
    dplyr::ungroup()

  p <- ggplot2::ggplot(df_summary,
                       ggplot2::aes(x = stats::reorder(transaction_provider_org, total_commitment, FUN = sum),
                                    y = total_commitment,
                                    fill = earmarking_name)) +
    ggplot2::geom_bar(stat = "identity", position = "stack") +
    ggplot2::coord_flip() +
    unhcrthemes::theme_unhcr(grid = "X", axis = "y", axis_title = "X") +
    ggplot2::scale_y_continuous(labels = scales::label_number(scale_cut = scales::cut_short_scale())) +
    ggplot2::scale_fill_viridis_d(option = "cividis", name = "Earmarking Type") +
    ggplot2::labs(
      title = "Donor Earmarking Profile",
      subtitle = paste0("Top ", top_n, " donors for ", ctr_name %||% programme_lab %||% iati_identifier_ops, " in ", year),
      caption = "Source: Data published by UNHCR as part of the International Aid Transparency Initiative (IATI)",
      x = "Donor",
      y = "Total Commitment (USD)"
    )

  return(p)
}
```

```{r example-show_donor_earmarking_profile, fig.width = 10, fig.height = 8}
show_donor_earmarking_profile(year = 2025, ctr_name = "Brazil", top_n = 10)
```

  
```{r tests-show_donor_earmarking_profile}
test_that("show_donor_earmarking_profile works", {
  expect_true(inherits(show_donor_earmarking_profile, "function")) 
})
```


## show_implementing_partners_flow

*   **Research Question:** Who are the main implementing partners and what are their roles?

A Sankey diagram is used to show the flow of partnerships from role to organization type to specific organization names.

```{r function-show_implementing_partners_flow}
#' Show a flow diagram of implementing partners
#'
#' @description This function creates a Sankey diagram to visualize the relationships
#' between implementing partner roles, their organization types, and their names.
#'
#' @param year A numeric value for the year.
#' @param ctr_name A character vector for the country name.
#' @param programme_lab A character vector for the programme name.
#' @param iati_identifier_ops A character vector for the operation ID.
#' @param top_n The number of top implementing partners to show.
#'
#' @import ggplot2
#' @import dplyr
#' @import ggsankey
#' @import unhcrthemes
#'
#' @export
show_implementing_partners_flow <- function(year,
                                            ctr_name = NULL,
                                            programme_lab = NULL,
                                            iati_identifier_ops = NULL,
                                            top_n = 15) {

  df <- iati::dataParticipating_org |>
    dplyr::left_join(iati::dataActivity, by = "iati_identifier")

  # Filtering
  if (!is.null(programme_lab)) {
    df <- df |> dplyr::filter(programmme_lab == {{programme_lab}} & year == {{year}})
  } else if (!is.null(iati_identifier_ops)) {
    df <- df |> dplyr::filter(iati_identifier_ops == {{iati_identifier_ops}} & year == {{year}})
  } else if (!is.null(ctr_name)) {
    df <- df |> dplyr::filter(ctr_name == {{ctr_name}} & year == {{year}})
  }

  df_flow <- df |>
    dplyr::filter(participating_org_role_name %in% c("Implementing", "Extending")) |>
    dplyr::count(participating_org_role_name, participating_org_type_name, participating_org_eng, name = "count") |>
    dplyr::mutate(participating_org_eng = forcats::fct_lump_n(
      participating_org_eng, n = top_n, w = count, other_level = "Other Partners"
    )) |>
    dplyr::group_by(participating_org_role_name, participating_org_type_name, participating_org_eng) |>
    dplyr::summarise(value = sum(count)) |>
    dplyr::ungroup() |>
    ggsankey::make_long(participating_org_role_name, participating_org_type_name, participating_org_eng, value = value)

  ggplot2::ggplot(df_flow, ggplot2::aes(x = x, next_x = next_x, node = node, next_node = next_node,
                     fill = factor(node), value = value, label = node)) +
    ggsankey::geom_sankey(flow.alpha = 0.6) +
    ggsankey::geom_sankey_label(size = 3, color = "black", fill = "white", hjust = -0.1) +
    unhcrthemes::theme_unhcr(grid = FALSE, axis = FALSE, axis_text = FALSE, legend = FALSE) +
    ggplot2::scale_fill_viridis_d(option = "viridis") +
    ggplot2::labs(title = "Flow of Implementing Partnerships",
         subtitle = paste0("For ", ctr_name %||% programme_lab %||% iati_identifier_ops, " in ", year),
         caption = "Source: Data published by UNHCR as part of the International Aid Transparency Initiative (IATI)")
}
```

```{r example-show_implementing_partners_flow, fig.width = 10, fig.height = 7}
show_implementing_partners_flow(year = 2025, ctr_name = "Brazil")
```

```{r tests-show_implementing_partners_flow}
test_that("show_implementing_partners_flow works", {
  expect_true(inherits(show_implementing_partners_flow, "function")) 
})
```

 


# Template

## template_prez
    
```{r function-template_prez}

# usethis::use_rmarkdown_template(
#   template_name = "iati_prez",
#   template_dir = NULL,
#   template_description = "UNHCR IATI",
#   template_create_dir = TRUE
# )


#' Generate a summary powerpoint
#' 
#' @param year A numeric value or a vector of numeric value to filter on year. Note that data pre-2022 are using a different set of indicators
#' @param ctr_name A character vector corresponding to the name of the country.
#' @param folder folder within your project where to put the generated report. 
#'              Folder will be created if it does not exist
#' 
#' @importFrom unhcrdown pptx_slides
#' @importFrom dplyr filter select pull
#' @importFrom rmarkdown render
#' @importFrom here here
#' @importFrom countrycode countrycode
#' @importFrom stringr str_replace_all
#' 
#' @return nothing the file for the report is generated
#' 
#' @export 
#'
template_prez <- function(year = 2025,
                          ctr_name,   
                          folder = "Prez") {
  
  ## Create the outfolder if it does not exist
  output_dir <- paste0(getwd(),"/",folder)
  if (!dir.exists(output_dir)) {dir.create(output_dir)}
  
  rmarkdown::render(
    system.file("rmarkdown/templates/iati_prez/skeleton/skeleton.Rmd", package = "iati"),
    output_file = here::here(folder, paste0('Strategic_Moment_of_Reflection-',
                                            stringr::str_replace_all( 
                           countrycode::countrycode(ctr_name,
                                               origin = "country.name",
                                               destination = "unhcr.region"), " ", "_"),
                                            "__",
                                            stringr::str_replace_all( ctr_name, " ", "_"),
                        '-', year, '.pptx') ),
    params = list(ctr_name = ctr_name, 
                  year = year)  )
}
```
  
```{r example-template_prez}

## generate for one country
# iati::template_prez(year = 2025, 
#                     ctr_name = "Brazil",
#                     folder = "dev/Prez")

# ## Generate for all operation specific region
# reg <- iati::dataActivity |>
#   dplyr::select( unhcr_region) |>
#   dplyr::filter(! is.na(unhcr_region)) |>
#   dplyr::distinct() |>
#   dplyr::pull() 
# 
# thisfolder <- "dev/SMR" 
# 
# for (region in reg) { 
#       cat(paste0( region,   "\n"))
#
#       # region <- "The Americas"   
#       countries <- iati::dataActivity |>
#         dplyr::filter( unhcr_region ==  region) |>
#         dplyr::select(ctr_name) |>
#         dplyr::distinct() |>
#         dplyr::pull() 
#       
#       for ( ctr in countries) {
#         cat(paste0("Generating for ", ctr, "\n"))
#         iati::template_prez(year = 2025,
#                             ctr_name = ctr,
#                             folder =  thisfolder)  
#         }
#     }
```
  
```{r tests-template_prez}
test_that("template_prez works", {
  expect_true(inherits(template_prez, "function")) 
})
```

## template_compare
    
```{r function-template_compare}

# usethis::use_rmarkdown_template(
#   template_name = "iati_compare",
#   template_dir = NULL,
#   template_description = "Compare",
#   template_create_dir = TRUE
# )


#' Generate a summary powerpoint
#' 
#' @param year A numeric value or a vector of numeric value to filter on year. Note that data pre-2022 are using a different set of indicators
#' @param ctr_name A character vector corresponding to the name of the country.
#' @param folder folder within your project where to put the generated report. 
#'              Folder will be created if it does not exist
#' 
#' @importFrom unhcrdown pptx_slides
#' @importFrom dplyr filter select pull
#' @importFrom rmarkdown render
#' @importFrom here here
#' @importFrom countrycode countrycode
#' @importFrom stringr str_replace_all
#' 
#' @return nothing the file for the report is generated
#' 
#' @export 
#'
template_compare <- function(year = 2025,
                          folder = "Compare") {
  
  ## Create the outfolder if it does not exist
  output_dir <- paste0(getwd(),"/",folder)
  if (!dir.exists(output_dir)) {dir.create(output_dir)}
  
  rmarkdown::render(
    system.file("rmarkdown/templates/iati_compare/skeleton/skeleton.Rmd", package = "iati"),
    output_file = here::here(folder, paste0('Result_Resource',
                                            '-', year, '.pptx') ),
    params = list(year = year)  )
}
```
  
```{r example-template_compare} 
# iati::template_compare(year = 2025, folder = "dev/Result")
```
  
```{r tests-template_compare}
test_that("template_compare works", {
  expect_true(inherits(template_compare, "function")) 
})
```
    


```{r development-inflate, eval=FALSE}
# Inflate the package

# You're one inflate from paper to box.
# Build your package from this very Rmd using `fusen::inflate()`
# 
# - Verify your `"DESCRIPTION"` file has been updated
# - Verify your function is in `"R/"` directory
# - Verify your test is in `"tests/testthat/"` directory
# - Verify this Rmd appears in `"vignettes/"` directory

# Keep eval=FALSE to avoid infinite loop in case you hit the knit button
# Execute in the console directly
fusen::inflate(flat_file = "dev/dev_unhcr_programme.Rmd", vignette_name = "-- Operation Analysis")
```



