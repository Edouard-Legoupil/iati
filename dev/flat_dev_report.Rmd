---
title: "Report Generation"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r development, message=FALSE, warning=FALSE, include=FALSE}
library(testthat)
```

```{r development-load, message=FALSE, warning=FALSE, include=FALSE}
# Load already included functions if relevant
pkgload::load_all(export_all = FALSE)
```



```{r function-generate_report}
#' Generate Quarto HTML / PDF Country Factsheets in Batch
#'
#' This function renders the 'Country_Factsheet' Quarto template for a list of
#' countries, generating a report file for each.
#'
#' @param type either donor recipient or destination.
#' @param name name of  donor recipient or destination if NULL batch process them
#' @param top_n Top number of report to batch process based on total amount
#'
#' @importFrom dplyr filter select pull
#' @importFrom quarto quarto_render
#' @importFrom here here
#'
#' @return links to genrated reports.
#'
#' @export
generate_report <- function(type="donor",
                            name=NULL) {
  
  template_path = system.file(paste0("_extension/", type,"/template.qmd"), 
                                package = "iati")
  ## Create the outfolder if it does not exist
  folder <- "docs/reports"
  output_dir <- here::here(folder)
  if (!dir.exists(output_dir)) {
    dir.create(output_dir, recursive = TRUE)
    message("Created output directory: ", output_dir)
  }
  
  # Ensure template exists
  if (!file.exists(template_path)) {
    stop("Quarto template not found at: ", template_path, 
         ". Please check the template_path argument.")
  }
  
  flows <- filter_flows_for_indicators(flows)
  # --- Loop through each country for batch rendering ---
  if ( is.null(name)){
    if(type == "donor") {
      name <-   data |>
                sort()|>
                unique()
    }
  
    if(type == "recipient") {
      name <-   data |>
                sort()|>
                unique()
    }
    
    
    if(type == "operation") {
      name <-  data |>
                sort()|>
                unique()
    }
  } 
  links <- c()
  for ( this in name) {
    # this <- name
    # 2. Define Output Filename and Path
    thisslug <- slugify(this)
    output_filename <- paste0('iatiAnalysis-', type, '-', thisslug , '.html')
    output_filepath <- here::here(folder,output_filename )

    # 3. Render the Quarto document
    tryCatch({
      quarto::quarto_render(
        input = template_path,
        output_file = output_filename,
        # Pass parameters to the YAML header and R code chunks
        execute_params = list(name = this )
      )
      # Move the file
     file.rename(from = here::here( system.file(paste0("_extension/", type), 
                                package = "iatiAnalysis"),
                                output_filename ), 
                 to = output_filepath)
      message("Successfully generated: ", output_filename)
    # Link
      link <- paste0( "[Profile Report for ",
                      type,": ", 
                      this, "](../reports/",
                      output_filename,")")
    }, error = function(e) {
      warning("Failed to render report for ", this, ": ", e$message)
    })
    # links
    links <- c(links, link)
  }
  
  return(links)
}
```
  
```{r example-generate_report, message=FALSE, warning=FALSE, include=FALSE}

# linkdonor <- generate_report(type = "donor")
# dput(linkdonor)
linkdonor <-   c()
# linkrecipient <- generate_report(type = "recipient")
# dput(linkrecipient )
linkrecipient <- c()
# linkoperation <- generate_report(type = "operation")
# dput(linkoperation)
linkoperation <- c()



```

##  Donors 

Analyze funding behavior, consistency, and strategic alignment:

`r paste0("- ", linkdonor, collapse = "\n")`

##  Recipients
Evaluate funding stability, diversification, and dependency:

`r paste0("- ", linkrecipient, collapse = "\n")`

##  Destinations 

Assess funding coverage, gaps, and risks for specific crises or locations:

`r paste0("- ", linkoperation, collapse = "\n")`

  
```{r tests-generate_report}
test_that("generate_report works", {
  expect_true(inherits(generate_report, "function")) 
})
```
  


```{r development-inflate, eval=FALSE}
# Run but keep eval=FALSE to avoid infinite loop
# Execute in the console directly
fusen::inflate(flat_file = "dev/flat_dev_report.Rmd", vignette_name = "AI Powered Reports", check = FALSE)
```

