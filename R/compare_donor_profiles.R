# WARNING - Generated by {fusen} from dev/dev_donor_focus.Rmd: do not edit by hand # nolint: line_length_linter.

#' Compare donor profiles
#'
#' @description
#' Creates an overlaid bar chart to compare funding profiles of donors based on
#' a selected dimension (earmarking, region, or country). When only one donor 
#' is provided, a comparator is automatically added based on other donors.
#'
#' @param donor_names Character vector of donor names to compare (length 1 or more).
#' @param by One of "earmarking", "region", or "country". The dimension to compare.
#' @param avg_method If only one donor is supplied, how to compute the "others" comparator:
#'   - "mean_of_donors": Each donor counts equally, regardless of their total funding
#'   - "pooled": Donors are weighted by their share of total funding (larger donors have more influence)
#' @param display_mode Comparison mode:
#'   - "absolute": Compare absolute USD amounts (sum vs sum)
#'   - "relative": Compare percentage shares of total funding (profile vs average profile)
#' @param year Optional numeric/integer vector. Year(s) to filter on.
#' @param unhcr_region Optional character vector. Filter for UNHCR region(s).
#' @param programme_lab Optional character vector. Filter for programme name.
#' @param iati_identifier_ops Optional character vector. Filter for operation ID.
#' @param ctr_name Optional character vector. Filter for country name.
#' @param top_n Integer. The number of top categories to show when `by = "country"`.
#'
#' @return A ggplot object showing overlaid bars for comparison.
#'
#' @details
#' When `display_mode = "relative"` and a comparator is added:
#' - Selected donor: Percentage share of its own total funding
#' - Comparator: Average percentage share across other donors (using `avg_method`)
#' 
#' When `display_mode = "absolute"` and a comparator is added:
#' - Selected donor: Absolute USD amounts
#' - Comparator: Either:
#'   - With `avg_method = "mean_of_donors"`: Average donor size × average share
#'   - With `avg_method = "pooled"`: Summed totals across all other donors
#'
#' The chart uses visual cues to distinguish series:
#' - Wider transparent bars: Comparator
#' - Narrower solid bars: Selected donor(s)
#' - Colors represent categories within the dimension
#'
#' @import ggplot2
#' @import dplyr
#' @import scales
#' @import unhcrthemes
#'
#' @export
#' @examples
#' # Compare Donor Profiles
#'
#' ## using mean
#' compare_donor_profiles(
#'   donor_names = "Private donors",
#'   by = "earmarking",
#'   year = 2025,
#'   avg_method = "mean_of_donors",
#'   display_mode = "absolute"
#' )
#' compare_donor_profiles(
#'   donor_names = "Private donors",
#'   by = "earmarking",
#'   year = 2025,
#'   avg_method = "mean_of_donors",
#'   display_mode = "relative"
#' )
#'
#' ## using pooled
#' compare_donor_profiles(
#'   donor_names = "Private donors",
#'   by = "earmarking",
#'   year = 2025,
#'   avg_method = "pooled",
#'   display_mode = "absolute"
#' )
#'
#'
#' compare_donor_profiles(
#'   donor_names = "Private donors",
#'   by = "earmarking",
#'   year = 2025,
#'   avg_method = "pooled",
#'   display_mode = "relative"
#' )
#'
#'
#' compare_donor_profiles(
#'   donor_names = "Private donors",
#'   by = "region",
#'   year = 2025,
#'   avg_method = "pooled",
#'   display_mode = "relative"
#' )
#'
#' compare_donor_profiles(
#'   donor_names = c("Private donors", 
#'  "Switzerland - Swiss Agency for Development and Cooperation (SDC)"), 
#'    by = "earmarking", 
#'  year = 2025, 
#'  ctr_name = "Brazil")
compare_donor_profiles <- function(donor_names,
                                   by = c("earmarking", "region", "country"),
                                   avg_method = c("mean_of_donors", "pooled"),
                                   display_mode = c("absolute", "relative"),
                                   year = NULL,
                                   unhcr_region = NULL,
                                   programme_lab = NULL,
                                   iati_identifier_ops = NULL,
                                   ctr_name = NULL,
                                   top_n = NULL) {

  by <- match.arg(by)
  avg_method <- match.arg(avg_method)
  display_mode <- match.arg(display_mode)

  # Avoid collisions with column names
  year_filter      <- year
  region_filter    <- unhcr_region
  programme_filter <- programme_lab
  ops_filter       <- iati_identifier_ops
  country_filter   <- ctr_name

  donor_names <- unique(donor_names)
  add_comparator <- length(donor_names) == 1

  # ---- 1) Load base data (ALL donors), then apply filters ----
  df_base <- iati::dataTransaction |>
    dplyr::left_join(iati::dataActivity, by = "iati_identifier") |>
    dplyr::filter(.data$transaction_type_name == "Incoming Commitment")

  if (!is.null(year_filter)) {
    df_base <- df_base |> dplyr::filter(.data$year %in% .env$year_filter)
  }
  if (!is.null(region_filter)) {
    df_base <- df_base |> dplyr::filter(.data$unhcr_region %in% .env$region_filter)
  }
  if (!is.null(programme_filter)) {
    df_base <- df_base |> dplyr::filter(.data$programme_lab %in% .env$programme_filter)
  }
  if (!is.null(ops_filter)) {
    df_base <- df_base |> dplyr::filter(.data$iati_identifier_ops %in% .env$ops_filter)
  }
  if (!is.null(country_filter)) {
    df_base <- df_base |> dplyr::filter(.data$ctr_name %in% .env$country_filter)
  }

  # Clean unhcr_region: replace NA/empty with "Global/HQ"
  df_base <- df_base |>
    dplyr::mutate(
      unhcr_region = dplyr::case_when(
        is.na(.data$unhcr_region) ~ "Global/HQ",
        trimws(.data$unhcr_region) == "" ~ "Global/HQ",
        TRUE ~ .data$unhcr_region
      )
    )

  # ---- 2) Helper: build (donor, dimension, total_funding) ----
  build_profile <- function(df_in, by) {
    if (by == "earmarking") {
      df_in |>
        dplyr::filter(!is.na(.data$earmarking_name)) |>
        dplyr::group_by(.data$transaction_provider_org, .data$earmarking_name) |>
        dplyr::summarise(
          total_funding = sum(.data$transaction_value_USD, na.rm = TRUE),
          .groups = "drop"
        ) |>
        dplyr::rename(dimension = .data$earmarking_name)
    } else if (by == "region") {
      df_in |>
        dplyr::group_by(.data$transaction_provider_org, .data$unhcr_region) |>
        dplyr::summarise(
          total_funding = sum(.data$transaction_value_USD, na.rm = TRUE),
          .groups = "drop"
        ) |>
        dplyr::rename(dimension = .data$unhcr_region)
    } else { # by == "country"
      df_in |>
        dplyr::filter(!is.na(.data$ctr_name)) |>
        dplyr::group_by(.data$transaction_provider_org, .data$ctr_name) |>
        dplyr::summarise(
          total_funding = sum(.data$transaction_value_USD, na.rm = TRUE),
          .groups = "drop"
        ) |>
        dplyr::rename(dimension = .data$ctr_name)
    }
  }

  # ---- 3) Selected donors ----
  selected_df <- df_base |>
    dplyr::filter(.data$transaction_provider_org %in% .env$donor_names)

  show_selected <- build_profile(selected_df, by)

  if (nrow(show_selected) == 0) {
    stop("No data found for the selected donor(s) under the specified filters.")
  }

  # ---- 4) Auto comparator if only one donor provided ----
  comparator_label <- NULL

  if (add_comparator) {
    focal <- donor_names[[1]]

    others_df <- df_base |>
      dplyr::filter(.data$transaction_provider_org != .env$focal)

    show_others <- build_profile(others_df, by)

    if (nrow(show_others) == 0) {
      warning("No data found for 'other donors' under the specified filters. Showing only selected donor.")
      show_data <- show_selected
      add_comparator <- FALSE
      
    } else {

      if (avg_method == "mean_of_donors") {
        comparator_label <- "Average of other donors (equal weight)"
        
        # For relative display: average of donor-level percentage shares
        if (display_mode == "relative") {
          # Calculate percentage shares for each other donor
          others_totals <- show_others |>
            dplyr::group_by(.data$transaction_provider_org) |>
            dplyr::summarise(donor_total = sum(.data$total_funding, na.rm = TRUE), .groups = "drop")
          
          others_shares <- show_others |>
            dplyr::left_join(others_totals, by = "transaction_provider_org") |>
            dplyr::mutate(
              share = dplyr::if_else(.data$donor_total > 0, 
                                    .data$total_funding / .data$donor_total, 
                                    NA_real_)
            ) |>
            dplyr::group_by(.data$dimension) |>
            dplyr::summarise(avg_share = mean(.data$share, na.rm = TRUE), .groups = "drop")
          
          show_cmp <- others_shares |>
            dplyr::mutate(
              transaction_provider_org = comparator_label,
              total_funding = NA_real_,  # Not used for relative display
              share = .data$avg_share
            ) |>
            dplyr::select(.data$transaction_provider_org, .data$dimension, .data$total_funding, .data$share)
          
        } else { # display_mode == "absolute"
          # For absolute display: average share × average donor size
          others_totals <- show_others |>
            dplyr::group_by(.data$transaction_provider_org) |>
            dplyr::summarise(donor_total = sum(.data$total_funding, na.rm = TRUE), .groups = "drop")
          
          mean_total_others <- others_totals |>
            dplyr::summarise(mean_total = mean(.data$donor_total, na.rm = TRUE), .groups = "drop") |>
            dplyr::pull(.data$mean_total)
          
          others_shares <- show_others |>
            dplyr::left_join(others_totals, by = "transaction_provider_org") |>
            dplyr::mutate(
              share = dplyr::if_else(.data$donor_total > 0, 
                                    .data$total_funding / .data$donor_total, 
                                    NA_real_)
            ) |>
            dplyr::group_by(.data$dimension) |>
            dplyr::summarise(avg_share = mean(.data$share, na.rm = TRUE), .groups = "drop")
          
          show_cmp <- others_shares |>
            dplyr::mutate(
              transaction_provider_org = comparator_label,
              total_funding = .data$avg_share * mean_total_others,
              share = .data$avg_share
            ) |>
            dplyr::select(.data$transaction_provider_org, .data$dimension, .data$total_funding, .data$share)
        }

      } else if (avg_method == "pooled") {
        comparator_label <- "Other donors (pooled)"
        
        # For both relative and absolute: use pooled totals
        pooled_totals <- show_others |>
          dplyr::group_by(.data$dimension) |>
          dplyr::summarise(
            total_funding = sum(.data$total_funding, na.rm = TRUE),
            .groups = "drop"
          )
        
        if (display_mode == "relative") {
          # Calculate percentage share of pooled total
          grand_total <- sum(pooled_totals$total_funding, na.rm = TRUE)
          show_cmp <- pooled_totals |>
            dplyr::mutate(
              transaction_provider_org = comparator_label,
              share = .data$total_funding / grand_total
            ) |>
            dplyr::select(.data$transaction_provider_org, .data$dimension, .data$total_funding, .data$share)
        } else { # display_mode == "absolute"
          show_cmp <- pooled_totals |>
            dplyr::mutate(
              transaction_provider_org = comparator_label,
              share = NA_real_
            ) |>
            dplyr::select(.data$transaction_provider_org, .data$dimension, .data$total_funding, .data$share)
        }
      }

      # Calculate shares for selected donor
      selected_total <- sum(show_selected$total_funding, na.rm = TRUE)
      show_selected <- show_selected |>
        dplyr::mutate(
          share = .data$total_funding / selected_total
        )
      
      show_data <- dplyr::bind_rows(show_selected, show_cmp)
    }

  } else {
    # Multiple donors - calculate shares if needed
    if (display_mode == "relative") {
      donor_totals <- show_selected |>
        dplyr::group_by(.data$transaction_provider_org) |>
        dplyr::summarise(donor_total = sum(.data$total_funding, na.rm = TRUE), .groups = "drop")
      
      show_data <- show_selected |>
        dplyr::left_join(donor_totals, by = "transaction_provider_org") |>
        dplyr::mutate(
          share = .data$total_funding / .data$donor_total
        ) |>
        dplyr::select(-.data$donor_total)
    } else {
      show_data <- show_selected |>
        dplyr::mutate(share = NA_real_)
    }
  }

  # ---- 5) Apply top_n filter for country dimension ----
  if (by == "country" && !is.null(top_n) && is.numeric(top_n)) {
    # Keep top_n countries based on total funding across all shown donors
    top_countries <- show_data |>
      dplyr::group_by(.data$dimension) |>
      dplyr::summarise(total = sum(.data$total_funding, na.rm = TRUE), .groups = "drop") |>
      dplyr::arrange(dplyr::desc(.data$total)) |>
      dplyr::slice(1:top_n) |>
      dplyr::pull(.data$dimension)
    
    show_data <- show_data |>
      dplyr::filter(.data$dimension %in% top_countries)
  }

  # ---- 6) Prepare data for overlaid bar chart ----
  # Create factor levels for dimension ordered by total funding
  dimension_levels <- show_data |>
    dplyr::group_by(.data$dimension) |>
    dplyr::summarise(total = sum(.data$total_funding, na.rm = TRUE), .groups = "drop") |>
    dplyr::arrange(dplyr::desc(.data$total)) |>
    dplyr::pull(.data$dimension)
  
  # Add type column for plotting
  
  if (is.null(comparator_label)) comparator_label <- NA_character_
  show_data <- show_data |>
    dplyr::mutate(
      dimension = factor(.data$dimension, levels = dimension_levels),
      type = dplyr::case_when(
        .data$transaction_provider_org %in% donor_names & add_comparator ~ "Selected Donor",
        .data$transaction_provider_org %in% donor_names & !add_comparator ~ "Selected Donors",
        .data$transaction_provider_org == comparator_label ~ "Comparator",
        TRUE ~ "Other"
      ),
      # Select value based on display mode
      value = if (display_mode == "absolute") .data$total_funding else .data$share
    )

  # ---- 7) Define colors and aesthetics ----
  # Use earmarking colors if by = "earmarking"
  if (by == "earmarking") {
    earmarking_colors <- c(
      "Tightly Earmarked" = "#C00000",
      "Earmarked" = "#FFC000",
      "Softly Earmarked" = "#0090BC",
      "Unearmarked" = "#36B3A1"
    )
    
    # Ensure colors match the dimension levels
    fill_colors <- earmarking_colors[dimension_levels[dimension_levels %in% names(earmarking_colors)]]
  } else {
    # For region and country, use a color palette
    fill_colors <- unhcrthemes::unhcr_pal(n = length(dimension_levels), "pal_unhcr")
    names(fill_colors) <- dimension_levels
  }

  # ---- 8) Create title ----
  # Build year string for title
  year_str <- if (!is.null(year_filter)) {
    if (length(year_filter) == 1) {
      paste("in", year_filter)
    } else {
      paste(range(year_filter), collapse = "-")
    }
  } else {
    "all years"
  }
  
  # Build title based on number of donors and display mode
  if (add_comparator) {
    if (display_mode == "relative") {
      title <- paste(donor_names[1], "vs average of other donors:", stringr::str_to_title(by), "profile", year_str)
    } else {
      title <- paste(donor_names[1], "vs", tolower(gsub("\\(.*\\)", "", comparator_label)), ":", stringr::str_to_title(by), "profile", year_str)
    }
  } else if (length(donor_names) == 1) {
    title <- paste(donor_names[1], ":", stringr::str_to_title(by), "profile", year_str)
  } else {
    title <- paste("Comparison of", paste(donor_names, collapse = " & "), ":", stringr::str_to_title(by), "profile", year_str)
  }
  
  # Capitalize first letter of each word
  title <- stringr::str_to_title(title)

  # ---- 9) Build interpretation hints for caption ----
  caption_parts <- c(
    "Source: Data published by UNHCR as part of the International Aid Transparency Initiative (IATI)"
  )
  
  # Add interpretation hints
  if (add_comparator) {
    caption_parts <- c(caption_parts, 
                       "Wider transparent bars: Comparator | Narrower solid bars: Selected donor")
    
    # Add method hint
    method_desc <- if (avg_method == "mean_of_donors") {
      "Comparator: average of donor-level shares (each donor counts equally)"
    } else {
      "Comparator: pooled totals (donors weighted by funding share)"
    }
    caption_parts <- c(caption_parts, method_desc)
  }
  
  if (by == "earmarking") {
    caption_parts <- c(caption_parts, 
                       "Colors: Tightly Earmarked (red), Earmarked (orange), Softly Earmarked (blue), Unearmarked (green)")
  }
  
  if (display_mode == "relative") {
    caption_parts <- c(caption_parts, "Values: percentage share of total funding")
  } else {
    caption_parts <- c(caption_parts, "Values: absolute USD amounts")
  }
  
  # Add filter information if any filters applied
  filter_parts <- c()
  if (!is.null(region_filter) && length(region_filter) <= 3) {
    filter_parts <- c(filter_parts, paste("Region:", paste(region_filter, collapse = ", ")))
  }
  if (!is.null(country_filter) && length(country_filter) <= 3) {
    filter_parts <- c(filter_parts, paste("Country:", paste(country_filter, collapse = ", ")))
  }
  if (!is.null(programme_filter) && length(programme_filter) <= 2) {
    filter_parts <- c(filter_parts, paste("Programme:", paste(programme_filter, collapse = ", ")))
  }
  
  if (length(filter_parts) > 0) {
    caption_parts <- c(caption_parts, paste("Filters:", paste(filter_parts, collapse = "; ")))
  }
  
  caption <- paste(caption_parts, collapse = " | ")

  # ---- 10) Plot: Fully overlaid bar chart ----
  # Separate data for plotting
  plot_data <- show_data
  
  # Set bar widths and transparency
  bar_widths <- c("Selected Donor" = 0.6, "Selected Donors" = 0.6, "Comparator" = 0.8)
  bar_alphas <- c("Selected Donor" = 0.9, "Selected Donors" = 0.9, "Comparator" = 0.4)
  
  # Get unique types in correct order (Comparator first for layering)
  types_in_data <- unique(plot_data$type)
  # Ensure Comparator is drawn first (behind) if present
  if ("Comparator" %in% types_in_data) {
    plot_order <- c("Comparator", setdiff(types_in_data, "Comparator"))
  } else {
    plot_order <- types_in_data
  }
  
  # Create base plot
  p <- ggplot2::ggplot()
  
  # Add bars in correct order (comparator first, then selected donor)
  for (bar_type in plot_order) {
    type_data <- plot_data |> dplyr::filter(.data$type == bar_type)
    
    if (nrow(type_data) > 0) {
      p <- p + ggplot2::geom_col(
        data = type_data,
        ggplot2::aes(x = .data$dimension, y = .data$value, fill = .data$dimension),
        width = bar_widths[bar_type],
        alpha = bar_alphas[bar_type],
        position = "identity",  # Fully overlaid
        show.legend = FALSE      # Suppress individual bar legends
      )
    }
  }
  
  # Build the complete plot with all elements before applying any theme
  p <- p +
    ggplot2::coord_flip() +
    ggplot2::scale_fill_manual(values = fill_colors) +
    ggplot2::labs(
      title = title,
      x = NULL,
      y = if (display_mode == "absolute") "Total Funding (USD)" else "Share of Total Funding (%)",
      caption = caption
    )
  
  # Add appropriate y-axis scale
  if (display_mode == "absolute") {
    p <- p + ggplot2::scale_y_continuous(
      labels = scales::label_number(scale_cut = scales::cut_short_scale()),
      expand = ggplot2::expansion(mult = c(0, 0.1))
    )
  } else {
    p <- p + ggplot2::scale_y_continuous(
      labels = scales::label_percent(accuracy = 1),
      expand = ggplot2::expansion(mult = c(0, 0.05))
    )
  }
  
  # Create a custom theme that combines UNHCR theme with our modifications
  # Apply everything in a single theme() call to avoid conflicts
  p <- p + ggplot2::theme(
    # Base UNHCR theme settings
    panel.grid.major.y = ggplot2::element_blank(),
    panel.grid.minor.y = ggplot2::element_blank(),
    panel.grid.major.x = ggplot2::element_line(color = "#D3D3D3", linewidth = 0.5),
    panel.grid.minor.x = ggplot2::element_blank(),
    panel.background = ggplot2::element_rect(fill = "white", color = NA),
    plot.background = ggplot2::element_rect(fill = "white", color = NA),
    axis.line.y = ggplot2::element_blank(),
    axis.line.x = ggplot2::element_line(color = "black", linewidth = 0.5),
    axis.ticks.y = ggplot2::element_blank(),
    axis.ticks.x = ggplot2::element_line(color = "black", linewidth = 0.5),
    axis.text = ggplot2::element_text(size = 14, color = "black"),
    axis.title.x = ggplot2::element_text(size = 16, color = "black", margin = ggplot2::margin(t = 10)),
    axis.title.y = ggplot2::element_blank(),
    plot.title = ggplot2::element_text(size = 20, face = "bold", color = "black", 
                                       margin = ggplot2::margin(b = 10)),
    plot.subtitle = ggplot2::element_text(size = 16, color = "black", margin = ggplot2::margin(b = 15)),
    
    # Our custom modifications
    legend.position = "none",
    plot.caption = ggplot2::element_text(
      size = 9, 
      hjust = 0, 
      color = "gray40", 
      lineheight = 1.1,
      margin = ggplot2::margin(t = 10)
    )
  )
  
  return(p)
}
