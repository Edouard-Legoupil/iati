---
title: "`r paste('Donor Profile:', params$name)`"
subtitle: "UNHCR Funding Analysis"
author: "AI Generated Analysis based on the open data shared publicly by UNHCR as part of the [International Aid Transparency Initiative (IATI)](https://www.unhcr.org/iati-international-aid-transparency-initiative). Beware of data limitations and potential hallucinations! Thanks for reporting any [issues here](https://github.com/Edouard-Legoupil/iati/issues/new) -- [View all Reports](../articles/ai-powered-reports.html)"
format:
  html:
    toc: true
    code-fold: true
    self-contained: true

params:
  name: "UK - Foreign, Commonwealth and Development Office"

  year: 2025
  start_year: 2023
  end_year: 2025

  top_n_countries: 20
  top_n_interest: 10
  other_stat: "mean" 
  earmarking_by: "region"
  volatility_time_unit: "month"
  volatility_forecast_h: 8
  volatility_show_ci: true

  # typography
  base_text_size: 28
  axis_text_size: 18
  legend_text_size: 18
  strip_text_size: 21
  plot_family: "Lato"           

  # AI narration
  use_ai: true
  ai_provider: "azure"           
  ai_model: "gpt-4.1-mini"
  max_tokens_short_desc: 40      
  max_tokens_long_desc: 300
  ai_max_tokens_exec: 400      
  ai_debug: false
---

```{r setup, include=FALSE}

# c("United States of America (Government of)", "Mastercard Foundation", 
# "Private donors", "European Commission - Humanitarian Aid & Civil Protection", 
# "Denmark - Ministry of Foreign Affairs, Danida", "European Commission - Service for Foreign Policy Instruments", 
# "European Commission - Neighbourhood and Enlargement Negotiations", 
# "Norad - Norwegian Agency for Development Cooperation", "Netherlands - Ministry of Foreign Affairs", 
# "Germany - Federal Foreign Office", "Ministry of Foreign Affairs of  Japan", 
# "UK - Foreign, Commonwealth and Development Office", "Sweden, through Swedish International Development Cooperation Agency (Sida)", 
# "Canada - Global Affairs Canada | Affaires mondiales Canada", 
# "Switzerland - Swiss Agency for Development and Cooperation (SDC)", 
# "España con ACNUR", "Republic of Korea", "Italy (Government of)", 
# "Japan for UNHCR", "Ireland - Department of Foreign Affairs", 
# "France - Ministry for Europe and Foreign Affairs", "Australia - Department of  Foreign Affairs and Trade", 
# "United Nations Regular Budget", "United Nations Central Emergency Response Fund (CERF)", 
# "UNO-Flüchtlingshilfe", "Finland - Ministry for Foreign Affairs", 
# "USA for UNHCR", "Germany - Ministry for Economic Cooperation and Development", 
# "Belgian Development Cooperation", "Austria (Government of)", 
# "Luxembourg (Government of)", "Sweden for UNHCR", "Spain (Government of)", 
# "Canada (Government of)", "AICS - Agenzia Italiana per la Cooperazione allo Sviluppo / Italian Agency for Cooperation and Development", 
# "Switzerland (Government of)", "African Development Bank", "United Arab Emirates (Government of)", 
# "Qatar (Government of)", "Australia for UNHCR", "UK for UNHCR", 
# "China (Government of)", "New Zealand - Ministry of Foreign Affairs and Trade - New Zealand Aid Programme", 
# "Saudi Arabia (Government of)", "Iceland (Government of)", "Kuwait (Government of)", 
# "Spain - Ministry of Foreign Affairs and Cooperation", "UN Joint Programmes (Government of)", 
# "Japan International Cooperation Agency (JICA)", "Spain (Autonomous authorities of)"
# )

# Set default Quarto options
knitr::opts_chunk$set(echo = FALSE, fig.cap = TRUE, warning = FALSE, message = FALSE)
# Load necessary libraries
suppressPackageStartupMessages({
  library(dplyr)
  library(ggplot2)
  library(scales)
  library(lubridate)
  library(stringr)
  library(unhcrthemes)
  library(iati)
  library(ellmer)
})

normalize_year <- function(y) if (is.null(y) || length(y) == 0) NULL else as.integer(y)
normalize_chr  <- function(x) if (is.null(x) || length(x) == 0) NULL else as.character(x)

# -------------------------
# AI narration (ellmer) 

ai_enabled <- isTRUE(params$use_ai)
ai_debug   <- isTRUE(params$ai_debug)

ai_log <- character()
ai_note <- function(x) { ai_log <<- c(ai_log, x) }

chat =  ellmer::chat_azure_openai(
  system_prompt = "You are a humanitarian funding analyst.Your task is to build a concise executive summary to describe the profile of a specific donor based on provided information",
  model = params$ai_model,
  api_version = Sys.getenv("AZURE_OPENAI_API_VERSION"),
  endpoint = Sys.getenv("AZURE_OPENAI_ENDPOINT"),
  api_key = Sys.getenv("AZURE_OPENAI_API_KEY"))
# -------------------------

p_year  <- normalize_year(params$year)
p_start <- if (is.null(params$start_year)) NULL else as.integer(params$start_year)
p_end   <- if (is.null(params$end_year)) NULL else as.integer(params$end_year)
p_ctr   <- normalize_chr(params$ctr_name)

# Determine a safe font family for ggplot rendering
plot_family_safe <- params$plot_family
if (!is.null(plot_family_safe) && plot_family_safe == "Lato") {
  ok <- FALSE
  if (requireNamespace("systemfonts", quietly = TRUE)) {
    mf <- tryCatch(systemfonts::match_font("Lato"), error = function(e) NULL)
    ok <- !is.null(mf) && !is.null(mf$path) && nzchar(mf$path)
  }
  if (!ok) plot_family_safe <- "sans"
}

placeholder_plot <- function(title = "No data", subtitle = "") {
  ggplot2::ggplot() +
    ggplot2::theme_void() +
    ggplot2::annotate("text", x = 0, y = 0.1, label = title, size = 5, fontface = "bold") +
    ggplot2::annotate("text", x = 0, y = -0.1, label = subtitle, size = 3.5) +
    ggplot2::xlim(-1,1) + ggplot2::ylim(-1,1)
}

safe_plot <- function(expr) {
  res <- tryCatch(expr, error = function(e) placeholder_plot("Plot unavailable", conditionMessage(e)))
  if (is.null(res)) placeholder_plot("No data for this view", "Function returned NULL") else res
}

render_plot <- function(x) {
  if (inherits(x, "ggplot")) print(x)
  else if (inherits(x, c("grob", "gtable"))) { grid::grid.newpage(); grid::grid.draw(x) }
  else print(placeholder_plot("Unsupported plot object", class(x)[1]))
}

normalize_plot <- function(p) {
  if (!inherits(p, "ggplot")) return(p)
  p + ggplot2::theme(
    text = ggplot2::element_text(size = params$base_text_size, family = plot_family_safe),
    axis.text = ggplot2::element_text(size = params$axis_text_size, family = plot_family_safe),
    axis.title = ggplot2::element_text(size = params$axis_text_size, family = plot_family_safe),
    legend.text = ggplot2::element_text(size = params$legend_text_size, family = plot_family_safe),
    legend.title = ggplot2::element_text(size = params$legend_text_size, family = plot_family_safe),
    strip.text = ggplot2::element_text(size = params$strip_text_size, family = plot_family_safe),
    plot.margin = ggplot2::margin(1, 1, 1, 1, unit = "pt"),
    legend.position = "bottom",
    legend.key.height = ggplot2::unit(6, "pt"),
    legend.key.width  = ggplot2::unit(10, "pt")
  )
}
```

```{r summary}
#| message: false
#| warning: false
#| include: false

# Plots
donor_ranking_raw <- 
  show_donor_ranking(
    donor_name = params$name,
    year = 2025,
    top_n_display = 50,
    ctr_name = p_ctr,
    verbose = FALSE
  )

donor_regional_focus_treemap_raw <- plot_donor_regional_focus_treemap(
    donor_name = params$name,
    year = 2025  )

donor_funding_over_time_raw <- 
  show_donor_funding_over_time(donor_name = params$name, 
                               year = c(2022, 2023, 20234, 2025),
                               by = "region")

donor_activity_diversification_raw <-  show_donor_activity_diversification(
    donor_name = params$name, 
    start_year = 2022, 
    end_year = 2025)

donor_earmarking_raw <-  show_donor_earmarking(
    donor_name = params$name, 
    year = c(  2025),
    by = "region",
    ctr_name = p_ctr)

# donor_transaction_desc_raw <- safe_plot(
#   show_donor_transaction_desc(donor_name = params$name, 
#                               by_primary = "transaction_description", 
#                               by_secondary = "unhcr_region",
#                               year = p_year, 
#                               ctr_name = p_ctr, 
#                               top_n = params$top_n_interest))

donor_funding_volatility_raw <-  show_donor_funding_volatility(
  donor_name = params$name,,
  year = 2022:2026,
  top_n_donors = 10,,
  forecast_horizon = 8,
  time_unit = "month")

compare_donor_profiles_raw <- compare_donor_profiles( 
  donor_names =  params$name,
                              by = "earmarking",
                              year = 2025,
                              avg_method = "pooled",
                              display_mode = "relative")

compare_donor_profiles2_raw <-  compare_donor_profiles(  
  donor_names =  params$name,
                              by = "region",
                              year = 2025,
                              avg_method = "pooled",
                              display_mode = "relative"
                            )


donor_geographic_priority_shift_raw <-     
      show_donor_geographic_priority_shift(  donor_name =  params$name, 
                                             top_n_countries = 7,
                                             start_year = 2023,
                                             end_year = 2025)

              



stories <- c(
  "Ranking" = generate_plot_story(donor_ranking_raw, 
                                  provider = params$ai_provider, model = params$ai_model,
                                  max_tokens_short_desc = params$max_tokens_short_desc,
                                  max_tokens_long_desc= params$max_tokens_long_desc ),
  
  "Focus" = generate_plot_story( donor_regional_focus_treemap_raw, 
                                  provider = params$ai_provider, model = params$ai_model,
                                  max_tokens_short_desc = params$max_tokens_short_desc,
                                  max_tokens_long_desc= params$max_tokens_long_desc ),
  
  "Funding" = generate_plot_story(donor_funding_over_time_raw, 
                                  provider = params$ai_provider, model = params$ai_model,
                                  max_tokens_short_desc = params$max_tokens_short_desc,
                                  max_tokens_long_desc= params$max_tokens_long_desc),
  
  "Diversification" = generate_plot_story(donor_activity_diversification_raw, 
                                  provider = params$ai_provider, model = params$ai_model,
                                  max_tokens_short_desc = params$max_tokens_short_desc,
                                  max_tokens_long_desc= params$max_tokens_long_desc),
  
  "Earmarking" = generate_plot_story(donor_earmarking_raw, 
                                  provider = params$ai_provider, model = params$ai_model, 
                                  max_tokens_short_desc = params$max_tokens_short_desc,
                                  max_tokens_long_desc= params$max_tokens_long_desc),
  
  # "Interest" = generate_plot_story(donor_transaction_desc_raw, 
  #                                 provider = params$ai_provider, model = params$ai_model, 
  #                                 max_tokens = params$ai_max_tokens_exec),
  
  
  "Volatility" = generate_plot_story(donor_funding_volatility_raw, 
                                  provider = params$ai_provider, model = params$ai_model, 
                                  max_tokens_short_desc = params$max_tokens_short_desc,
                                  max_tokens_long_desc= params$max_tokens_long_desc),
  
  
  "Profile" = generate_plot_story(compare_donor_profiles_raw, 
                                  provider = params$ai_provider, model = params$ai_model, 
                                  max_tokens_short_desc = params$max_tokens_short_desc,
                                  max_tokens_long_desc= params$max_tokens_long_desc),
  
  
  "ProfileReg" = generate_plot_story(compare_donor_profiles2_raw, 
                                  provider = params$ai_provider, model = params$ai_model, 
                                  max_tokens_short_desc = params$max_tokens_short_desc,
                                  max_tokens_long_desc= params$max_tokens_long_desc),
  
  "Shift" = generate_plot_story(donor_geographic_priority_shift_raw, 
                                  provider = params$ai_provider, model = params$ai_model, 
                                  max_tokens_short_desc = params$max_tokens_short_desc,
                                  max_tokens_long_desc= params$max_tokens_long_desc) 
)


chat =  ellmer::chat_azure_openai(
  system_prompt = "You are a humanitarian funding analyst.Your task is to build a concise executive summary to describe the profile of a specific recipient based on provided information, Your goal is to highlight the most relevant information to inform fundraising activities and project design. ",
  model = "gpt-4.1-mini",
  api_version = Sys.getenv("AZURE_OPENAI_API_VERSION"),
  endpoint = Sys.getenv("AZURE_OPENAI_ENDPOINT"),
  api_key = Sys.getenv("AZURE_OPENAI_API_KEY"))

exec <- chat$chat( paste0(" Build a short ",params$ai_max_tokens_exec , "  words Donor Profile for ",
                           params$name, ". \n. Ground your summary on the below information:",
                           stories["Ranking.long_desc"] , "\n\n",
                           stories["Focus.long_desc"] , "\n\n",
                           stories["Funding.long_desc"] , "\n\n",  
                           stories["Diversification.long_desc"] , "\n\n", 
                           stories["Earmarking.long_desc"] , "\n\n",
                           stories["Profile.long_desc"] , "\n\n",
                           stories["ProfileReg.long_desc"] , "\n\n",
                           stories["Shift.long_desc"] , "\n\n",    
                           stories["Volatility.long_desc"] , "\n\n", 
                          " \n\n INSTRUCTIONS: Do not repeat the provided content - focus on extracting key high level information for a fund raisers audience"
                           )) 
```

## Executive Summary

`r exec`

## Ranking

`r stories["Ranking.long_desc"]`
  
```{r Ranking}
#| fig.retina: 2.0
#| fig.width: 8.0
#| fig.asp: 0.618
#| fig.align: center
#| out.width: 90%
#| results: hide 
#| output: asis

donor_ranking_raw + ggplot2::labs(subtitle = stories["Ranking.short_desc"])
```


## Focus Portfolio

`r stories["Focus.long_desc"]`  
  
```{r Focus}
#| fig.retina: 2.0
#| fig.width: 10
#| fig.asp: 1
#| fig.align: center
#| out.width: 90%
#| results: hide 
#| output: asis
donor_regional_focus_treemap_raw +
                ggplot2::labs(subtitle = stories["Focus.short_desc"])
```

```{r map}
#| fig.retina: 2.0
#| fig.width: 10
#| fig.asp: 1
#| fig.align: center
#| out.width: 90%
#| results: hide 
#| output: asis
plot_donor_location_map(
  donor_name = params$name,
  year = 2025,
  top_n_locations = 5,
  max_symbol_size = 20
)
```


## Earmarking Behavior

`r stories["Earmarking.long_desc"]`  
  
```{r Earmarking}
#| fig.retina: 2.0
#| fig.width: 8.0
#| fig.asp: 0.618
#| fig.align: center
#| out.width: 90%
#| results: hide 
#| output: asis

donor_earmarking_raw + 
              ggplot2::labs(subtitle = stories["Earmarking.short_desc"])
```


`r stories["Profile.long_desc"]`  
  
```{r Profile}
#| fig.retina: 2.0
#| fig.width: 8.0
#| fig.asp: 0.618
#| fig.align: center
#| out.width: 90%
#| results: hide 
#| output: asis

compare_donor_profiles_raw +
                   ggplot2::labs(subtitle = stories["Profile.short_desc"])
```

## Geographic Focus

`r stories["Funding.long_desc"]`  
  
```{r Funding}
#| fig.retina: 2.0
#| fig.width: 10
#| fig.asp: 0.8
#| fig.align: center
#| out.width: 90%
#| results: hide 
#| output: asis

donor_funding_over_time_raw +
                ggplot2::labs(subtitle = stories["Funding.short_desc"])
```



`r stories["ProfileReg.long_desc"]`  
  
```{r Profile2}
#| fig.retina: 2.0
#| fig.width: 8.0
#| fig.asp: 0.618
#| fig.align: center
#| out.width: 90%
#| results: hide 
#| output: asis

compare_donor_profiles2_raw +
                   ggplot2::labs(subtitle = stories["ProfileReg.short_desc"])
```


## Activities Shift 

`r stories["Shift.long_desc"]`  
  
```{r Shift}
#| fig.retina: 2.0
#| fig.width: 8.0
#| fig.asp: 0.618
#| fig.align: center
#| out.width: 90%
#| results: hide 
#| output: asis

donor_geographic_priority_shift_raw + 
    ggplot2::labs(subtitle = stories["Shift.short_desc"])
```



`r stories["Diversification.long_desc"]`  
  
```{r Diversification}
#| fig.retina: 2.0
#| fig.width: 8.0
#| fig.asp: 0.618
#| fig.align: center
#| out.width: 90%
#| results: hide 
#| output: asis


  donor_activity_diversification_raw +
    ggplot2::labs(subtitle = stories["Diversification.short_desc"])
```



## Transaction Volatility

`r stories["Volatility.long_desc"]`  
  
```{r Volatility}
#| fig.retina: 2.0
#| fig.width: 8.0
#| fig.asp: 0.618
#| fig.align: center
#| out.width: 90%
#| results: hide 
#| output: asis

donor_funding_volatility_raw +
                ggplot2::labs(subtitle = stories["Volatility.short_desc"])
```


